define("text",["module"],function(a){"use strict";var b,c,d,e,f=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],g=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,h=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,i="undefined"!=typeof location&&location.href,j=i&&location.protocol&&location.protocol.replace(/\:/,""),k=i&&location.hostname,l=i&&(location.port||void 0),m=[],n=a.config&&a.config()||{};return b={version:"2.0.6",strip:function(a){if(a){a=a.replace(g,"");var b=a.match(h);b&&(a=b[1])}else a="";return a},jsEscape:function(a){return a.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:n.createXhr||function(){var a,b,c;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(b=0;3>b;b+=1){c=f[b];try{a=new ActiveXObject(c)}catch(d){}if(a){f=[c];break}}return a},parseName:function(a){var b,c,d,e=!1,f=a.indexOf("."),g=0===a.indexOf("./")||0===a.indexOf("../");return-1!==f&&(!g||f>1)?(b=a.substring(0,f),c=a.substring(f+1,a.length)):b=a,d=c||b,f=d.indexOf("!"),-1!==f&&(e="strip"===d.substring(f+1),d=d.substring(0,f),c?c=d:b=d),{moduleName:b,ext:c,strip:e}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(a,c,d,e){var f,g,h,i=b.xdRegExp.exec(a);return i?(f=i[2],g=i[3],g=g.split(":"),h=g[1],g=g[0],!(f&&f!==c||g&&g.toLowerCase()!==d.toLowerCase()||(h||g)&&h!==e)):!0},finishLoad:function(a,c,d,e){d=c?b.strip(d):d,n.isBuild&&(m[a]=d),e(d)},load:function(a,c,d,e){if(e.isBuild&&!e.inlineText)return void d();n.isBuild=e.isBuild;var f=b.parseName(a),g=f.moduleName+(f.ext?"."+f.ext:""),h=c.toUrl(g),m=n.useXhr||b.useXhr;!i||m(h,j,k,l)?b.get(h,function(c){b.finishLoad(a,f.strip,c,d)},function(a){d.error&&d.error(a)}):c([g],function(a){b.finishLoad(f.moduleName+"."+f.ext,f.strip,a,d)})},write:function(a,c,d,e){if(m.hasOwnProperty(c)){var f=b.jsEscape(m[c]);d.asModule(a+"!"+c,"define(function () { return '"+f+"';});\n")}},writeFile:function(a,c,d,e,f){var g=b.parseName(c),h=g.ext?"."+g.ext:"",i=g.moduleName+h,j=d.toUrl(g.moduleName+h)+".js";b.load(i,d,function(c){var d=function(a){return e(j,a)};d.asModule=function(a,b){return e.asModule(a,j,b)},b.write(a,i,d,f)},f)}},"node"===n.env||!n.env&&"undefined"!=typeof process&&process.versions&&process.versions.node?(c=require.nodeRequire("fs"),b.get=function(a,b){var d=c.readFileSync(a,"utf8");0===d.indexOf("\ufeff")&&(d=d.substring(1)),b(d)}):"xhr"===n.env||!n.env&&b.createXhr()?b.get=function(a,c,d,e){var f,g=b.createXhr();if(g.open("GET",a,!0),e)for(f in e)e.hasOwnProperty(f)&&g.setRequestHeader(f.toLowerCase(),e[f]);n.onXhr&&n.onXhr(g,a),g.onreadystatechange=function(b){var e,f;4===g.readyState&&(e=g.status,e>399&&600>e?(f=new Error(a+" HTTP status: "+e),f.xhr=g,d(f)):c(g.responseText),n.onXhrComplete&&n.onXhrComplete(g,a))},g.send(null)}:"rhino"===n.env||!n.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?b.get=function(a,b){var c,d,e="utf-8",f=new java.io.File(a),g=java.lang.System.getProperty("line.separator"),h=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(f),e)),i="";try{for(c=new java.lang.StringBuffer,d=h.readLine(),d&&d.length()&&65279===d.charAt(0)&&(d=d.substring(1)),c.append(d);null!==(d=h.readLine());)c.append(g),c.append(d);i=String(c.toString())}finally{h.close()}b(i)}:("xpconnect"===n.env||!n.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(d=Components.classes,e=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),b.get=function(a,b){var c,f,g={},h=new FileUtils.File(a);try{c=d["@mozilla.org/network/file-input-stream;1"].createInstance(e.nsIFileInputStream),c.init(h,1,0,!1),f=d["@mozilla.org/intl/converter-input-stream;1"].createInstance(e.nsIConverterInputStream),f.init(c,"utf-8",c.available(),e.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),f.readString(c.available(),g),f.close(),c.close(),b(g.value)}catch(i){throw new Error((h&&h.path||"")+": "+i)}}),b}),define("text!version.json",[],function(){return'{"readiumJs":{"sha":"c57c2b1137793a08cd1305b89b7505ef56ef80d3","tag":"0.19-0-gc57c2b1","clean":true},"readiumSharedJs":{"sha":"0848f393deea3d1427234cab12e2da382f476adc","tag":"0.19-0-g0848f39","clean":true}}'}),function(){"use strict";console.debug||(console.debug=console.log),console.info||(console.info=console.log),console.warn||(console.warn=console.log),console.error||(console.error=console.log)}(),define("console_shim",function(){}),ReadiumSDK={version:function(){return"0.8.0"},Models:{Smil:{}},Views:{ORIENTATION_LANDSCAPE:"orientation_landscape",ORIENTATION_PORTRAIT:"orientation_portrait"},Collections:{},Routers:{},Helpers:{},Overrides:{},Events:{READER_INITIALIZED:"ReaderInitialized",PAGINATION_CHANGED:"PaginationChanged",SETTINGS_APPLIED:"SettingsApplied",FXL_VIEW_RESIZED:"FXLViewResized",READER_VIEW_CREATED:"ReaderViewCreated",READER_VIEW_DESTROYED:"ReaderViewDestroyed",CONTENT_DOCUMENT_LOAD_START:"ContentDocumentLoadStart",CONTENT_DOCUMENT_LOADED:"ContentDocumentLoaded",MEDIA_OVERLAY_STATUS_CHANGED:"MediaOverlayStatusChanged",MEDIA_OVERLAY_TTS_SPEAK:"MediaOverlayTTSSpeak",MEDIA_OVERLAY_TTS_STOP:"MediaOverlayTTSStop"},InternalEvents:{CURRENT_VIEW_PAGINATION_CHANGED:"CurrentViewPaginationChanged"}},navigator.epubReadingSystem={name:"",version:"0.0.0",layoutStyle:"paginated",hasFeature:function(a,b){return b&&"1.0"!==b?!1:"dom-manipulation"===a?!0:"layout-changes"===a?!0:"touch-events"===a?!1:"mouse-events"===a?!0:"keyboard-events"===a?!0:"spine-scripting"===a?!0:!1}},_.extend(ReadiumSDK,Backbone.Events),define("readiumSDK",["backbone"],function(a){return function(){var b;return b||a.readiumSDK}}(this)),function(a){var b=function(a){return parseInt(a,10)||0};a.each(["min","max"],function(c,d){a.fn[d+"Size"]=function(a){var c,e;return a?(void 0!==a.width&&this.css(d+"-width",a.width),void 0!==a.height&&this.css(d+"-height",a.height),this):(c=this.css(d+"-width"),e=this.css(d+"-height"),{width:"max"===d&&(void 0===c||"none"===c||-1===b(c))&&Number.MAX_VALUE||b(c),height:"max"===d&&(void 0===e||"none"===e||-1===b(e))&&Number.MAX_VALUE||b(e)})}}),a.fn.isVisible=function(){return this.is(":visible")},a.each(["border","margin","padding"],function(c,d){a.fn[d]=function(a){return a?(void 0!==a.top&&this.css(d+"-top"+("border"===d?"-width":""),a.top),void 0!==a.bottom&&this.css(d+"-bottom"+("border"===d?"-width":""),a.bottom),void 0!==a.left&&this.css(d+"-left"+("border"===d?"-width":""),a.left),void 0!==a.right&&this.css(d+"-right"+("border"===d?"-width":""),a.right),this):{top:b(this.css(d+"-top"+("border"===d?"-width":""))),bottom:b(this.css(d+"-bottom"+("border"===d?"-width":""))),left:b(this.css(d+"-left"+("border"===d?"-width":""))),right:b(this.css(d+"-right"+("border"===d?"-width":"")))}}})}(jQuery),define("jquerySizes",["jquery"],function(a){return function(){var b;return b||a.jquerySizes}}(this)),ReadiumSDK.Helpers.Rect=function(a,b,c,d){this.left=a,this.top=b,this.width=c,this.height=d,this.right=function(){return this.left+this.width},this.bottom=function(){return this.top+this.height},this.isOverlap=function(a,b){return void 0==b&&(b=0),!(a.right()<this.left+b||a.left>this.right()-b||a.bottom()<this.top+b||a.top>this.bottom()-b)}},ReadiumSDK.Helpers.Rect.fromElement=function(a){var b;b=_.isArray(a)||a instanceof jQuery?a[0]:a,3===b.nodeType&&(b=a.parent()[0]);for(var c=b.offsetLeft,d=b.offsetTop,e=b.offsetWidth,f=b.offsetHeight;b=b.offsetParent;)c+=b.offsetLeft,d+=b.offsetTop;return new ReadiumSDK.Helpers.Rect(c,d,e,f)},ReadiumSDK.Helpers.UpdateHtmlFontSize=function(a,b){for(var c,d=b/100,e=a[0].ownerDocument.defaultView,f=$("p, div, span, h1, h2, h3, h4, h5, h6, li, blockquote, td, pre",a),g=0;g<f.length;g++){var h=f[g],i=h.getAttribute("data-original-font-size");if(!i){var j=e.getComputedStyle(h),k=parseInt(j.fontSize);c=parseInt(j.lineHeight),h.setAttribute("data-original-font-size",k),c&&h.setAttribute("data-original-line-height",c)}}c=0;for(var g=0;g<f.length;g++){var h=f[g],i=h.getAttribute("data-original-font-size"),l=h.getAttribute("data-original-line-height"),k=Number(i);c=l?Number(l):0,h.style.fontSize=k*d+"px",c&&(h.style.lineHeight=c*d+"px")}a.css("font-size",b+"%")},ReadiumSDK.Helpers.ResolveContentRef=function(a,b){if(!b)return a;var c=b.split("/");c.pop();for(var d=a.split("/");c.length>0&&".."===d[0];)c.pop(),d.splice(0,1);var e=c.concat(d);return e.join("/")},ReadiumSDK.Helpers.EndsWith=function(a,b){return-1!==a.indexOf(b,a.length-b.length)},ReadiumSDK.Helpers.BeginsWith=function(a,b){return 0===a.indexOf(b)},ReadiumSDK.Helpers.RemoveFromString=function(a,b){var c=a.indexOf(b);return-1==c?a:a.substring(0,c)+a.substring(c+b.length)},ReadiumSDK.Helpers.Margins=function(a,b,c){this.margin=a,this.border=b,this.padding=c,this.left=this.margin.left+this.border.left+this.padding.left,this.right=this.margin.right+this.border.right+this.padding.right,this.top=this.margin.top+this.border.top+this.padding.top,this.bottom=this.margin.bottom+this.border.bottom+this.padding.bottom,this.width=function(){return this.left+this.right},this.height=function(){return this.top+this.bottom}},ReadiumSDK.Helpers.triggerLayout=function(a){var b=a[0].contentDocument;if(b){var c=void 0;try{if(c=b.styleSheets&&b.styleSheets.length?b.styleSheets[0]:void 0,!c){var d=b.createElement("style");b.head.appendChild(d),d.appendChild(b.createTextNode("")),c=d.sheet}c&&c.insertRule("body:first-child::before {content:'READIUM';color: red;font-weight: bold;}",c.cssRules.length)}catch(e){console.error(e)}try{var f=b.createElementNS("http://www.w3.org/1999/xhtml","style");f.appendChild(b.createTextNode("*{}")),b.body.appendChild(f),b.body.removeChild(f),c&&c.deleteRule(c.cssRules.length-1)}catch(e){console.error(e)}if(b.body){b.body.offsetTop}}},ReadiumSDK.Helpers.deduceSyntheticSpread=function(a,b,c){if(!a||0==a.length)return 0;var d=b?b.getRenditionSpread():void 0;if(d===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE)return!1;if("double"==c.syntheticSpread)return!0;if("single"==c.syntheticSpread)return!1;if(!b)return 0;if(d===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH)return!0;var e=ReadiumSDK.Helpers.getOrientation(a);if(d===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE)return e===ReadiumSDK.Views.ORIENTATION_LANDSCAPE;if(d===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT)return e===ReadiumSDK.Views.ORIENTATION_PORTRAIT;if(!d||d===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO){var f=e===ReadiumSDK.Views.ORIENTATION_LANDSCAPE;return f?1:0}return console.warn("ReadiumSDK.Helpers.deduceSyntheticSpread: spread properties?!"),0},ReadiumSDK.Helpers.Margins.fromElement=function(a){return new this(a.margin(),a.border(),a.padding())},ReadiumSDK.Helpers.Margins.empty=function(){return new this({left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0})},ReadiumSDK.Helpers.loadTemplate=function(a,b){return ReadiumSDK.Helpers.loadTemplate.cache[a]},ReadiumSDK.Helpers.loadTemplate.cache={fixed_book_frame:'<div id="fixed-book-frame" class="clearfix book-frame fixed-book-frame"></div>',single_page_frame:'<div><div id="scaler"><iframe scrolling="no" class="iframe-fixed"></iframe></div></div>',scrolled_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"><div id="scrolled-content-frame"></div></div>',reflowable_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"></div>',reflowable_book_page_frame:'<div id="reflowable-content-frame" class="reflowable-content-frame"><iframe scrolling="no" id="epubContentIframe"></iframe></div>'},ReadiumSDK.Helpers.setStyles=function(a,b){var c=a.length;if(c)for(var d=0;c>d;d++){var e=a[d];e.selector?$(e.selector,b).css(e.declarations):b.css(e.declarations)}},ReadiumSDK.Helpers.isIframeAlive=function(a){var b=void 0,c=void 0;try{b=a.contentWindow,c=a.contentDocument}catch(d){return console.error(d),!1}return b&&c},ReadiumSDK.Helpers.getOrientation=function(a){var b=a.width(),c=a.height();return b&&c?b>=c?ReadiumSDK.Views.ORIENTATION_LANDSCAPE:ReadiumSDK.Views.ORIENTATION_PORTRAIT:void 0},ReadiumSDK.Helpers.isRenditionSpreadPermittedForItem=function(a,b){var c=a.getRenditionSpread();return!c||c==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH||c==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO||c==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE&&b==ReadiumSDK.Views.ORIENTATION_LANDSCAPE||c==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT&&b==ReadiumSDK.Views.ORIENTATION_PORTRAIT},ReadiumSDK.Helpers.CSSTransition=function(a,b){var c={};_.each(["","-webkit-","-moz-","-ms-"],function(a){c[a+"transition"]=a+b}),a.css(c)},ReadiumSDK.Helpers.CSSTransformString=function(a){var b,c,d,e=a.enable3D?!0:!1,f=a.origin;if(a.left||a.top){var g=a.left||0,h=a.top||0;b=e?"translate3D("+g+"px, "+h+"px, 0)":"translate("+g+"px, "+h+"px)"}if(a.scale&&(c=e?"scale3D("+a.scale+", "+a.scale+", 0)":"scale("+a.scale+")"),a.angle&&(d=e?"rotate3D(0,0,"+a.angle+"deg)":"rotate("+a.angle+"deg)"),!(b||c||d))return{};var i=b&&c?b+" "+c:b?b:c;d&&(i=i+" "+d);var j={};return j.transform=i,j["transform-origin"]=f?f:e?"0 0 0":"0 0",j},ReadiumSDK.Helpers.extendedThrottle=function(a,b,c,d,e,f){d||(d=250),e||(e=d);var g,h,i=!0;return function(){var j=f||this,k=Date.now&&Date.now()||(new Date).getTime(),l=arguments;g&&g+d>k||(g=k,i?(a.apply(j,l),i=!1):b.apply(j,l)),clearTimeout(h),h=setTimeout(function(){g=k,i=!0,c.apply(j,l)},e)}},ReadiumSDK.Helpers.escapeJQuerySelector=function(a){if(!a)return void 0;var b=a.replace(/([;&,\.\+\*\~\?':"\!\^#$%@\[\]\(\)<=>\|\/\\{}`])/g,"\\$1");return b},define("helpers",["readiumSDK","jquerySizes"],function(a){return function(){var b;return b||a.helpers}}(this)),ReadiumSDK.Models.ViewerSettings=function(a){function b(a){for(var b=[],c=a.split(/[\s,;]+/),d=0;d<c.length;d++){var e=c[d].trim();""!==e&&b.push(e)}return b}function c(a,b,c){void 0!==b[a]&&(c?d[a]=c(b[a]):d[a]=b[a])}var d=this;this.syntheticSpread="auto",this.fontSize=100,this.columnGap=20,this.mediaOverlaysPreservePlaybackWhenScroll=!1,this.mediaOverlaysSkipSkippables=!1,this.mediaOverlaysEscapeEscapables=!0,this.mediaOverlaysSkippables=[],this.mediaOverlaysEscapables=[],this.mediaOverlaysEnableClick=!0,this.mediaOverlaysRate=1,this.mediaOverlaysVolume=100,this.mediaOverlaysSynchronizationGranularity="",this.mediaOverlaysAutomaticPageTurn=!0,this.enableGPUHardwareAccelerationCSS3D=!1,this.pageTransition=-1,this.scroll="auto",this.update=function(a){c("columnGap",a),c("fontSize",a),c("mediaOverlaysPreservePlaybackWhenScroll",a),c("mediaOverlaysSkipSkippables",a),c("mediaOverlaysEscapeEscapables",a),c("mediaOverlaysSkippables",a,b),c("mediaOverlaysEscapables",a,b),c("mediaOverlaysEnableClick",a),c("mediaOverlaysRate",a),c("mediaOverlaysVolume",a),c("mediaOverlaysSynchronizationGranularity",a),c("mediaOverlaysAutomaticPageTurn",a),c("scroll",a),c("syntheticSpread",a),c("pageTransition",a),c("enableGPUHardwareAccelerationCSS3D",a)},this.update(a)},define("viewerSettings",["readiumSDK"],function(a){return function(){var b;return b||a.viewerSettings}}(this)),ReadiumSDK.Models.Style=function(a,b){this.selector=a,this.declarations=b,this.setDeclarations=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.declarations[b]=a[b])}},define("style",["readiumSDK"],function(a){return function(){var b;return b||a.style}}(this)),ReadiumSDK.Collections.StyleCollection=function(){var a=[];this.clear=function(){a.length=0},this.findStyle=function(b){for(var c=a.length,d=0;c>d;d++)if(a[d].selector===b)return a[d];return void 0},this.addStyle=function(b,c){var d=this.findStyle(b);return d?d.setDeclarations(c):(d=new ReadiumSDK.Models.Style(b,c),a.push(d)),d},this.removeStyle=function(b){for(var c=a.length,d=0;c>d;d++)if(a[d].selector===b)return void a.splice(d,1)},this.getStyles=function(){return a},this.resetStyleValues=function(){for(var b=a.length,c=0;b>c;c++){var d=a[c],e=d.declarations;for(var f in e)e.hasOwnProperty(f)&&(e[f]="")}}},define("styleCollection",["readiumSDK","style"],function(a){return function(){var b;return b||a.styleCollection}}(this)),ReadiumSDK.Models.SpineItem=function(a,b,c){function d(){f.page_spread&&f.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_LEFT&&f.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_RIGHT&&f.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_CENTER&&console.error(f.page_spread+" is not a recognized spread type")}function e(a,b){return f[a]?f[a]===b:f.spine["package"][a]?f.spine["package"][a]===b:!1}var f=this;this.idref=a.idref,this.href=a.href,this.linear=a.linear?a.linear.toLowerCase():a.linear,this.page_spread=a.page_spread,this.rendition_viewport=a.rendition_viewport,this.rendition_spread=a.rendition_spread,this.rendition_orientation=a.rendition_orientation,this.rendition_layout=a.rendition_layout,this.rendition_flow=a.rendition_flow,this.media_overlay_id=a.media_overlay_id,this.media_type=a.media_type,this.index=b,this.spine=c,d(),this.setSpread=function(a){this.page_spread=a,d()},this.isRenditionSpreadAllowed=function(){var a=f.getRenditionSpread();return!a||a!=ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE},this.isLeftPage=function(){return f.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_LEFT},this.isRightPage=function(){return f.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_RIGHT},this.isCenterPage=function(){return f.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_CENTER},this.isReflowable=function(){return!f.isFixedLayout()},this.isFixedLayout=function(){var a=f.getRenditionLayout();if(a){if(f.rendition_layout){if(f.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED)return!0;if(f.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_REFLOWABLE)return!1}return f.spine["package"].isFixedLayout()}return f.media_type.indexOf("image/")>=0},this.getRenditionFlow=function(){return f.rendition_flow?f.rendition_flow:f.spine["package"].rendition_flow},this.getRenditionViewport=function(){return f.rendition_viewport?f.rendition_viewport:f.spine["package"].rendition_viewport},this.getRenditionSpread=function(){return f.rendition_spread?f.rendition_spread:f.spine["package"].rendition_spread},this.getRenditionOrientation=function(){return f.rendition_orientation?f.rendition_orientation:f.spine["package"].rendition_orientation},this.getRenditionLayout=function(){return f.rendition_layout?f.rendition_layout:f.spine["package"].rendition_layout},this.isFlowScrolledContinuous=function(){return e("rendition_flow",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_CONTINUOUS)},this.isFlowScrolledDoc=function(){return e("rendition_flow",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_DOC)}},ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_REFLOWABLE="reflowable",ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED="pre-paginated",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_LANDSCAPE="landscape",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_PORTRAIT="portrait",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_AUTO="auto",ReadiumSDK.Models.SpineItem.SPREAD_LEFT="page-spread-left",ReadiumSDK.Models.SpineItem.SPREAD_RIGHT="page-spread-right",ReadiumSDK.Models.SpineItem.SPREAD_CENTER="page-spread-center",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE="none",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE="landscape",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT="portrait",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH="both",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO="auto",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_PAGINATED="paginated",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_CONTINUOUS="scrolled-continuous",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_DOC="scrolled-doc",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_AUTO="auto",ReadiumSDK.Models.SpineItem.alternateSpread=function(a){return a===ReadiumSDK.Models.SpineItem.SPREAD_LEFT?ReadiumSDK.Models.SpineItem.SPREAD_RIGHT:a===ReadiumSDK.Models.SpineItem.SPREAD_RIGHT?ReadiumSDK.Models.SpineItem.SPREAD_LEFT:a},define("spineItem",["readiumSDK"],function(a){return function(){var b;return b||a.spineItem}}(this)),ReadiumSDK.Models.Spine=function(a,b){function c(a){return!i||"no"!==a.linear}function d(a){if(!f(a))return void 0;var b=h.items[a];return c(b)?b:d(b.index+1)}function e(a){if(!f(a))return void 0;var b=h.items[a];return c(b)?b:e(b.index-1)}function f(a){return a>=0&&a<h.items.length}function g(){for(var a=h.items.length,b=!1,c=h.isLeftToRight()?ReadiumSDK.Models.SpineItem.SPREAD_LEFT:ReadiumSDK.Models.SpineItem.SPREAD_RIGHT,d=0;a>d;d++){var e=h.items[d];if(!e.page_spread){var f=e.isRenditionSpreadAllowed()?b?c:ReadiumSDK.Models.SpineItem.alternateSpread(c):ReadiumSDK.Models.SpineItem.SPREAD_CENTER;e.setSpread(f)}b=!e.isRenditionSpreadAllowed()||e.page_spread!=c}}var h=this;this.items=[],this.direction="ltr",this["package"]=a;var i=!1;if(this.handleLinear=function(a){i=a},this.isValidLinearItem=function(a){return f(a)?c(this.item(a)):void 0},this.prevItem=function(a){return e(a.index-1)},this.nextItem=function(a){return d(a.index+1)},this.getItemUrl=function(a){return h["package"].resolveRelativeUrl(a.href)},this.first=function(){return d(0)},this.last=function(){return e(this.items.length-1)},this.isFirstItem=function(a){return h.first()===a},this.isLastItem=function(a){return h.last()===a},this.item=function(a){return f(a)?h.items[a]:void 0},this.isRightToLeft=function(){return"rtl"==h.direction},this.isLeftToRight=function(){return!h.isRightToLeft()},this.getItemById=function(a){for(var b=h.items.length,c=0;b>c;c++)if(h.items[c].idref==a)return h.items[c];return void 0},this.getItemByHref=function(a){for(var b=h.items.length,c=0;b>c;c++)if(h.items[c].href==a)return h.items[c];return void 0},b){b.direction&&(this.direction=b.direction);for(var j=b.items.length,k=0;j>k;k++){var l=new ReadiumSDK.Models.SpineItem(b.items[k],k,this);this.items.push(l)}g()}},define("spine",["readiumSDK","spineItem"],function(a){return function(){var b;return b||a.spine}}(this)),ReadiumSDK.Models.Smil.SmilNode=function(a){this.parent=a,this.id="",this.getSmil=function(){for(var a=this;a.parent;)a=a.parent;return a},this.hasAncestor=function(a){for(var b=this.parent;b;){if(b==a)return!0;b=b.parent}return!1}},ReadiumSDK.Models.Smil.TimeContainerNode=function(a){this.parent=a,this.children=void 0,this.index=void 0,this.epubtype="",this.isEscapable=function(a){if(""===this.epubtype)return!1;var b=this.getSmil();if(!b.mo)return!1;var c=b.mo.escapables;a.length>0&&(c=a);for(var d=0;d<c.length;d++)if(this.epubtype.indexOf(c[d])>=0)return!0;return!1},this.isSkippable=function(a){if(""===this.epubtype)return!1;var b=this.getSmil();if(!b.mo)return!1;var c=b.mo.skippables;a.length>0&&(c=a);for(var d=0;d<c.length;d++)if(this.epubtype.indexOf(c[d])>=0)return!0;return!1}},ReadiumSDK.Models.Smil.TimeContainerNode.prototype=new ReadiumSDK.Models.Smil.SmilNode,ReadiumSDK.Models.Smil.MediaNode=function(a){this.parent=a,this.src=""},ReadiumSDK.Models.Smil.MediaNode.prototype=new ReadiumSDK.Models.Smil.SmilNode,ReadiumSDK.Models.Smil.SeqNode=function(a){this.parent=a,this.children=[],this.nodeType="seq",this.textref="",this.durationMilliseconds=function(){for(var a=this.getSmil(),b=0,c=0;c<this.children.length;c++){var d=this.children[c];if("par"===d.nodeType){if(!d.audio)continue;if(d.text&&(!d.text.manifestItemId||d.text.manifestItemId!=a.spineItemId))continue;var e=d.audio.clipDurationMilliseconds();b+=e}else"seq"===d.nodeType&&(b+=d.durationMilliseconds())}return b},this.clipOffset=function(a,b){for(var c=this.getSmil(),d=0;d<this.children.length;d++){var e=this.children[d];if("par"===e.nodeType){if(e==b)return!0;if(!e.audio)continue;if(e.text&&(!e.text.manifestItemId||e.text.manifestItemId!=c.spineItemId))continue;var f=e.audio.clipDurationMilliseconds();a.offset+=f}else if("seq"===e.nodeType){var g=e.clipOffset(a,b);if(g)return!0}}return!1},this.parallelAt=function(a){for(var b=this.getSmil(),c=0,d=0;d<this.children.length;d++){var e=a-c,f=this.children[d];if("par"===f.nodeType){if(!f.audio)continue;if(f.text&&(!f.text.manifestItemId||f.text.manifestItemId!=b.spineItemId))continue;var g=f.audio.clipDurationMilliseconds();if(g>0&&g>=e)return f;c+=g}else if("seq"===f.nodeType){var h=f.parallelAt(e);if(h)return h;c+=f.durationMilliseconds()}}return void 0},this.nthParallel=function(a,b){for(var c=0;c<this.children.length;c++){var d=this.children[c];if("par"===d.nodeType){if(b.count++,b.count==a)return d}else if("seq"===d.nodeType){var e=d.nthParallel(a,b);if(e)return e}}return void 0}},ReadiumSDK.Models.Smil.SeqNode.prototype=new ReadiumSDK.Models.Smil.TimeContainerNode,ReadiumSDK.Models.Smil.ParNode=function(a){this.parent=a,this.children=[],this.nodeType="par",this.text=void 0,this.audio=void 0,this.element=void 0,this.getFirstSeqAncestorWithEpubType=function(a,b){if(!a)return void 0;for(var c=b?this:this.parent;c;){if(c.epubtype&&c.epubtype.indexOf(a)>=0)return c;c=c.parent}return void 0}},ReadiumSDK.Models.Smil.ParNode.prototype=new ReadiumSDK.Models.Smil.TimeContainerNode,ReadiumSDK.Models.Smil.TextNode=function(a){this.parent=a,this.nodeType="text",this.srcFile="",this.srcFragmentId="",this.manifestItemId=void 0,this.updateMediaManifestItemId=function(){var a=this.getSmil();if(a.href&&a.href.length){for(var b=this.srcFile?this.srcFile:this.src,c=ReadiumSDK.Helpers.ResolveContentRef(b,a.href),d=a.mo["package"].resolveRelativeUrlMO(c),e=0;e<a.mo["package"].spine.items.length;e++){var f=a.mo["package"].spine.items[e],g=a.mo["package"].resolveRelativeUrl(f.href);if(g===d)return void(this.manifestItemId=f.idref)}console.error("Cannot set the Media ManifestItemId? "+this.src+" && "+a.href)}}},ReadiumSDK.Models.Smil.TextNode.prototype=new ReadiumSDK.Models.Smil.MediaNode,ReadiumSDK.Models.Smil.AudioNode=function(a){this.parent=a,this.nodeType="audio",this.clipBegin=0,this.MAX=1234567890.1,this.clipEnd=this.MAX,this.clipDurationMilliseconds=function(){var a=1e3*this.clipBegin,b=1e3*this.clipEnd;return this.clipEnd>=this.MAX||a>=b?0:b-a}},ReadiumSDK.Models.Smil.AudioNode.prototype=new ReadiumSDK.Models.Smil.MediaNode,ReadiumSDK.Models.SmilModel=function(){this.parent=void 0,this.children=[],this.id=void 0,this.href=void 0,this.duration=void 0,this.mo=void 0,this.parallelAt=function(a){return this.children[0].parallelAt(a)},this.nthParallel=function(a){var b={count:-1};return this.children[0].nthParallel(a,b)},this.clipOffset=function(a){var b={offset:0};return this.children[0].clipOffset(b,a)?b.offset:0},this.durationMilliseconds_Calculated=function(){return this.children[0].durationMilliseconds()};var a=[];this.hasSync=function(b){for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1},this.addSync=function(b){if(b)for(var c=b.split(" "),d=0;d<c.length;d++){var e=c[d].trim();e.length>0&&!this.hasSync(e)&&a.push(e)}}},ReadiumSDK.Models.SmilModel.fromSmilDTO=function(a,b){b.DEBUG&&console.debug("Media Overlay DTO import...");var c=0,d=function(){for(var a="",b=0;c>b;b++)a+="   ";return a},e=new ReadiumSDK.Models.SmilModel;e.id=a.id,e.spineItemId=a.spineItemId,e.href=a.href,e.smilVersion=a.smilVersion,e.duration=a.duration,e.duration&&e.duration.length&&e.duration.length>0&&(console.error("SMIL duration is string, parsing float... ("+e.duration+")"),e.duration=parseFloat(e.duration)),e.mo=b,e.mo.DEBUG&&(console.log("JS MO smilVersion="+e.smilVersion),console.log("JS MO id="+e.id),console.log("JS MO spineItemId="+e.spineItemId),console.log("JS MO href="+e.href),console.log("JS MO duration="+e.duration));var f=function(a,b,c,f){a in b?(a in c||console.debug("property "+a+" not declared in smil node "+c.nodeType),c[a]=b[a],e.mo.DEBUG&&console.log(d()+"JS MO: ["+a+"="+c[a]+"]")):f&&console.log("Required property "+a+" not found in smil node "+b.nodeType)},g=function(a,b){var g;if("seq"==a.nodeType)e.mo.DEBUG&&console.log(d()+"JS MO seq"),g=new ReadiumSDK.Models.Smil.SeqNode(b),f("textref",a,g,b&&b.parent?!0:!1),f("id",a,g),f("epubtype",a,g),g.epubtype&&g.getSmil().addSync(g.epubtype),c++,h(a,g),c--;else if("par"==a.nodeType){e.mo.DEBUG&&console.log(d()+"JS MO par"),g=new ReadiumSDK.Models.Smil.ParNode(b),f("id",a,g),f("epubtype",a,g),g.epubtype&&g.getSmil().addSync(g.epubtype),c++,h(a,g),c--;for(var i=0,j=g.children.length;j>i;i++){var k=g.children[i];"text"==k.nodeType?g.text=k:"audio"==k.nodeType?g.audio=k:console.error("Unexpected smil node type: "+k.nodeType)}var l=!1;if(l||!g.audio){var m=new ReadiumSDK.Models.Smil.AudioNode(g);m.clipBegin=0,m.clipEnd=m.MAX,m.src=void 0,g.audio=m}}else if("text"==a.nodeType)e.mo.DEBUG&&console.log(d()+"JS MO text"),g=new ReadiumSDK.Models.Smil.TextNode(b),f("src",a,g,!0),f("srcFile",a,g,!0),f("srcFragmentId",a,g,!1),f("id",a,g),g.updateMediaManifestItemId();else{if("audio"!=a.nodeType)return void console.error("Unexpected smil node type: "+a.nodeType);e.mo.DEBUG&&console.log(d()+"JS MO audio"),g=new ReadiumSDK.Models.Smil.AudioNode(b),f("src",a,g,!0),f("id",a,g),f("clipBegin",a,g),g.clipBegin&&g.clipBegin.length&&g.clipBegin.length>0&&(console.error("SMIL clipBegin is string, parsing float... ("+g.clipBegin+")"),g.clipBegin=parseFloat(g.clipBegin)),g.clipBegin<0&&(e.mo.DEBUG&&console.log(d()+"JS MO clipBegin adjusted to ZERO"),g.clipBegin=0),f("clipEnd",a,g),g.clipEnd&&g.clipEnd.length&&g.clipEnd.length>0&&(console.error("SMIL clipEnd is string, parsing float... ("+g.clipEnd+")"),g.clipEnd=parseFloat(g.clipEnd)),g.clipEnd<=g.clipBegin&&(e.mo.DEBUG&&console.log(d()+"JS MO clipEnd adjusted to MAX"),g.clipEnd=g.MAX)}return g},h=function(a,b){for(var c=a.children.length,d=0;c>d;d++){var e=g(a.children[d],b);e.index=d,b.children.push(e)}};return h(a,e),e},define("smilModel",["readiumSDK"],function(a){return function(){var b;return b||a.smilModel}}(this)),ReadiumSDK.Models.MediaOverlay=function(a){this["package"]=a,this.parallelAt=function(a){for(var b=0,c=0;c<this.smil_models.length;c++){var d=this.smil_models[c],e=a-b,f=d.parallelAt(e);if(f)return f;b+=d.durationMilliseconds_Calculated()}return void 0},this.percentToPosition=function(a,b,c,d){(0>a||a>100)&&(a=0);var e=this.durationMilliseconds_Calculated(),f=e*(a/100);if(c.par=this.parallelAt(f),c.par){var g=c.par.getSmil();if(g){for(var h=0,i=0;i<this.smil_models.length&&(b.smilData=this.smil_models[i],b.smilData!=g);i++)h+=b.smilData.durationMilliseconds_Calculated();d.milliseconds=f-(h+b.smilData.clipOffset(c.par))}}},this.durationMilliseconds_Calculated=function(){for(var a=0,b=0;b<this.smil_models.length;b++){var c=this.smil_models[b];a+=c.durationMilliseconds_Calculated()}return a},this.smilAt=function(a){return 0>a||a>=this.smil_models.length?void 0:this.smil_models[a]},this.positionToPercent=function(a,b,c){if(a>=this.smil_models.length)return-1;for(var d=0,e=0;a>e;e++){var f=this.smil_models[e];d+=f.durationMilliseconds_Calculated()}var g=this.smil_models[a],h=g.nthParallel(b);if(!h)return-1;var i=d+g.clipOffset(h)+c,j=this.durationMilliseconds_Calculated(),k=i/j*100;return k},this.smil_models=[],this.skippables=[],this.escapables=[],this.duration=void 0,this.narrator=void 0,this.activeClass=void 0,this.playbackActiveClass=void 0,this.DEBUG=!1,this.getSmilBySpineItem=function(a){if(!a)return void 0;for(var b=0,c=this.smil_models.length;c>b;b++){var d=this.smil_models[b];if(d.spineItemId===a.idref)return a.media_overlay_id!==d.id&&console.error("SMIL INCORRECT ID?? "+a.media_overlay_id+" /// "+d.id),d}return void 0},this.getNextSmil=function(a){var b=this.smil_models.indexOf(a);return-1==b||b==this.smil_models.length-1?void 0:this.smil_models[b+1]},this.getPreviousSmil=function(a){var b=this.smil_models.indexOf(a);return-1==b||0==b?void 0:this.smil_models[b-1]}},ReadiumSDK.Models.MediaOverlay.fromDTO=function(a,b){var c=new ReadiumSDK.Models.MediaOverlay(b);if(!a)return console.debug("No Media Overlay."),c;console.debug("Media Overlay INIT..."),c.duration=a.duration,
c.duration&&c.duration.length&&c.duration.length>0&&(console.error("SMIL total duration is string, parsing float... ("+c.duration+")"),c.duration=parseFloat(c.duration)),c.DEBUG&&console.debug("Media Overlay Duration (TOTAL): "+c.duration),c.narrator=a.narrator,c.DEBUG&&console.debug("Media Overlay Narrator: "+c.narrator),c.activeClass=a.activeClass,c.DEBUG&&console.debug("Media Overlay Active-Class: "+c.activeClass),c.playbackActiveClass=a.playbackActiveClass,c.DEBUG&&console.debug("Media Overlay Playback-Active-Class: "+c.playbackActiveClass);var d=a.smil_models.length;c.DEBUG&&console.debug("Media Overlay SMIL count: "+d);for(var e=0;d>e;e++){var f=ReadiumSDK.Models.SmilModel.fromSmilDTO(a.smil_models[e],c);c.smil_models.push(f),c.DEBUG&&console.debug("Media Overlay Duration (SPINE ITEM): "+f.duration)}d=a.skippables.length,c.DEBUG&&console.debug("Media Overlay SKIPPABLES count: "+d);for(var e=0;d>e;e++)c.skippables.push(a.skippables[e]);d=a.escapables.length,c.DEBUG&&console.debug("Media Overlay ESCAPABLES count: "+d);for(var e=0;d>e;e++)c.escapables.push(a.escapables[e]);return c},define("mediaOverlay",["readiumSDK","smilModel"],function(a){return function(){var b;return b||a.mediaOverlay}}(this)),ReadiumSDK.Models.Package=function(a){var b=this;this.spine=void 0,this.rootUrl=void 0,this.rootUrlMO=void 0,this.media_overlay=void 0,this.rendition_viewport=void 0,this.rendition_flow=void 0,this.rendition_layout=void 0,this.rendition_spread=void 0,this.rendition_orientation=void 0,this.resolveRelativeUrlMO=function(a){return b.rootUrlMO&&b.rootUrlMO.length>0?ReadiumSDK.Helpers.EndsWith(b.rootUrlMO,"/")?b.rootUrlMO+a:b.rootUrlMO+"/"+a:b.resolveRelativeUrl(a)},this.resolveRelativeUrl=function(a){return b.rootUrl?ReadiumSDK.Helpers.EndsWith(b.rootUrl,"/")?b.rootUrl+a:b.rootUrl+"/"+a:a},this.isFixedLayout=function(){return b.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED},this.isReflowable=function(){return!b.isFixedLayout()},a&&(this.rootUrl=a.rootUrl,this.rootUrlMO=a.rootUrlMO,this.rendition_viewport=a.rendition_viewport,this.rendition_layout=a.rendition_layout,this.rendition_flow=a.rendition_flow,this.rendition_orientation=a.rendition_orientation,this.rendition_spread=a.rendition_spread,this.spine=new ReadiumSDK.Models.Spine(this,a.spine),this.media_overlay=ReadiumSDK.Models.MediaOverlay.fromDTO(a.media_overlay,this))},define("package",["readiumSDK","spine","mediaOverlay"],function(a){return function(){var b;return b||a["package"]}}(this)),function(){var a=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1,b=navigator.userAgent.toLowerCase().indexOf("android")>-1,c=!1,d=new Audio;c&&(d.addEventListener("load",function(){console.debug("0) load")}),d.addEventListener("loadstart",function(){console.debug("1) loadstart")}),d.addEventListener("durationchange",function(){console.debug("2) durationchange")}),d.addEventListener("loadedmetadata",function(){console.debug("3) loadedmetadata")}),d.addEventListener("loadeddata",function(){console.debug("4) loadeddata")}),d.addEventListener("progress",function(){console.debug("5) progress")}),d.addEventListener("canplay",function(){console.debug("6) canplay")}),d.addEventListener("canplaythrough",function(){console.debug("7) canplaythrough")}),d.addEventListener("play",function(){console.debug("8) play")}),d.addEventListener("pause",function(){console.debug("9) pause")}),d.addEventListener("ended",function(){console.debug("10) ended")}),d.addEventListener("seeked",function(){console.debug("X) seeked")}),d.addEventListener("timeupdate",function(){console.debug("Y) timeupdate")}),d.addEventListener("seeking",function(){console.debug("Z) seeking")})),ReadiumSDK.Views.AudioPlayer=function(e,f,g,h,i){function j(){e({isPlaying:!0}),h()}function k(){i(),e({isPlaying:!1})}function l(){return d.moSeeking?void(c&&console.debug("onEnded() skipped (still seeking...)")):(n(),g(),void e({isPlaying:!1}))}function m(){y||(y=setInterval(function(){if(d.moSeeking)return x++,void(x>1e3&&(x=0,n()));var a=void 0;try{a=d.currentTime}catch(b){console.error(b.message)}a&&f(a,1)},20))}function n(){y&&clearInterval(y),y=void 0}function o(a){c&&console.debug("onReadyToSeek #"+a.data.playId),q(a.data.seekBegin,a.data.playId,!0)}function p(a){$(d).off(E,p),b?(c&&console.debug("onReadyToSeek ANDROID ... waiting a bit ... #"+a.data.playId),C(),setTimeout(function(){o(a)},1e3)):o(a)}function q(a,b,e){if(c&&console.debug("playSeekCurrentTime() #"+b),0==a&&(a=.01),Math.abs(a-d.currentTime)<.3)return c&&console.debug("playSeekCurrentTime() CONTINUE"),d.moSeeking=void 0,void s.play();var f=e?G:H;c&&console.debug("playSeekCurrentTime() NEED SEEK, EV: "+f),s.pause(),$(d).on(f,{newCurrentTime:a,playId:b,isNewSrc:e},r);try{d.currentTime=a}catch(g){console.error(g.message),setTimeout(function(){try{d.currentTime=a}catch(b){console.error(b.message)}},5)}}function r(a){var e=a.data.isNewSrc?G:H,f=void 0==a.data.seekRetries;(f||a.data.seekRetries==F)&&$(d).off(e,r),c&&console.debug("onSeeked() #"+a.data.playId+" FIRST? "+f+" EV: "+e);var g=d.currentTime,h=Math.abs(a.data.newCurrentTime-g);if((f||a.data.seekRetries>=0)&&h>=1)c&&console.debug("onSeeked() time diff: "+a.data.newCurrentTime+" vs. "+g+" ("+h+")"),f&&(a.data.seekRetries=F,a.data.isNewSrc=!1),a.data.seekRetries--,c&&console.debug("onSeeked() FAIL => retry again (timeout)"),setTimeout(function(){r(a)},b?1e3:200),setTimeout(function(){d.pause();try{d.currentTime=a.data.newCurrentTime}catch(b){console.error(b.message),setTimeout(function(){try{d.currentTime=a.data.newCurrentTime}catch(b){console.error(b.message)}},4)}},5);else{if(c&&(console.debug("onSeeked() STATE:"),console.debug(f),console.debug(a.data.seekRetries),console.debug(h)),h>=1){c&&console.debug("onSeeked() ABORT, TRY AGAIN FROM SCRATCH!");var i=u,j=t,k=a.data.newCurrentTime;return s.reset(),void setTimeout(function(){s.playFile(i,j,k)},10)}c&&console.debug("onSeeked() OKAY => play!"),a.data.seekRetries=void 0,s.play(),d.moSeeking=void 0}}var s=this,t=void 0,u=void 0;this.currentSmilSrc=function(){return u};var v=1;this.setRate=function(a){v=a,.5>v&&(v=.5),v>4&&(v=4),d.playbackRate=v},s.setRate(v),this.getRate=function(){return v};var w=100;this.setVolume=function(a){w=a,0>w&&(w=0),w>1&&(w=1),d.volume=w},s.setVolume(w),this.getVolume=function(){return w},this.play=function(){return c&&console.error("this.play()"),t?(m(),s.setVolume(w),s.setRate(v),d.play(),!0):!1},this.pause=function(){c&&console.error("this.pause()"),n(),d.pause()},d.addEventListener("play",j,!1),d.addEventListener("pause",k,!1),d.addEventListener("ended",l,!1);var x=0,y=void 0;this.isPlaying=function(){return void 0!==y},this.reset=function(){c&&console.error("this.reset()"),this.pause(),d.moSeeking=void 0,u=void 0,t=void 0,setTimeout(function(){d.setAttribute("src","")},1)},d.addEventListener("loadstart",function(){z=!0});var z=!1;this.touchInit=function(){return a?z?!1:(z=!0,d.setAttribute("src","touch/init/html5/audio.mp3"),d.load(),!0):!1};var A=0,B=0;this.playFile=function(a,e,f){A++,A>99999&&(A=0);var g=A;if(d.moSeeking)return B++,B>F?void(B=0):(c&&console.debug("this.playFile("+e+") @"+f+" (POSTPONE, SEEKING...)"),void setTimeout(function(){s.playFile(a,e,f)},20));d.moSeeking={},c&&console.debug("this.playFile("+e+") @"+f+" #"+g);var h=!t||t!==e;return h?(c&&(console.debug("this.playFile() NEW SRC"),console.debug("_currentEpubSrc: "+t),console.debug("epubSrc: "+e)),this.reset(),d.moSeeking={},u=a,t=e,b||d.addEventListener("play",D,!1),$(d).on(E,{seekBegin:f,playId:g},p),void setTimeout(function(){d.setAttribute("src",t),d.load(),b||C()},1)):(c&&console.debug("this.playFile() SAME SRC"),this.pause(),u=a,t=e,void q(f,g,!1))};var C=function(){c&&console.debug("playToForcePreload");var a=w;w=0,s.play(),w=a},D=function(){d.removeEventListener("play",D,!1),c&&console.debug("onPlayToForcePreload"),d.pause()},E=b?"canplaythrough":"canplay",F=10,G=a?"canplaythrough":"seeked",H=a?"timeupdate":"seeked"}}(),define("audioPlayer",["readiumSDK"],function(a){return function(){var b;return b||a.audioPlayer}}(this)),define("domReady",[],function(){"use strict";function a(a){var b;for(b=0;b<a.length;b+=1)a[b](j)}function b(){var b=k;i&&b.length&&(k=[],a(b))}function c(){i||(i=!0,g&&clearInterval(g),b())}function d(a){return i?a(j):k.push(a),d}var e,f,g,h="undefined"!=typeof window&&window.document,i=!h,j=h?document:null,k=[];if(h){if(document.addEventListener)document.addEventListener("DOMContentLoaded",c,!1),window.addEventListener("load",c,!1);else if(window.attachEvent){window.attachEvent("onload",c),f=document.createElement("div");try{e=null===window.frameElement}catch(l){}f.doScroll&&e&&window.external&&(g=setInterval(function(){try{f.doScroll(),c()}catch(a){}},30))}"complete"===document.readyState&&c()}return d.version="2.0.1",d.load=function(a,b,c,e){e.isBuild?c(null):d(c)},d}),function(a){function b(a,b){var c=typeof a[b];return c==t||!(c!=s||!a[b])||"unknown"==c}function c(a,b){return!(typeof a[b]!=s||!a[b])}function d(a,b){return typeof a[b]!=u}function e(a){return function(b,c){for(var d=c.length;d--;)if(!a(b,c[d]))return!1;return!0}}function f(a){return a&&z(a,y)&&B(a,x)}function g(a){return c(a,"body")?a.body:a.getElementsByTagName("body")[0]}function h(a){c(window,"console")&&b(window.console,"log")&&window.console.log(a)}function i(a,b){b?window.alert(a):h(a)}function j(a){D.initialized=!0,D.supported=!1,i("Rangy is not supported on this page in your browser. Reason: "+a,D.config.alertOnFail)}function k(a){i("Rangy warning: "+a,D.config.alertOnWarn)}function l(a){return a.message||a.description||String(a)}function m(){if(!D.initialized){var a,c=!1,d=!1;b(document,"createRange")&&(a=document.createRange(),z(a,w)&&B(a,v)&&(c=!0),a.detach());var e=g(document);if(!e||"body"!=e.nodeName.toLowerCase())return void j("No body element found");if(e&&b(e,"createTextRange")&&(a=e.createTextRange(),f(a)&&(d=!0)),!c&&!d)return void j("Neither Range nor TextRange are available");D.initialized=!0,D.features={implementsDomRange:c,implementsTextRange:d};var i,k;for(var m in C)(i=C[m])instanceof o&&i.init(i,D);for(var n=0,p=F.length;p>n;++n)try{F[n](D)}catch(q){k="Rangy init listener threw an exception. Continuing. Detail: "+l(q),h(k)}}}function n(a){a=a||window,m();for(var b=0,c=G.length;c>b;++b)G[b](a)}function o(a,b,c){this.name=a,this.dependencies=b,this.initialized=!1,this.supported=!1,this.initializer=c}function p(a,b,c,d){var e=new o(b,c,function(a){if(!a.initialized){a.initialized=!0;try{d(D,a),a.supported=!0}catch(c){var e="Module '"+b+"' failed to load: "+l(c);h(e)}}});C[b]=e}function q(){}function r(){}var s=("function"==typeof a.define&&a.define.amd,"object"),t="function",u="undefined",v=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],w=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],x=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],y=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],z=e(b),A=e(c),B=e(d),C={},D={version:"1.3alpha.804",initialized:!1,supported:!0,util:{isHostMethod:b,isHostObject:c,isHostProperty:d,areHostMethods:z,areHostObjects:A,areHostProperties:B,isTextRange:f,getBody:g},features:{},modules:C,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};D.fail=j,D.warn=k,{}.hasOwnProperty?D.util.extend=function(a,b,c){var d,e;for(var f in b)b.hasOwnProperty(f)&&(d=a[f],e=b[f],c&&null!==d&&"object"==typeof d&&null!==e&&"object"==typeof e&&D.util.extend(d,e,!0),a[f]=e);return a}:j("hasOwnProperty not supported"),function(){var a=document.createElementNS("http://www.w3.org/1999/xhtml","div");a.appendChild(document.createElementNS("http://www.w3.org/1999/xhtml","span"));var b,c=[].slice;try{1==c.call(a.childNodes,0)[0].nodeType&&(b=function(a){return c.call(a,0)})}catch(d){}b||(b=function(a){for(var b=[],c=0,d=a.length;d>c;++c)b[c]=a[c];return b}),D.util.toArray=b}();var E;b(document,"addEventListener")?E=function(a,b,c){a.addEventListener(b,c,!1)}:b(document,"attachEvent")?E=function(a,b,c){a.attachEvent("on"+b,c)}:j("Document does not have required addEventListener or attachEvent method"),D.util.addListener=E;var F=[];D.init=m,D.addInitListener=function(a){D.initialized?a(D):F.push(a)};var G=[];D.addCreateMissingNativeApiListener=function(a){G.push(a)},D.createMissingNativeApi=n,o.prototype={init:function(a){for(var b,c,d=this.dependencies||[],e=0,f=d.length;f>e;++e){if(c=d[e],b=C[c],!(b&&b instanceof o))throw new Error("required module '"+c+"' not found");if(b.init(),!b.supported)throw new Error("required module '"+c+"' not supported")}this.initializer(this)},fail:function(a){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+a)},warn:function(a){D.warn("Module "+this.name+": "+a)},deprecationNotice:function(a,b){D.warn("DEPRECATED: "+a+" in module "+this.name+"is deprecated. Please use "+b+" instead")},createError:function(a){return new Error("Error in Rangy "+this.name+" module: "+a)}},D.createModule=function(a){var b,c;2==arguments.length?(b=arguments[1],c=[]):(b=arguments[2],c=arguments[1]),p(!1,a,c,b)},D.createCoreModule=function(a,b,c){p(!0,a,b,c)},D.RangePrototype=q,D.rangePrototype=new q,D.selectionPrototype=new r;var H=!1,I=function(a){H||(H=!0,D.initialized||m())};return typeof window==u?void j("No window found"):typeof document==u?void j("No document found"):(b(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",I,!1),E(window,"load",I),void(a.rangy=D))}(this),rangy.createCoreModule("DomUtil",[],function(a,b){function c(a){var b;return typeof a.namespaceURI==D||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==b}function d(a){var b=a.parentNode;return 1==b.nodeType?b:null}function e(a){for(var b=0;a=a.previousSibling;)++b;return b}function f(a){switch(a.nodeType){case 7:case 10:return 0;case 3:case 8:return a.length;default:return a.childNodes.length}}function g(a,b){var c,d=[];for(c=a;c;c=c.parentNode)d.push(c);for(c=b;c;c=c.parentNode)if(H(d,c))return c;return null}function h(a,b,c){for(var d=c?b:b.parentNode;d;){if(d===a)return!0;d=d.parentNode}return!1}function i(a,b){return h(a,b,!0)}function j(a,b,c){for(var d,e=c?a:a.parentNode;e;){if(d=e.parentNode,d===b)return e;e=d}return null}function k(a){var b=a.nodeType;return 3==b||4==b||8==b}function l(a){if(!a)return!1;var b=a.nodeType;return 3==b||8==b}function m(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a}function n(a,b,c){var d=a.cloneNode(!1);if(d.deleteData(0,b),a.deleteData(b,a.length-b),m(d,a),c)for(var f,g=0;f=c[g++];)f.node==a&&f.offset>b?(f.node=d,f.offset-=b):f.node==a.parentNode&&f.offset>e(a)&&++f.offset;return d}function o(a){if(9==a.nodeType)return a;if(typeof a.ownerDocument!=D)return a.ownerDocument;if(typeof a.document!=D)return a.document;if(a.parentNode)return o(a.parentNode);throw b.createError("getDocument: no document found for node")}function p(a){var c=o(a);if(typeof c.defaultView!=D)return c.defaultView;if(typeof c.parentWindow!=D)return c.parentWindow;throw b.createError("Cannot get a window object for node")}function q(a){if(typeof a.contentDocument!=D)return a.contentDocument;if(typeof a.contentWindow!=D)return a.contentWindow.document;throw b.createError("getIframeDocument: No Document object found for iframe element")}function r(a){if(typeof a.contentWindow!=D)return a.contentWindow;if(typeof a.contentDocument!=D)return a.contentDocument.defaultView;throw b.createError("getIframeWindow: No Window object found for iframe element")}function s(a){return a&&E.isHostMethod(a,"setTimeout")&&E.isHostObject(a,"document")}function t(a,b,c){var d;if(a?E.isHostProperty(a,"nodeType")?d=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?q(a):o(a):s(a)&&(d=a.document):d=document,!d)throw b.createError(c+"(): Parameter must be a Window object or DOM node");return d}function u(a){for(var b;b=a.parentNode;)a=b;return a}function v(a,c,d,f){var h,i,k,l,m;if(a==d)return c===f?0:f>c?-1:1;if(h=j(d,a,!0))return c<=e(h)?-1:1;if(h=j(a,d,!0))return e(h)<f?-1:1;if(i=g(a,d),!i)throw new Error("comparePoints error: nodes have no common ancestor");if(k=a===i?i:j(a,i,!0),l=d===i?i:j(d,i,!0),k===l)throw b.createError("comparePoints got to case 4 and childA and childB are the same!");for(m=i.firstChild;m;){if(m===k)return-1;if(m===l)return 1;m=m.nextSibling}}function w(a){try{return a.parentNode,!1}catch(b){return!0}}function x(a){if(!a)return"[No node]";if(I&&w(a))return"[Broken node]";if(k(a))return'"'+a.data+'"';if(1==a.nodeType){var b=a.id?' id="'+a.id+'"':"";return"<"+a.nodeName+b+">["+e(a)+"]["+a.childNodes.length+"]["+(a.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return a.nodeName}function y(a){for(var b,c=o(a).createDocumentFragment();b=a.firstChild;)c.appendChild(b);return c}function z(a){this.root=a,this._next=a}function A(a){return new z(a)}function B(a,b){this.node=a,this.offset=b}function C(a){this.code=this[a],this.codeName=a,this.message="DOMException: "+this.codeName}var D="undefined",E=a.util;E.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method"),E.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var F=document.createElementNS("http://www.w3.org/1999/xhtml","div");E.areHostMethods(F,["insertBefore","appendChild","cloneNode"]||!E.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"]))||b.fail("Incomplete Element implementation"),E.isHostProperty(F,"innerHTML")||b.fail("Element is missing innerHTML property");var G=document.createTextNode("test");E.areHostMethods(G,["splitText","deleteData","insertData","appendData","cloneNode"]||!E.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"])||!E.areHostProperties(G,["data"]))||b.fail("Incomplete Text Node implementation");var H=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1},I=!1;!function(){var b=document.createElementNS("http://www.w3.org/1999/xhtml","b");b.innerHTML="1";var c=b.firstChild;b.innerHTML="<br>",I=w(c),a.features.crashyTextNodes=I}();var J;typeof window.getComputedStyle!=D?J=function(a,b){return p(a).getComputedStyle(a,null)[b]}:typeof document.documentElement.currentStyle!=D?J=function(a,b){return a.currentStyle[b]}:b.fail("No means of obtaining computed style properties found"),z.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a,b,c=this._current=this._next;if(this._current)if(a=c.firstChild)this._next=a;else{for(b=null;c!==this.root&&!(b=c.nextSibling);)c=c.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}},B.prototype={equals:function(a){return!!a&&this.node===a.node&&this.offset==a.offset},inspect:function(){return"[DomPosition("+x(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},C.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},C.prototype.toString=function(){return this.message},a.dom={arrayContains:H,isHtmlNamespace:c,parentElement:d,getNodeIndex:e,getNodeLength:f,getCommonAncestor:g,isAncestorOf:h,isOrIsAncestorOf:i,getClosestAncestorIn:j,isCharacterDataNode:k,isTextOrCommentNode:l,insertAfter:m,splitDataNode:n,getDocument:o,getWindow:p,getIframeWindow:r,getIframeDocument:q,getBody:E.getBody,isWindow:s,getContentDocument:t,getRootContainer:u,comparePoints:v,isBrokenNode:w,inspectNode:x,getComputedStyleProperty:J,fragmentFromNodeChildren:y,createIterator:A,DomPosition:B},a.DOMException=C}),rangy.createCoreModule("DomRange",["DomUtil"],function(a,b){function c(a,b){return 3!=a.nodeType&&(R(a,b.startContainer)||R(a,b.endContainer))}function d(a){return a.document||S(a.startContainer)}function e(a){return new N(a.parentNode,Q(a))}function f(a){return new N(a.parentNode,Q(a)+1)}function g(a,b,c){var d=11==a.nodeType?a.firstChild:a;return P(b)?c==b.length?L.insertAfter(a,b):b.parentNode.insertBefore(a,0==c?b:U(b,c)):c>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[c]),d}function h(a,b,c){if(B(a),B(b),d(b)!=d(a))throw new O("WRONG_DOCUMENT_ERR");var e=T(a.startContainer,a.startOffset,b.endContainer,b.endOffset),f=T(a.endContainer,a.endOffset,b.startContainer,b.startOffset);return c?0>=e&&f>=0:0>e&&f>0}function i(a){for(var b,c,e,f=d(a.range).createDocumentFragment();c=a.next();){if(b=a.isPartiallySelectedSubtree(),c=c.cloneNode(!b),b&&(e=a.getSubtreeIterator(),c.appendChild(i(e)),e.detach(!0)),10==c.nodeType)throw new O("HIERARCHY_REQUEST_ERR");f.appendChild(c)}return f}function j(a,b,c){var d,e;c=c||{stop:!1};for(var f,g;f=a.next();)if(a.isPartiallySelectedSubtree()){if(b(f)===!1)return void(c.stop=!0);if(g=a.getSubtreeIterator(),j(g,b,c),g.detach(!0),c.stop)return}else for(d=L.createIterator(f);e=d.next();)if(b(e)===!1)return void(c.stop=!0)}function k(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),k(b),b.detach(!0)):a.remove()}function l(a){for(var b,c,e=d(a.range).createDocumentFragment();b=a.next();){if(a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),c=a.getSubtreeIterator(),b.appendChild(l(c)),c.detach(!0)):a.remove(),10==b.nodeType)throw new O("HIERARCHY_REQUEST_ERR");e.appendChild(b)}return e}function m(a,b,c){var d,e=!(!b||!b.length),f=!!c;e&&(d=new RegExp("^("+b.join("|")+")$"));var g=[];return j(new o(a,!1),function(b){if(!(e&&!d.test(b.nodeType)||f&&!c(b))){var h=a.startContainer;if(b!=h||!P(h)||a.startOffset!=h.length){var i=a.endContainer;b==i&&P(i)&&0==a.endOffset||g.push(b)}}}),g}function n(a){var b="undefined"==typeof a.getName?"Range":a.getName();return"["+b+"("+L.inspectNode(a.startContainer)+":"+a.startOffset+", "+L.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function o(a,b){if(this.range=a,this.clonePartiallySelectedTextNodes=b,!a.collapsed){this.sc=a.startContainer,this.so=a.startOffset,this.ec=a.endContainer,this.eo=a.endOffset;var c=a.commonAncestorContainer;this.sc===this.ec&&P(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==c||P(this.sc)?V(this.sc,c,!0):this.sc.childNodes[this.so],this._last=this.ec!==c||P(this.ec)?V(this.ec,c,!0):this.ec.childNodes[this.eo-1])}}function p(a){this.code=this[a],this.codeName=a,this.message="RangeException: "+this.codeName}function q(a){return function(b,c){for(var d,e=c?b:b.parentNode;e;){if(d=e.nodeType,X(a,d))return e;e=e.parentNode}return null}}function r(a,b){if(fa(a,b))throw new p("INVALID_NODE_TYPE_ERR")}function s(a){if(!a.startContainer)throw new O("INVALID_STATE_ERR")}function t(a,b){if(!X(b,a.nodeType))throw new p("INVALID_NODE_TYPE_ERR")}function u(a,b){if(0>b||b>(P(a)?a.length:a.childNodes.length))throw new O("INDEX_SIZE_ERR")}function v(a,b){if(da(a,!0)!==da(b,!0))throw new O("WRONG_DOCUMENT_ERR")}function w(a){if(ea(a,!0))throw new O("NO_MODIFICATION_ALLOWED_ERR")}function x(a,b){if(!a)throw new O(b)}function y(a){return Z&&L.isBrokenNode(a)||!X(_,a.nodeType)&&!da(a,!0)}function z(a,b){return b<=(P(a)?a.length:a.childNodes.length)}function A(a){return!!a.startContainer&&!!a.endContainer&&!y(a.startContainer)&&!y(a.endContainer)&&z(a.startContainer,a.startOffset)&&z(a.endContainer,a.endOffset)}function B(a){if(s(a),!A(a))throw new Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")")}function C(a,b){B(a);var c=a.startContainer,d=a.startOffset,e=a.endContainer,f=a.endOffset,g=c===e;P(e)&&f>0&&f<e.length&&U(e,f,b),P(c)&&d>0&&d<c.length&&(c=U(c,d,b),g?(f-=d,e=c):e==c.parentNode&&f>=Q(c)&&f++,d=0),a.setStartAndEnd(c,d,e,f)}function D(a){a.START_TO_START=la,a.START_TO_END=ma,a.END_TO_END=na,a.END_TO_START=oa,a.NODE_BEFORE=pa,a.NODE_AFTER=qa,a.NODE_BEFORE_AND_AFTER=ra,a.NODE_INSIDE=sa}function E(a){D(a),D(a.prototype)}function F(a,b){return function(){B(this);var c,d,e=this.startContainer,g=this.startOffset,h=this.commonAncestorContainer,i=new o(this,!0);e!==h&&(c=V(e,h,!0),d=f(c),e=d.node,g=d.offset),j(i,w),i.reset();var k=a(i);return i.detach(),b(this,e,g,e,g),k}}function G(b,d,g){function h(a,b){return function(c){s(this),t(c,$),t(Y(c),_);var d=(a?e:f)(c);(b?i:j)(this,d.node,d.offset)}}function i(a,b,c){var e=a.endContainer,f=a.endOffset;(b!==a.startContainer||c!==a.startOffset)&&((Y(b)!=Y(e)||1==T(b,c,e,f))&&(e=b,f=c),d(a,b,c,e,f))}function j(a,b,c){var e=a.startContainer,f=a.startOffset;(b!==a.endContainer||c!==a.endOffset)&&((Y(b)!=Y(e)||-1==T(b,c,e,f))&&(e=b,f=c),d(a,e,f,b,c))}var m=function(){};m.prototype=a.rangePrototype,b.prototype=new m,M.extend(b.prototype,{setStart:function(a,b){s(this),r(a,!0),u(a,b),i(this,a,b)},setEnd:function(a,b){s(this),r(a,!0),u(a,b),j(this,a,b)},setStartAndEnd:function(){s(this);var a=arguments,b=a[0],c=a[1],e=b,f=c;switch(a.length){case 3:f=a[2];break;case 4:e=a[2],f=a[3]}d(this,b,c,e,f)},setBoundary:function(a,b,c){this["set"+(c?"Start":"End")](a,b)},setStartBefore:h(!0,!0),setStartAfter:h(!1,!0),setEndBefore:h(!0,!1),setEndAfter:h(!1,!1),collapse:function(a){B(this),a?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){s(this),r(a,!0),d(this,a,0,a,W(a))},selectNode:function(a){s(this),r(a,!1),t(a,$);var b=e(a),c=f(a);d(this,b.node,b.offset,c.node,c.offset)},extractContents:F(l,d),deleteContents:F(k,d),canSurroundContents:function(){B(this),w(this.startContainer),w(this.endContainer);var a=new o(this,!0),b=a._first&&c(a._first,this)||a._last&&c(a._last,this);return a.detach(),!b},detach:function(){g(this)},splitBoundaries:function(){C(this)},splitBoundariesPreservingPositions:function(a){C(this,a)},normalizeBoundaries:function(){B(this);var a=this.startContainer,b=this.startOffset,c=this.endContainer,e=this.endOffset,f=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(c=a,e=a.length,a.appendData(b.data),b.parentNode.removeChild(b))},g=function(d){var f=d.previousSibling;if(f&&f.nodeType==d.nodeType){a=d;var g=d.length;if(b=f.length,d.insertData(0,f.data),f.parentNode.removeChild(f),a==c)e+=b,c=a;else if(c==d.parentNode){var h=Q(d);e==h?(c=d,e=g):e>h&&e--}}},h=!0;if(P(c))c.length==e&&f(c);else{if(e>0){var i=c.childNodes[e-1];i&&P(i)&&f(i)}h=!this.collapsed}if(h){if(P(a))0==b&&g(a);else if(b<a.childNodes.length){var j=a.childNodes[b];j&&P(j)&&g(j)}}else a=c,b=e;d(this,a,b,c,e)},collapseToPoint:function(a,b){s(this),r(a,!0),u(a,b),this.setStartAndEnd(a,b)}}),E(b)}function H(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset,a.commonAncestorContainer=a.collapsed?a.startContainer:L.getCommonAncestor(a.startContainer,a.endContainer)}function I(a,b,c,d,e){a.startContainer=b,a.startOffset=c,a.endContainer=d,a.endOffset=e,a.document=L.getDocument(b),H(a)}function J(a){s(a),a.startContainer=a.startOffset=a.endContainer=a.endOffset=a.document=null,a.collapsed=a.commonAncestorContainer=null}function K(a){this.startContainer=a,this.startOffset=0,this.endContainer=a,this.endOffset=0,this.document=a,H(this)}var L=a.dom,M=a.util,N=L.DomPosition,O=a.DOMException,P=L.isCharacterDataNode,Q=L.getNodeIndex,R=L.isOrIsAncestorOf,S=L.getDocument,T=L.comparePoints,U=L.splitDataNode,V=L.getClosestAncestorIn,W=L.getNodeLength,X=L.arrayContains,Y=L.getRootContainer,Z=a.features.crashyTextNodes;o.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;return a&&(this._next=a!==this._last?a.nextSibling:null,P(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so))),a},remove:function(){var a,b,c=this._current;!P(c)||c!==this.sc&&c!==this.ec?c.parentNode&&c.parentNode.removeChild(c):(a=c===this.sc?this.so:0,b=c===this.ec?this.eo:c.length,a!=b&&c.deleteData(a,b-a))},isPartiallySelectedSubtree:function(){var a=this._current;return c(a,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse(!1);else{a=new K(d(this.range));var b=this._current,c=b,e=0,f=b,g=W(b);R(b,this.sc)&&(c=this.sc,e=this.so),R(b,this.ec)&&(f=this.ec,g=this.eo),I(a,c,e,f,g)}return new o(a,this.clonePartiallySelectedTextNodes)},detach:function(a){a&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},p.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},p.prototype.toString=function(){return this.message};var $=[1,3,4,5,7,8,10],_=[2,9,11],aa=[5,6,10,12],ba=[1,3,4,5,7,8,10,11],ca=[1,3,4,5,7,8],da=q([9,11]),ea=q(aa),fa=q([6,10,12]),ga=document.createElementNS("http://www.w3.org/1999/xhtml","style"),ha=!1;try{ga.innerHTML="<b>x</b>",ha=3==ga.firstChild.nodeType}catch(ia){}a.features.htmlParsingConforms=ha;var ja=ha?function(a){var b=this.startContainer,c=S(b);if(!b)throw new O("INVALID_STATE_ERR");var d=null;return 1==b.nodeType?d=b:P(b)&&(d=L.parentElement(b)),d=null===d||"HTML"==d.nodeName&&L.isHtmlNamespace(S(d).documentElement)&&L.isHtmlNamespace(d)?c.createElementNS("http://www.w3.org/1999/xhtml","body"):d.cloneNode(!1),d.innerHTML=a,L.fragmentFromNodeChildren(d)}:function(a){s(this);var b=d(this),c=b.createElementNS("http://www.w3.org/1999/xhtml","body");return c.innerHTML=a,L.fragmentFromNodeChildren(c)},ka=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],la=0,ma=1,na=2,oa=3,pa=0,qa=1,ra=2,sa=3;M.extend(a.rangePrototype,{compareBoundaryPoints:function(a,b){B(this),v(this.startContainer,b.startContainer);var c,d,e,f,g=a==oa||a==la?"start":"end",h=a==ma||a==la?"start":"end";return c=this[g+"Container"],d=this[g+"Offset"],e=b[h+"Container"],f=b[h+"Offset"],T(c,d,e,f)},insertNode:function(a){if(B(this),t(a,ba),w(this.startContainer),R(a,this.startContainer))throw new O("HIERARCHY_REQUEST_ERR");var b=g(a,this.startContainer,this.startOffset);this.setStartBefore(b)},cloneContents:function(){B(this);var a,b;if(this.collapsed)return d(this).createDocumentFragment();if(this.startContainer===this.endContainer&&P(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=d(this).createDocumentFragment(),b.appendChild(a),b;var c=new o(this,!0);return a=i(c),c.detach(),a},canSurroundContents:function(){B(this),w(this.startContainer),w(this.endContainer);var a=new o(this,!0),b=a._first&&c(a._first,this)||a._last&&c(a._last,this);return a.detach(),!b},surroundContents:function(a){if(t(a,ca),!this.canSurroundContents())throw new p("BAD_BOUNDARYPOINTS_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);g(a,this.startContainer,this.startOffset),a.appendChild(b),this.selectNode(a)},cloneRange:function(){B(this);for(var a,b=new K(d(this)),c=ka.length;c--;)a=ka[c],b[a]=this[a];return b},toString:function(){B(this);var a=this.startContainer;if(a===this.endContainer&&P(a))return 3==a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[],c=new o(this,!0);return j(c,function(a){(3==a.nodeType||4==a.nodeType)&&b.push(a.data)}),c.detach(),b.join("")},compareNode:function(a){B(this);var b=a.parentNode,c=Q(a);if(!b)throw new O("NOT_FOUND_ERR");var d=this.comparePoint(b,c),e=this.comparePoint(b,c+1);return 0>d?e>0?ra:pa:e>0?qa:sa},comparePoint:function(a,b){return B(this),x(a,"HIERARCHY_REQUEST_ERR"),v(a,this.startContainer),
T(a,b,this.startContainer,this.startOffset)<0?-1:T(a,b,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:ja,toHtml:function(){B(this);var a=this.commonAncestorContainer.parentNode.cloneNode(!1);return a.appendChild(this.cloneContents()),a.innerHTML},intersectsNode:function(a,b){if(B(this),x(a,"NOT_FOUND_ERR"),S(a)!==d(this))return!1;var c=a.parentNode,e=Q(a);x(c,"NOT_FOUND_ERR");var f=T(c,e,this.endContainer,this.endOffset),g=T(c,e+1,this.startContainer,this.startOffset);return b?0>=f&&g>=0:0>f&&g>0},isPointInRange:function(a,b){return B(this),x(a,"HIERARCHY_REQUEST_ERR"),v(a,this.startContainer),T(a,b,this.startContainer,this.startOffset)>=0&&T(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(a){return h(this,a,!1)},intersectsOrTouchesRange:function(a){return h(this,a,!0)},intersection:function(a){if(this.intersectsRange(a)){var b=T(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=T(this.endContainer,this.endOffset,a.endContainer,a.endOffset),d=this.cloneRange();return-1==b&&d.setStart(a.startContainer,a.startOffset),1==c&&d.setEnd(a.endContainer,a.endOffset),d}return null},union:function(a){if(this.intersectsOrTouchesRange(a)){var b=this.cloneRange();return-1==T(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset),1==T(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset),b}throw new p("Ranges do not intersect")},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==sa},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,W(a))<=0},containsRange:function(a){var b=this.intersection(a);return null!==b&&a.equals(b)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var c=b.getNodes([3]);if(c.length>0){b.setStart(c[0],0);var d=c.pop();b.setEnd(d,d.length);var e=this.containsRange(b);return b.detach(),e}return this.containsNodeContents(a)},getNodes:function(a,b){return B(this),m(this,a,b)},getDocument:function(){return d(this)},collapseBefore:function(a){s(this),this.setEndBefore(a),this.collapse(!1)},collapseAfter:function(a){s(this),this.setStartAfter(a),this.collapse(!0)},getBookmark:function(b){var c=d(this),e=a.createRange(c);b=b||L.getBody(c),e.selectNodeContents(b);var f=this.intersection(e),g=0,h=0;return f&&(e.setEnd(f.startContainer,f.startOffset),g=e.toString().length,h=g+f.toString().length,e.detach()),{start:g,end:h,containerNode:b}},moveToBookmark:function(a){var b=a.containerNode,c=0;this.setStart(b,0),this.collapse(!0);for(var d,e,f,g,h=[b],i=!1,j=!1;!j&&(d=h.pop());)if(3==d.nodeType)e=c+d.length,!i&&a.start>=c&&a.start<=e&&(this.setStart(d,a.start-c),i=!0),i&&a.end>=c&&a.end<=e&&(this.setEnd(d,a.end-c),j=!0),c=e;else for(g=d.childNodes,f=g.length;f--;)h.push(g[f])},getName:function(){return"DomRange"},equals:function(a){return K.rangesEqual(this,a)},isValid:function(){return A(this)},inspect:function(){return n(this)}}),G(K,I,J),M.extend(K,{rangeProperties:ka,RangeIterator:o,copyComparisonConstants:E,createPrototypeRange:G,inspect:n,getRangeDocument:d,rangesEqual:function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}}),a.DomRange=K,a.RangeException=p}),rangy.createCoreModule("WrappedRange",["DomRange"],function(a,b){var c,d,e=a.dom,f=a.util,g=e.DomPosition,h=a.DomRange,i=e.getBody,j=e.getContentDocument,k=e.isCharacterDataNode;if(a.features.implementsDomRange&&!function(){function d(a){for(var b,c=n.length;c--;)b=n[c],a[b]=a.nativeRange[b];a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset}function g(a,b,c,d,e){var f=a.startContainer!==b||a.startOffset!=c,g=a.endContainer!==d||a.endOffset!=e,h=!a.equals(a.nativeRange);(f||g||h)&&(a.setEnd(d,e),a.setStart(b,c))}function k(a){a.nativeRange.detach(),a.detached=!0;for(var b=n.length;b--;)a[n[b]]=null}var l,m,n=h.rangeProperties;c=function(a){if(!a)throw b.createError("WrappedRange: Range must be specified");this.nativeRange=a,d(this)},h.createPrototypeRange(c,g,k),l=c.prototype,l.selectNode=function(a){this.nativeRange.selectNode(a),d(this)},l.cloneContents=function(){return this.nativeRange.cloneContents()},l.surroundContents=function(a){this.nativeRange.surroundContents(a),d(this)},l.collapse=function(a){this.nativeRange.collapse(a),d(this)},l.cloneRange=function(){return new c(this.nativeRange.cloneRange())},l.refresh=function(){d(this)},l.toString=function(){return this.nativeRange.toString()};var o=document.createTextNode("test");i(document).appendChild(o);var p=document.createRange();p.setStart(o,0),p.setEnd(o,0);try{p.setStart(o,1),l.setStart=function(a,b){this.nativeRange.setStart(a,b),d(this)},l.setEnd=function(a,b){this.nativeRange.setEnd(a,b),d(this)},m=function(a){return function(b){this.nativeRange[a](b),d(this)}}}catch(q){l.setStart=function(a,b){try{this.nativeRange.setStart(a,b)}catch(c){this.nativeRange.setEnd(a,b),this.nativeRange.setStart(a,b)}d(this)},l.setEnd=function(a,b){try{this.nativeRange.setEnd(a,b)}catch(c){this.nativeRange.setStart(a,b),this.nativeRange.setEnd(a,b)}d(this)},m=function(a,b){return function(c){try{this.nativeRange[a](c)}catch(e){this.nativeRange[b](c),this.nativeRange[a](c)}d(this)}}}l.setStartBefore=m("setStartBefore","setEndBefore"),l.setStartAfter=m("setStartAfter","setEndAfter"),l.setEndBefore=m("setEndBefore","setStartBefore"),l.setEndAfter=m("setEndAfter","setStartAfter"),l.selectNodeContents=function(a){this.setStartAndEnd(a,0,e.getNodeLength(a))},p.selectNodeContents(o),p.setEnd(o,3);var r=document.createRange();r.selectNodeContents(o),r.setEnd(o,4),r.setStart(o,2),-1==p.compareBoundaryPoints(p.START_TO_END,r)&&1==p.compareBoundaryPoints(p.END_TO_START,r)?l.compareBoundaryPoints=function(a,b){return b=b.nativeRange||b,a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END),this.nativeRange.compareBoundaryPoints(a,b)}:l.compareBoundaryPoints=function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};var s=document.createElementNS("http://www.w3.org/1999/xhtml","div");s.innerHTML="123";var t=s.firstChild,u=i(document);u.appendChild(s),p.setStart(t,1),p.setEnd(t,2),p.deleteContents(),"13"==t.data&&(l.deleteContents=function(){this.nativeRange.deleteContents(),d(this)},l.extractContents=function(){var a=this.nativeRange.extractContents();return d(this),a}),u.removeChild(s),u=null,f.isHostMethod(p,"createContextualFragment")&&(l.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)}),i(document).removeChild(o),p.detach(),r.detach(),l.getName=function(){return"WrappedRange"},a.WrappedRange=c,a.createNativeRange=function(a){return a=j(a,b,"createNativeRange"),a.createRange()}}(),a.features.implementsTextRange){var l=function(a){var b=a.parentElement(),c=a.duplicate();c.collapse(!0);var d=c.parentElement();c=a.duplicate(),c.collapse(!1);var f=c.parentElement(),g=d==f?d:e.getCommonAncestor(d,f);return g==b?g:e.getCommonAncestor(b,g)},m=function(a){return 0==a.compareEndPoints("StartToEnd",a)},n=function(a,b,c,d,f){var h=a.duplicate();h.collapse(c);var i=h.parentElement();if(e.isOrIsAncestorOf(b,i)||(i=b),!i.canHaveHTML){var j=new g(i.parentNode,e.getNodeIndex(i));return{boundaryPosition:j,nodeInfo:{nodeIndex:j.offset,containerElement:j.node}}}var l=e.getDocument(i).createElementNS("http://www.w3.org/1999/xhtml","span");l.parentNode&&l.parentNode.removeChild(l);for(var m,n,o,p,q,r=c?"StartToStart":"StartToEnd",s=f&&f.containerElement==i?f.nodeIndex:0,t=i.childNodes.length,u=t,v=u;;){if(v==t?i.appendChild(l):i.insertBefore(l,i.childNodes[v]),h.moveToElementText(l),m=h.compareEndPoints(r,a),0==m||s==u)break;if(-1==m){if(u==s+1)break;s=v}else u=u==s+1?s:v;v=Math.floor((s+u)/2),i.removeChild(l)}if(q=l.nextSibling,-1==m&&q&&k(q)){h.setEndPoint(c?"EndToStart":"EndToEnd",a);var w;if(/[\r\n]/.test(q.data)){var x=h.duplicate(),y=x.text.replace(/\r\n/g,"\r").length;for(w=x.moveStart("character",y);-1==(m=x.compareEndPoints("StartToEnd",x));)w++,x.moveStart("character",1)}else w=h.text.length;p=new g(q,w)}else n=(d||!c)&&l.previousSibling,o=(d||c)&&l.nextSibling,p=o&&k(o)?new g(o,0):n&&k(n)?new g(n,n.data.length):new g(i,e.getNodeIndex(l));return l.parentNode.removeChild(l),{boundaryPosition:p,nodeInfo:{nodeIndex:v,containerElement:i}}},o=function(a,b){var c,d,f,g,h=a.offset,j=e.getDocument(a.node),l=i(j).createTextRange(),m=k(a.node);return m?(c=a.node,d=c.parentNode):(g=a.node.childNodes,c=h<g.length?g[h]:null,d=a.node),f=j.createElementNS("http://www.w3.org/1999/xhtml","span"),f.innerHTML="&#feff;",c?d.insertBefore(f,c):d.appendChild(f),l.moveToElementText(f),l.collapse(!b),d.removeChild(f),m&&l[b?"moveStart":"moveEnd"]("character",h),l};if(d=function(a){this.textRange=a,this.refresh()},d.prototype=new h(document),d.prototype.refresh=function(){var a,b,c,d=l(this.textRange);m(this.textRange)?b=a=n(this.textRange,d,!0,!0).boundaryPosition:(c=n(this.textRange,d,!0,!1),a=c.boundaryPosition,b=n(this.textRange,d,!1,!1,c.nodeInfo).boundaryPosition),this.setStart(a.node,a.offset),this.setEnd(b.node,b.offset)},d.prototype.getName=function(){return"WrappedTextRange"},h.copyComparisonConstants(d),d.rangeToTextRange=function(a){if(a.collapsed)return o(new g(a.startContainer,a.startOffset),!0);var b=o(new g(a.startContainer,a.startOffset),!0),c=o(new g(a.endContainer,a.endOffset),!1),d=i(h.getRangeDocument(a)).createTextRange();return d.setEndPoint("StartToStart",b),d.setEndPoint("EndToEnd",c),d},a.WrappedTextRange=d,!a.features.implementsDomRange||a.config.preferTextRange){var p=function(){return this}();"undefined"==typeof p.Range&&(p.Range=d),a.createNativeRange=function(a){return a=j(a,b,"createNativeRange"),i(a).createTextRange()},a.WrappedRange=d}}a.createRange=function(c){return c=j(c,b,"createRange"),new a.WrappedRange(a.createNativeRange(c))},a.createRangyRange=function(a){return a=j(a,b,"createRangyRange"),new h(a)},a.createIframeRange=function(c){return b.deprecationNotice("createIframeRange()","createRange(iframeEl)"),a.createRange(c)},a.createIframeRangyRange=function(c){return b.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),a.createRangyRange(c)},a.addCreateMissingNativeApiListener(function(b){var c=b.document;"undefined"==typeof c.createRange&&(c.createRange=function(){return a.createRange(c)}),c=b=null})}),rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(a,b){function c(a){return"string"==typeof a?/^backward(s)?$/i.test(a):!!a}function d(a,c){if(a){if(C.isWindow(a))return a;if(a instanceof r)return a.win;var d=C.getContentDocument(a,b,c);return C.getWindow(d)}return window}function e(a){return d(a,"getWinSelection").getSelection()}function f(a){return d(a,"getDocSelection").document.selection}function g(a){var b=!1;return a.anchorNode&&(b=1==C.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)),b}function h(a,b,c){var d=c?"end":"start",e=c?"start":"end";a.anchorNode=b[d+"Container"],a.anchorOffset=b[d+"Offset"],a.focusNode=b[e+"Container"],a.focusOffset=b[e+"Offset"]}function i(a){var b=a.nativeSelection;a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset}function j(a){a.anchorNode=a.focusNode=null,a.anchorOffset=a.focusOffset=0,a.rangeCount=0,a.isCollapsed=!0,a._ranges.length=0}function k(b){var c;return b instanceof F?(c=a.createNativeRange(b.getDocument()),c.setEnd(b.endContainer,b.endOffset),c.setStart(b.startContainer,b.startOffset)):b instanceof G?c=b.nativeRange:J.implementsDomRange&&b instanceof C.getWindow(b.startContainer).Range&&(c=b),c}function l(a){if(!a.length||1!=a[0].nodeType)return!1;for(var b=1,c=a.length;c>b;++b)if(!C.isAncestorOf(a[0],a[b]))return!1;return!0}function m(a){var c=a.getNodes();if(!l(c))throw b.createError("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return c[0]}function n(a){return!!a&&"undefined"!=typeof a.text}function o(a,b){var c=new G(b);a._ranges=[c],h(a,c,!1),a.rangeCount=1,a.isCollapsed=c.collapsed}function p(b){if(b._ranges.length=0,"None"==b.docSelection.type)j(b);else{var c=b.docSelection.createRange();if(n(c))o(b,c);else{b.rangeCount=c.length;for(var d,e=L(c.item(0)),f=0;f<b.rangeCount;++f)d=a.createRange(e),d.selectNode(c.item(f)),b._ranges.push(d);b.isCollapsed=1==b.rangeCount&&b._ranges[0].collapsed,h(b,b._ranges[b.rangeCount-1],!1)}}}function q(a,c){for(var d=a.docSelection.createRange(),e=m(c),f=L(d.item(0)),g=M(f).createControlRange(),h=0,i=d.length;i>h;++h)g.add(d.item(h));try{g.add(e)}catch(j){throw b.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}g.select(),p(a)}function r(a,b,c){this.nativeSelection=a,this.docSelection=b,this._ranges=[],this.win=c,this.refresh()}function s(a){a.win=a.anchorNode=a.focusNode=a._ranges=null,a.rangeCount=a.anchorOffset=a.focusOffset=0,a.detached=!0}function t(a,b){for(var c,d,e=ba.length;e--;)if(c=ba[e],d=c.selection,"deleteAll"==b)s(d);else if(c.win==a)return"delete"==b?(ba.splice(e,1),!0):d;return"deleteAll"==b&&(ba.length=0),null}function u(a,c){for(var d,e=L(c[0].startContainer),f=M(e).createControlRange(),g=0,h=c.length;h>g;++g){d=m(c[g]);try{f.add(d)}catch(i){throw b.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}f.select(),p(a)}function v(a,b){if(a.win.document!=L(b))throw new H("WRONG_DOCUMENT_ERR")}function w(b){return function(c,d){var e;this.rangeCount?(e=this.getRangeAt(0),e["set"+(b?"Start":"End")](c,d)):(e=a.createRange(this.win.document),e.setStartAndEnd(c,d)),this.setSingleRange(e,this.isBackward())}}function x(a){var b=[],c=new I(a.anchorNode,a.anchorOffset),d=new I(a.focusNode,a.focusOffset),e="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var f=0,g=a.rangeCount;g>f;++f)b[f]=F.inspect(a.getRangeAt(f));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}a.config.checkSelectionRanges=!0;var y,z,A="boolean",B="number",C=a.dom,D=a.util,E=D.isHostMethod,F=a.DomRange,G=a.WrappedRange,H=a.DOMException,I=C.DomPosition,J=a.features,K="Control",L=C.getDocument,M=C.getBody,N=F.rangesEqual,O=E(window,"getSelection"),P=D.isHostObject(document,"selection");J.implementsWinGetSelection=O,J.implementsDocSelection=P;var Q=P&&(!O||a.config.preferTextRange);Q?(y=f,a.isSelectionValid=function(a){var b=d(a,"isSelectionValid").document,c=b.selection;return"None"!=c.type||L(c.createRange().parentElement())==b}):O?(y=e,a.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected."),a.getNativeSelection=y;var R=y(),S=a.createNativeRange(document),T=M(document),U=D.areHostProperties(R,["anchorNode","focusNode","anchorOffset","focusOffset"]);J.selectionHasAnchorAndFocus=U;var V=E(R,"extend");J.selectionHasExtend=V;var W=typeof R.rangeCount==B;J.selectionHasRangeCount=W;var X=!1,Y=!0,Z=V?function(b,c){var d=F.getRangeDocument(c),e=a.createRange(d);e.collapseToPoint(c.endContainer,c.endOffset),b.addRange(k(e)),b.extend(c.startContainer,c.startOffset)}:null;D.areHostMethods(R,["addRange","getRangeAt","removeAllRanges"])&&typeof R.rangeCount==B&&J.implementsDomRange&&!function(){var b=window.getSelection();if(b){for(var c=b.rangeCount,d=c>1,e=[],f=g(b),h=0;c>h;++h)e[h]=b.getRangeAt(h);var i=M(document),j=i.appendChild(document.createElementNS("http://www.w3.org/1999/xhtml","div"));j.contentEditable="false";var k=j.appendChild(document.createTextNode("")),l=document.createRange();if(l.setStart(k,1),l.collapse(!0),b.addRange(l),Y=1==b.rangeCount,b.removeAllRanges(),!d){var m=l.cloneRange();l.setStart(k,0),m.setEnd(k,3),m.setStart(k,2),b.addRange(l),b.addRange(m),X=2==b.rangeCount,m.detach()}for(i.removeChild(j),b.removeAllRanges(),l.detach(),h=0;c>h;++h)0==h&&f?Z?Z(b,e[h]):(a.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because browser does not support Selection.extend"),b.addRange(e[h])):b.addRange(e[h])}}(),J.selectionSupportsMultipleRanges=X,J.collapsedNonEditableSelectionsSupported=Y;var $,_=!1;T&&E(T,"createControlRange")&&($=T.createControlRange(),D.areHostProperties($,["item","add"])&&(_=!0)),J.implementsControlRange=_,z=U?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var aa;E(R,"getRangeAt")?aa=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:U&&(aa=function(b){var c=L(b.anchorNode),d=a.createRange(c);return d.setStartAndEnd(b.anchorNode,b.anchorOffset,b.focusNode,b.focusOffset),d.collapsed!==this.isCollapsed&&d.setStartAndEnd(b.focusNode,b.focusOffset,b.anchorNode,b.anchorOffset),d}),r.prototype=a.selectionPrototype;var ba=[],ca=function(a){if(a&&a instanceof r)return a.refresh(),a;a=d(a,"getNativeSelection");var b=t(a),c=y(a),e=P?f(a):null;return b?(b.nativeSelection=c,b.docSelection=e,b.refresh()):(b=new r(c,e,a),ba.push({win:a,selection:b})),b};a.getSelection=ca,a.getIframeSelection=function(c){return b.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),a.getSelection(C.getIframeWindow(c))};var da=r.prototype;if(!Q&&U&&D.areHostMethods(R,["removeAllRanges","addRange"])){da.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),j(this)};var ea=function(a,b){Z(a.nativeSelection,b),a.refresh()};W?da.addRange=function(b,d){if(_&&P&&this.docSelection.type==K)q(this,b);else if(c(d)&&V)ea(this,b);else{var e;if(X?e=this.rangeCount:(this.removeAllRanges(),e=0),this.nativeSelection.addRange(k(b).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==e+1){if(a.config.checkSelectionRanges){var f=aa(this.nativeSelection,this.rangeCount-1);f&&!N(f,b)&&(b=new G(f))}this._ranges[this.rangeCount-1]=b,h(this,b,ha(this.nativeSelection)),this.isCollapsed=z(this)}else this.refresh()}}:da.addRange=function(a,b){c(b)&&V?ea(this,a):(this.nativeSelection.addRange(k(a)),this.refresh())},da.setRanges=function(a){if(_&&a.length>1)u(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;c>b;++b)this.addRange(a[b])}}}else{if(!(E(R,"empty")&&E(S,"select")&&_&&Q))return b.fail("No means of selecting a Range or TextRange was found"),!1;da.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var a;if(this.anchorNode)a=L(this.anchorNode);else if(this.docSelection.type==K){var b=this.docSelection.createRange();b.length&&(a=L(b.item(0)))}if(a){var c=M(a).createTextRange();c.select(),this.docSelection.empty()}}}catch(d){}j(this)},da.addRange=function(b){this.docSelection.type==K?q(this,b):(a.WrappedTextRange.rangeToTextRange(b).select(),this._ranges[0]=b,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,h(this,b,!1))},da.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?u(this,a):b&&this.addRange(a[0])}}da.getRangeAt=function(a){if(0>a||a>=this.rangeCount)throw new H("INDEX_SIZE_ERR");return this._ranges[a].cloneRange()};var fa;if(Q)fa=function(b){var c;a.isSelectionValid(b.win)?c=b.docSelection.createRange():(c=M(b.win.document).createTextRange(),c.collapse(!0)),b.docSelection.type==K?p(b):n(c)?o(b,c):j(b)};else if(E(R,"getRangeAt")&&typeof R.rangeCount==B)fa=function(b){if(_&&P&&b.docSelection.type==K)p(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,b.rangeCount){for(var c=0,d=b.rangeCount;d>c;++c)b._ranges[c]=new a.WrappedRange(b.nativeSelection.getRangeAt(c));h(b,b._ranges[b.rangeCount-1],ha(b.nativeSelection)),b.isCollapsed=z(b)}else j(b)};else{if(!U||typeof R.isCollapsed!=A||typeof S.collapsed!=A||!J.implementsDomRange)return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;fa=function(a){var b,c=a.nativeSelection;c.anchorNode?(b=aa(c,0),a._ranges=[b],a.rangeCount=1,i(a),a.isCollapsed=z(a)):j(a)}}da.refresh=function(a){var b=a?this._ranges.slice(0):null,c=this.anchorNode,d=this.anchorOffset;if(fa(this),a){var e=b.length;if(e!=this._ranges.length)return!0;if(this.anchorNode!=c||this.anchorOffset!=d)return!0;for(;e--;)if(!N(b[e],this._ranges[e]))return!0;return!1}};var ga=function(a,b){var c=a.getAllRanges();a.removeAllRanges();for(var d=0,e=c.length;e>d;++d)N(b,c[d])||a.addRange(c[d]);a.rangeCount||j(a)};_?da.removeRange=function(a){if(this.docSelection.type==K){for(var b,c=this.docSelection.createRange(),d=m(a),e=L(c.item(0)),f=M(e).createControlRange(),g=!1,h=0,i=c.length;i>h;++h)b=c.item(h),b!==d||g?f.add(c.item(h)):g=!0;f.select(),p(this)}else ga(this,a)}:da.removeRange=function(a){ga(this,a)};var ha;!Q&&U&&J.implementsDomRange?(ha=g,da.isBackward=function(){return ha(this)}):ha=da.isBackward=function(){return!1},da.isBackwards=da.isBackward,da.toString=function(){for(var a=[],b=0,c=this.rangeCount;c>b;++b)a[b]=""+this._ranges[b];return a.join("")},da.collapse=function(b,c){v(this,b);var d=a.createRange(b);d.collapseToPoint(b,c),this.setSingleRange(d),this.isCollapsed=!0},da.collapseToStart=function(){if(!this.rangeCount)throw new H("INVALID_STATE_ERR");var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)},da.collapseToEnd=function(){if(!this.rangeCount)throw new H("INVALID_STATE_ERR");var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)},da.selectAllChildren=function(b){v(this,b);var c=a.createRange(b);c.selectNodeContents(b),this.setSingleRange(c)},da.deleteFromDocument=function(){if(_&&P&&this.docSelection.type==K){for(var a,b=this.docSelection.createRange();b.length;)a=b.item(0),b.remove(a),a.parentNode.removeChild(a);this.refresh()}else if(this.rangeCount){var c=this.getAllRanges();if(c.length){this.removeAllRanges();for(var d=0,e=c.length;e>d;++d)c[d].deleteContents();this.addRange(c[e-1])}}},da.eachRange=function(a,b){for(var c=0,d=this._ranges.length;d>c;++c)if(a(this.getRangeAt(c)))return b},da.getAllRanges=function(){var a=[];return this.eachRange(function(b){a.push(b)}),a},da.setSingleRange=function(a,b){this.removeAllRanges(),this.addRange(a,b)},da.callMethodOnEachRange=function(a,b){var c=[];return this.eachRange(function(d){c.push(d[a].apply(d,b))}),c},da.setStart=w(!0),da.setEnd=w(!1),a.rangePrototype.select=function(a){ca(this.getDocument()).setSingleRange(this,a)},da.changeEachRange=function(a){var b=[],c=this.isBackward();this.eachRange(function(c){a(c),b.push(c)}),this.removeAllRanges(),c&&1==b.length?this.addRange(b[0],"backward"):this.setRanges(b)},da.containsNode=function(a,b){return this.eachRange(function(c){return c.containsNode(a,b)},!0)},da.getBookmark=function(a){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[a])}},da.moveToBookmark=function(b){for(var c,d,e=[],f=0;c=b.rangeBookmarks[f++];)d=a.createRange(this.win),d.moveToBookmark(c),e.push(d);b.backward?this.setSingleRange(e[0],"backward"):this.setRanges(e)},da.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},da.getName=function(){return"WrappedSelection"},da.inspect=function(){return x(this)},da.detach=function(){t(this.win,"delete"),s(this)},r.detachAll=function(){t(null,"deleteAll")},r.inspect=x,r.isDirectionBackward=c,a.Selection=r,a.selectionPrototype=da,a.addCreateMissingNativeApiListener(function(a){"undefined"==typeof a.getSelection&&(a.getSelection=function(){return ca(a)}),a=null})}),define("rangy-core",["domReady"],function(a){return function(){var b,c;return c=function(a){var b=this.rangy;return a(function(){b.init()}),this.rangy},b=c.apply(a,arguments),b||a.rangy}}(this)),rangy.createModule("Highlighter",["ClassApplier"],function(a,b){function c(a,b){return a.characterRange.start-b.characterRange.start}function d(a,b){this.type=a,this.converterCreator=b}function e(a,b){o[a]=new d(a,b)}function f(a){var b=o[a];if(b instanceof d)return b.create();throw new Error("Highlighter type '"+a+"' is not valid")}function g(a,b){this.start=a,this.end=b}function h(a,b,c,d,e,f){e?(this.id=e,n=Math.max(n,e+1)):this.id=n++,this.characterRange=b,this.doc=a,this.classApplier=c,this.converter=d,this.containerElementId=f||null,this.applied=!1}function i(a,b){b=b||"textContent",this.doc=a||document,this.classAppliers={},this.highlights=[],this.converter=f(b)}var j=a.dom,k=j.arrayContains,l=j.getBody,m=[].forEach?function(a,b){a.forEach(b)}:function(a,b){for(var c=0,d=a.length;d>c;++c)b(a[c])},n=1,o={};d.prototype.create=function(){var a=this.converterCreator();return a.type=this.type,a},a.registerHighlighterType=e,g.prototype={intersects:function(a){return this.start<a.end&&this.end>a.start},union:function(a){return new g(Math.min(this.start,a.start),Math.max(this.end,a.end))},intersection:function(a){return new g(Math.max(this.start,a.start),Math.min(this.end,a.end))},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},g.fromCharacterRange=function(a){return new g(a.start,a.end)};var p={rangeToCharacterRange:function(a,b){var c=a.getBookmark(b);return new g(c.start,c.end)},characterRangeToRange:function(b,c,d){var e=a.createRange(b);return e.moveToBookmark({start:c.start,end:c.end,containerNode:d}),e},serializeSelection:function(a,b){for(var c=a.getAllRanges(),d=c.length,e=[],f=1==d&&a.isBackward(),g=0,h=c.length;h>g;++g)e[g]={characterRange:this.rangeToCharacterRange(c[g],b),backward:f};return e},restoreSelection:function(a,b,c){a.removeAllRanges();for(var d,e,f,g=a.win.document,h=0,i=b.length;i>h;++h)e=b[h],f=e.characterRange,d=this.characterRangeToRange(g,e.characterRange,c),a.addRange(d,e.backward)}};e("textContent",function(){return p}),e("TextRange",function(){var b;return function(){if(!b){var c=a.modules.TextRange;if(!c)throw new Error("TextRange module is missing.");if(!c.supported)throw new Error("TextRange module is present but not supported.");b={rangeToCharacterRange:function(a,b){return g.fromCharacterRange(a.toCharacterRange(b))},characterRangeToRange:function(b,c,d){var e=a.createRange(b);return e.selectCharacters(d,c.start,c.end),e},serializeSelection:function(a,b){return a.saveCharacterRanges(b)},restoreSelection:function(a,b,c){a.restoreCharacterRanges(c,b)}}}return b}}()),h.prototype={getContainerElement:function(){return this.containerElementId?this.doc.getElementById(this.containerElementId):l(this.doc)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(a){this.characterRange=this.converter.rangeToCharacterRange(a,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(a){return this.getRange().containsNodeContents(a.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.cssClass+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},i.prototype={addClassApplier:function(a){this.classAppliers[a.cssClass]=a},getHighlightForElement:function(a){for(var b=this.highlights,c=0,d=b.length;d>c;++c)if(b[c].containsElement(a))return b[c];return null},removeHighlights:function(a){for(var b,c=0,d=this.highlights.length;d>c;++c)b=this.highlights[c],k(a,b)&&(b.unapply(),this.highlights.splice(c--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(a){var b=[],c=this.highlights;this.converter;return m(a,function(a){m(c,function(c){a.intersectsRange(c.getRange())&&!k(b,c)&&b.push(c)})}),b},highlightCharacterRanges:function(b,c,d){var e,f,i,j=this.highlights,k=this.converter,l=this.doc,n=[],o=this.classAppliers[b];d=d||null;var p,q,r;d&&(p=this.doc.getElementById(d),p&&(q=a.createRange(this.doc),q.selectNodeContents(p),r=new g(0,q.toString().length),q.detach()));var s,t,u;for(e=0,f=c.length;f>e;++e){for(s=c[e],u=!1,r&&(s=s.intersection(r)),i=0;i<j.length;++i)d==j[i].containerElementId&&(t=j[i].characterRange,t.intersects(s)&&(n.push(j[i]),j[i]=new h(l,t.union(s),o,k,null,d)));u||j.push(new h(l,s,o,k,null,d))}m(n,function(a){a.unapply()});var v=[];return m(j,function(a){a.applied||(a.apply(),v.push(a))}),v},highlightRanges:function(b,c,d){var e,f=[],g=this.converter,h=d?d.id:null;return d&&(e=a.createRange(d),e.selectNodeContents(d)),m(c,function(a){var b=d?e.intersection(a):a;f.push(g.rangeToCharacterRange(b,d||l(a.getDocument())))}),this.highlightCharacterRanges(f,c,h)},highlightSelection:function(b,c,d){var e=this.converter;c=c||a.getSelection();var f=this.classAppliers[b],h=c.win.document,i=d?h.getElementById(d):l(h);if(!f)throw new Error("No class applier found for class '"+b+"'");var j=e.serializeSelection(c,i),k=[];m(j,function(a){k.push(g.fromCharacterRange(a.characterRange))});var n=this.highlightCharacterRanges(b,k,d);return e.restoreSelection(c,j,i),n},unhighlightSelection:function(b){b=b||a.getSelection();var c=this.getIntersectingHighlights(b.getAllRanges());return this.removeHighlights(c),b.removeAllRanges(),c},getHighlightsInSelection:function(b){return b=b||a.getSelection(),this.getIntersectingHighlights(b.getAllRanges())},selectionOverlapsHighlight:function(a){return this.getHighlightsInSelection(a).length>0},serialize:function(a){var b=this.highlights;b.sort(c);var d=["type:"+this.converter.type];return m(b,function(b){var c=b.characterRange,e=[c.start,c.end,b.id,b.classApplier.cssClass,b.containerElementId];a&&a.serializeHighlightText&&e.push(b.getText()),d.push(e.join("$"))}),d.join("|")},deserialize:function(a){var b,c,d,e=a.split("|"),i=[],j=e[0],k=!1;if(!j||!(b=/^type:(\w+)$/.exec(j)))throw new Error("Serialized highlights are invalid.");c=b[1],c!=this.converter.type&&(d=f(c),k=!0),e.shift();for(var m,n,o,p,q,r,s=e.length;s-->0;)r=e[s].split("$"),o=new g(+r[0],+r[1]),p=r[4]||null,q=p?this.doc.getElementById(p):l(this.doc),k&&(o=this.converter.rangeToCharacterRange(d.characterRangeToRange(this.doc,o,q),q)),m=this.classAppliers[r[3]],n=new h(this.doc,o,m,this.converter,parseInt(r[2]),p),n.apply(),i.push(n);this.highlights=i}},a.Highlighter=i,a.createHighlighter=function(a,b){return new i(a,b)}}),define("rangy-highlighter",["rangy-core"],function(a){return function(){var b;return b||a.rangy.modules.Highlighter}}(this)),rangy.createModule("ClassApplier",["WrappedSelection"],function(a,b){function c(a,b){for(var c in a)if(a.hasOwnProperty(c)&&b(c,a[c])===!1)return!1;return!0}function d(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function e(a,b){return a.className&&new RegExp("(?:^|\\s)"+b+"(?:\\s|$)").test(a.className)}function f(a,b){a.className?e(a,b)||(a.className+=" "+b):a.className=b}function g(a){return a.split(/\s+/).sort().join(" ")}function h(a){return g(a.className)}function i(a,b){return h(a)==h(b)}function j(a,b,c,d,e){var f=a.node,g=a.offset,h=f,i=g;f==d&&g>e&&++i,f!=b||g!=c&&g!=c+1||(h=d,i+=e-c),f==b&&g>c+1&&--i,a.node=h,a.offset=i}function k(a,b,c){a.node==b&&a.offset>c&&--a.offset}function l(a,b,c,d){-1==c&&(c=b.childNodes.length);for(var e,f=a.parentNode,g=H.getNodeIndex(a),h=0;e=d[h++];)j(e,f,g,b,c);b.childNodes.length==c?b.appendChild(a):b.insertBefore(a,b.childNodes[c])}function m(a,b){for(var c,d=a.parentNode,e=H.getNodeIndex(a),f=0;c=b[f++];)k(c,d,e);a.parentNode.removeChild(a)}function n(a,b,c,d,e){for(var f,g=[];f=a.firstChild;)l(f,b,c++,e),g.push(f);return d&&a.parentNode.removeChild(a),g}function o(a,b){return n(a,a.parentNode,H.getNodeIndex(a),!0,b)}function p(a,b){var c=a.cloneRange();c.selectNodeContents(b);var d=c.intersection(a),e=d?d.toString():"";return c.detach(),""!=e}function q(a){for(var b,c=a.getNodes([3]),d=0;(b=c[d])&&!p(a,b);)++d;for(var e=c.length-1;(b=c[e])&&!p(a,b);)--e;
return c.slice(d,e+1)}function r(a,b){if(a.attributes.length!=b.attributes.length)return!1;for(var c,d,e,f=0,g=a.attributes.length;g>f;++f)if(c=a.attributes[f],e=c.name,"class"!=e){if(d=b.attributes.getNamedItem(e),null===c!=(null===d))return!1;if(c.specified!=d.specified)return!1;if(c.specified&&c.nodeValue!==d.nodeValue)return!1}return!0}function s(a,b){for(var c,d=0,e=a.attributes.length;e>d;++d)if(c=a.attributes[d].name,(!b||!J(b,c))&&a.attributes[d].specified&&"class"!=c)return!0;return!1}function t(a,b){return c(b,function(b,c){if("object"==typeof c){if(!t(a[b],c))return!1}else if(a[b]!==c)return!1}),!0}function u(a){var b;return a&&1==a.nodeType&&((b=a.parentNode)&&9==b.nodeType&&"on"==b.designMode||N(a)&&!N(a.parentNode))}function v(a){return(N(a)||1!=a.nodeType&&N(a.parentNode))&&!u(a)}function w(a){return a&&1==a.nodeType&&!O.test(M(a,"display"))}function x(a){if(0==a.data.length)return!0;if(P.test(a.data))return!1;var b=M(a.parentNode,"whiteSpace");switch(b){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(a.data))return!1}return w(a.previousSibling)||w(a.nextSibling)}function y(a){var b,c,d=[];for(b=0;c=a[b++];)d.push(new I(c.startContainer,c.startOffset),new I(c.endContainer,c.endOffset));return d}function z(a,b){for(var c,d,e,f=0,g=a.length;g>f;++f)c=a[f],d=b[2*f],e=b[2*f+1],c.setStartAndEnd(d.node,d.offset,e.node,e.offset)}function A(a,b){return H.isCharacterDataNode(a)?0==b?!!a.previousSibling:b==a.length?!!a.nextSibling:!0:b>0&&b<a.childNodes.length}function B(a,c,d,e){var f,g,h=0==d;if(H.isAncestorOf(c,a))return a;if(H.isCharacterDataNode(c)){var i=H.getNodeIndex(c);if(0==d)d=i;else{if(d!=c.length)throw b.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+d+" in "+c.data);d=i+1}c=c.parentNode}if(A(c,d)){f=c.cloneNode(!1),g=c.parentNode,f.id&&f.removeAttribute("id");for(var j,k=0;j=c.childNodes[d];)l(j,f,k++,e);return l(f,g,H.getNodeIndex(c)+1,e),c==a?f:B(a,g,H.getNodeIndex(f),e)}if(a!=c){f=c.parentNode;var m=H.getNodeIndex(c);return h||m++,B(a,f,m,e)}return a}function C(a,b){return a.tagName==b.tagName&&i(a,b)&&r(a,b)&&"inline"==M(a,"display")&&"inline"==M(b,"display")}function D(a){var b=a?"nextSibling":"previousSibling";return function(c,d){var e=c.parentNode,f=c[b];if(f){if(f&&3==f.nodeType)return f}else if(d&&(f=e[b],f&&1==f.nodeType&&C(e,f))){var g=f[a?"firstChild":"lastChild"];if(g&&3==g.nodeType)return g}return null}}function E(a){this.isElementMerge=1==a.nodeType,this.textNodes=[];var b=this.isElementMerge?a.lastChild:a;b&&(this.textNodes[0]=b)}function F(a,b,e){var f,g,h,i,j=this;j.cssClass=a;var k=null,l={};if("object"==typeof b&&null!==b){for(e=b.tagNames,k=b.elementProperties,l=b.elementAttributes,g=0;i=S[g++];)b.hasOwnProperty(i)&&(j[i]=b[i]);f=b.normalize}else f=b;j.normalize="undefined"==typeof f?!0:f,j.attrExceptions=[];var m=document.createElementNS("http://www.w3.org/1999/xhtml",j.elementTagName);j.elementProperties=j.copyPropertiesToElement(k,m,!0),c(l,function(a){j.attrExceptions.push(a)}),j.elementAttributes=l,j.elementSortedClassName=j.elementProperties.hasOwnProperty("className")?j.elementProperties.className:a,j.applyToAnyTagName=!1;var n=typeof e;if("string"==n)"*"==e?j.applyToAnyTagName=!0:j.tagNames=d(e.toLowerCase()).split(/\s*,\s*/);else if("object"==n&&"number"==typeof e.length)for(j.tagNames=[],g=0,h=e.length;h>g;++g)"*"==e[g]?j.applyToAnyTagName=!0:j.tagNames.push(e[g].toLowerCase());else j.tagNames=[j.elementTagName]}function G(a,b,c){return new F(a,b,c)}var H=a.dom,I=H.DomPosition,J=H.arrayContains,K="span",L=function(){function a(a,b,c){return b&&c?" ":""}return function(b,c){b.className&&(b.className=b.className.replace(new RegExp("(^|\\s)"+c+"(\\s|$)"),a))}}(),M=H.getComputedStyleProperty,N=function(){var a=document.createElementNS("http://www.w3.org/1999/xhtml","div");return"boolean"==typeof a.isContentEditable?function(a){return a&&1==a.nodeType&&a.isContentEditable}:function(a){return a&&1==a.nodeType&&"false"!=a.contentEditable?"true"==a.contentEditable||N(a.parentNode):!1}}(),O=/^inline(-block|-table)?$/i,P=/[^\r\n\t\f \u200B]/,Q=D(!1),R=D(!0);E.prototype={doMerge:function(a){var b=this.textNodes,c=b[0];if(b.length>1){for(var d,e,f,g,h=[],i=0,j=0,k=b.length;k>j;++j){if(d=b[j],e=d.parentNode,j>0&&(e.removeChild(d),e.hasChildNodes()||e.parentNode.removeChild(e),a))for(f=0;g=a[f++];)g.node==d&&(g.node=c,g.offset+=i);h[j]=d.data,i+=d.data.length}c.data=h.join("")}return c.data},getLength:function(){for(var a=this.textNodes.length,b=0;a--;)b+=this.textNodes[a].length;return b},toString:function(){for(var a=[],b=0,c=this.textNodes.length;c>b;++b)a[b]="'"+this.textNodes[b].data+"'";return"[Merge("+a.join(",")+")]"}};var S=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],T={};F.prototype={elementTagName:K,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(a,b,c){var d,e,h,i,j,k,l={};for(var m in a)if(a.hasOwnProperty(m))if(i=a[m],j=b[m],"className"==m)f(b,i),f(b,this.cssClass),b[m]=g(b[m]),c&&(l[m]=b[m]);else if("style"==m){e=j,c&&(l[m]=h={});for(d in a[m])e[d]=i[d],c&&(h[d]=e[d]);this.attrExceptions.push(m)}else b[m]=i,c&&(l[m]=b[m],k=T.hasOwnProperty(m)?T[m]:m,this.attrExceptions.push(k));return c?l:""},copyAttributesToElement:function(a,b){for(var c in a)a.hasOwnProperty(c)&&b.setAttribute(c,a[c])},hasClass:function(a){return 1==a.nodeType&&J(this.tagNames,a.tagName.toLowerCase())&&e(a,this.cssClass)},getSelfOrAncestorWithClass:function(a){for(;a;){if(this.hasClass(a))return a;a=a.parentNode}return null},isModifiable:function(a){return!this.applyToEditableOnly||v(a)},isIgnorableWhiteSpaceNode:function(a){return this.ignoreWhiteSpace&&a&&3==a.nodeType&&x(a)},postApply:function(a,b,c,d){for(var e,f,g,h=a[0],i=a[a.length-1],j=[],k=h,l=i,m=0,n=i.length,o=0,p=a.length;p>o;++o)f=a[o],g=Q(f,!d),g?(e||(e=new E(g),j.push(e)),e.textNodes.push(f),f===h&&(k=e.textNodes[0],m=k.length),f===i&&(l=e.textNodes[0],n=e.getLength())):e=null;var q=R(i,!d);if(q&&(e||(e=new E(i),j.push(e)),e.textNodes.push(q)),j.length){for(o=0,p=j.length;p>o;++o)j[o].doMerge(c);b.setStartAndEnd(k,m,l,n)}},createContainer:function(a){var b=a.createElementNS("http://www.w3.org/1999/xhtml",this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,b,!1),this.copyAttributesToElement(this.elementAttributes,b),f(b,this.cssClass),this.onElementCreate&&this.onElementCreate(b,this),b},applyToTextNode:function(a,b){var c=a.parentNode;if(1==c.childNodes.length&&this.useExistingElements&&J(this.tagNames,c.tagName.toLowerCase())&&t(c,this.elementProperties))f(c,this.cssClass);else{var d=this.createContainer(H.getDocument(a));a.parentNode.insertBefore(d,a),d.appendChild(a)}},isRemovable:function(a){return a.tagName.toLowerCase()==this.elementTagName&&h(a)==this.elementSortedClassName&&t(a,this.elementProperties)&&!s(a,this.attrExceptions)&&this.isModifiable(a)},isEmptyContainer:function(a){var b=a.childNodes.length;return 1==a.nodeType&&this.isRemovable(a)&&(0==b||1==b&&this.isEmptyContainer(a.firstChild))},removeEmptyContainers:function(a){for(var b,c=this,d=a.getNodes([1],function(a){return c.isEmptyContainer(a)}),e=[a],f=y(e),g=0;b=d[g++];)m(b,f);z(e,f)},undoToTextNode:function(a,b,c,d){if(!b.containsNode(c)){var e=b.cloneRange();e.selectNode(c),e.isPointInRange(b.endContainer,b.endOffset)&&(B(c,b.endContainer,b.endOffset,d),b.setEndAfter(c)),e.isPointInRange(b.startContainer,b.startOffset)&&(c=B(c,b.startContainer,b.startOffset,d))}this.isRemovable(c)?o(c,d):L(c,this.cssClass)},applyToRange:function(a,b){b=b||[];var c=y(b||[]);a.splitBoundariesPreservingPositions(c),this.removeEmptyElements&&this.removeEmptyContainers(a);var d=q(a);if(d.length){for(var e,f=0;e=d[f++];)this.isIgnorableWhiteSpaceNode(e)||this.getSelfOrAncestorWithClass(e)||!this.isModifiable(e)||this.applyToTextNode(e,c);e=d[d.length-1],a.setStartAndEnd(d[0],0,e,e.length),this.normalize&&this.postApply(d,a,c,!1),z(b,c)}},applyToRanges:function(a){for(var b=a.length;b--;)this.applyToRange(a[b],a);return a},applyToSelection:function(b){var c=a.getSelection(b);c.setRanges(this.applyToRanges(c.getAllRanges()))},undoToRange:function(a,b){b=b||[];var c=y(b);a.splitBoundariesPreservingPositions(c),this.removeEmptyElements&&this.removeEmptyContainers(a,c);var d,e,f=q(a),g=f[f.length-1];if(f.length){for(var h=0,i=f.length;i>h;++h)d=f[h],e=this.getSelfOrAncestorWithClass(d),e&&this.isModifiable(d)&&this.undoToTextNode(d,a,e,c),a.setStartAndEnd(f[0],0,g,g.length);this.normalize&&this.postApply(f,a,c,!0),z(b,c)}},undoToRanges:function(a){for(var b=a.length;b--;)this.undoToRange(a[b],a);return a},undoToSelection:function(b){var c=a.getSelection(b),d=a.getSelection(b).getAllRanges();this.undoToRanges(d),c.setRanges(d)},isAppliedToRange:function(a){if(a.collapsed||""==a.toString())return!!this.getSelfOrAncestorWithClass(a.commonAncestorContainer);var b=a.getNodes([3]);if(b.length)for(var c,d=0;c=b[d++];)if(!this.isIgnorableWhiteSpaceNode(c)&&p(a,c)&&this.isModifiable(c)&&!this.getSelfOrAncestorWithClass(c))return!1;return!0},isAppliedToRanges:function(a){var b=a.length;if(0==b)return!1;for(;b--;)if(!this.isAppliedToRange(a[b]))return!1;return!0},isAppliedToSelection:function(b){var c=a.getSelection(b);return this.isAppliedToRanges(c.getAllRanges())},toggleRange:function(a){this.isAppliedToRange(a)?this.undoToRange(a):this.applyToRange(a)},toggleSelection:function(a){this.isAppliedToSelection(a)?this.undoToSelection(a):this.applyToSelection(a)},getElementsWithClassIntersectingRange:function(a){var b=[],c=this;return a.getNodes([3],function(a){var d=c.getSelfOrAncestorWithClass(a);d&&!J(b,d)&&b.push(d)}),b},detach:function(){}},F.util={hasClass:e,addClass:f,removeClass:L,hasSameClasses:i,replaceWithOwnChildren:o,elementsHaveSameNonClassAttributes:r,elementHasNonClassAttributes:s,splitNodeAt:B,isEditableElement:N,isEditingHost:u,isEditable:v},a.CssClassApplier=a.ClassApplier=F,a.createCssClassApplier=a.createClassApplier=G}),define("rangy-cssclassapplier",["rangy-core"],function(a){return function(){var b;return b||a.rangy.modules.ClassApplier}}(this)),rangy.createModule("TextRange",["WrappedSelection"],function(a,b){function c(a,b){function c(b,c,d){for(var e=a.slice(b,c),f={isWord:d,chars:e,toString:function(){return e.join("")}},g=0,i=e.length;i>g;++g)e[g].token=f;h.push(f)}for(var d,e,f,g=a.join(""),h=[],i=0;d=b.wordRegex.exec(g);){if(e=d.index,f=e+d[0].length,e>i&&c(i,e,!1),b.includeTrailingSpace)for(;X.test(a[f]);)++f;c(e,f,!0),i=f}return i<a.length&&c(i,a.length,!1),h}function d(a,b){if(a){var c={};return S(c,b),S(c,a),c}return b}function e(a){var b,c;return a?(b=a.language||Y,c={},S(c,fa[b]||fa[Y]),S(c,a),c):fa[Y]}function f(a){return d(a,da)}function g(a){return d(a,ea)}function h(a,b){var c=ka(a,"display",b),d=a.tagName.toLowerCase();return"block"==c&&ca&&la.hasOwnProperty(d)?la[d]:c}function i(a){for(var b=n(a),c=0,d=b.length;d>c;++c)if(1==b[c].nodeType&&"none"==h(b[c]))return!0;return!1}function j(a){var b;return 3==a.nodeType&&(b=a.parentNode)&&"hidden"==ka(b,"visibility")}function k(a){return a&&(1==a.nodeType&&!/^(inline(-block|-table)?|none)$/.test(h(a))||9==a.nodeType||11==a.nodeType)}function l(a){return Q.isCharacterDataNode(a)||!/^(area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$/i.test(a.nodeName)}function m(a){for(var b=[];a.parentNode;)b.unshift(a.parentNode),a=a.parentNode;return b}function n(a){return m(a).concat([a])}function o(a){for(;a&&!a.nextSibling;)a=a.parentNode;return a?a.nextSibling:null}function p(a,b){return!b&&a.hasChildNodes()?a.firstChild:o(a)}function q(a){var b=a.previousSibling;if(b){for(a=b;a.hasChildNodes();)a=a.lastChild;return a}var c=a.parentNode;return c&&1==c.nodeType?c:null}function r(a){if(!a||3!=a.nodeType)return!1;var b=a.data;if(""===b)return!0;var c=a.parentNode;if(!c||1!=c.nodeType)return!1;var d=ka(a.parentNode,"whiteSpace");return/^[\t\n\r ]+$/.test(b)&&/^(normal|nowrap)$/.test(d)||/^[\t\r ]+$/.test(b)&&"pre-line"==d}function s(a){if(""===a.data)return!0;if(!r(a))return!1;var b=a.parentNode;return b?i(a)?!0:!1:!0}function t(a){var b=a.nodeType;return 7==b||8==b||i(a)||/^(script|style)$/i.test(a.nodeName)||j(a)||s(a)}function u(a,b){var c=a.nodeType;return 7==c||8==c||1==c&&"none"==h(a,b)}function v(){this.store={}}function w(a,b,c){return function(d){var e=this.cache;if(e.hasOwnProperty(a))return ma++,e[a];na++;var f=b.call(this,c?this[c]:this,d);return e[a]=f,f}}function x(a,b){this.node=a,this.session=b,this.cache=new v,this.positions=new v}function y(a,b){this.offset=b,this.nodeWrapper=a,this.node=a.node,this.session=a.session,this.cache=new v}function z(){return"[Position("+Q.inspectNode(this.node)+":"+this.offset+")]"}function A(){return C(),za=new Aa}function B(){return za||A()}function C(){za&&za.detach(),za=null}function D(a,c,d,e){function f(){var a=null;return c?(a=h,i||(h=h.previousVisible(),i=!h||d&&h.equals(d))):i||(a=h=h.nextVisible(),i=!h||d&&h.equals(d)),i&&(h=null),a}d&&(c?t(d.node)&&(d=a.previousVisible()):t(d.node)&&(d=d.nextVisible()));var g,h=a,i=!1,j=!1;return{next:function(){if(j)return j=!1,g;for(var a,b;a=f();)if(b=a.getCharacter(e))return g=a,a;return null},rewind:function(){if(!g)throw b.createError("createCharacterIterator: cannot rewind. Only one position can be rewound.");j=!0},dispose:function(){a=d=null}}}function E(a,b,c){function d(a){for(var b,c,d=[],g=a?e:f,h=!1,i=!1;b=g.next();){if(c=b.character,W.test(c))i&&(i=!1,h=!0);else{if(h){g.rewind();break}i=!0}d.push(b)}return d}var e=D(a,!1,null,b),f=D(a,!0,null,b),g=c.tokenizer,h=d(!0),i=d(!1).reverse(),j=g(i.concat(h),c),k=h.length?j.slice(Ba(j,h[0].token)):[],l=i.length?j.slice(0,Ba(j,i.pop().token)+1):[];return{nextEndToken:function(){for(var a,b;1==k.length&&!(a=k[0]).isWord&&(b=d(!0)).length>0;)k=g(a.chars.concat(b),c);return k.shift()},previousStartToken:function(){for(var a,b;1==l.length&&!(a=l[0]).isWord&&(b=d(!1)).length>0;)l=g(b.reverse().concat(a.chars),c);return l.pop()},dispose:function(){e.dispose(),f.dispose(),k=l=null}}}function F(a,b,c,d,e){var f,g,h,i,j=0,k=a,l=Math.abs(c);if(0!==c){var m=0>c;switch(b){case O:for(g=D(a,m,null,d);(f=g.next())&&l>j;)++j,k=f;h=f,g.dispose();break;case P:for(var n=E(a,d,e),o=m?n.previousStartToken:n.nextEndToken;(i=o())&&l>j;)i.isWord&&(++j,k=m?i.chars[0]:i.chars[i.chars.length-1]);break;default:throw new Error("movePositionBy: unit '"+b+"' not implemented")}m?(k=k.previousVisible(),j=-j):k&&k.isLeadingSpace&&(b==P&&(g=D(a,!1,null,d),h=g.next(),g.dispose()),h&&(k=h.previousVisible()))}return{position:k,unitsMoved:j}}function G(a,b,c,d){var e=a.getRangeBoundaryPosition(b,!0),f=a.getRangeBoundaryPosition(b,!1),g=d?f:e,h=d?e:f;return D(g,!!d,h,c)}function H(a,b,c){for(var d,e=[],f=G(a,b,c);d=f.next();)e.push(d);return f.dispose(),e}function I(b,c,d){var e=a.createRange(b.node);e.setStartAndEnd(b.node,b.offset,c.node,c.offset);var f=!e.expand("word",d);return e.detach(),f}function J(a,b,c,d,e){function f(a,b){var c=p[a].previousVisible(),d=p[b-1],f=!e.wholeWordsOnly||I(c,d,e.wordOptions);return{startPos:c,endPos:d,valid:f}}for(var g,h,i,j,k,l,m=Z(e.direction),n=D(a,m,a.session.getRangeBoundaryPosition(d,m),e),o="",p=[],q=null;g=n.next();)if(h=g.character,c||e.caseSensitive||(h=h.toLowerCase()),m?(p.unshift(g),o=h+o):(p.push(g),o+=h),c){if(k=b.exec(o))if(l){if(i=k.index,j=i+k[0].length,!m&&j<o.length||m&&i>0){q=f(i,j);break}}else l=!0}else if(-1!=(i=o.indexOf(b))){q=f(i,i+b.length);break}return l&&(q=f(i,j)),n.dispose(),q}function K(a){return function(){var b=!!za,c=B(),d=[c].concat(R.toArray(arguments)),e=a.apply(this,d);return b||C(),e}}function L(a,b){return K(function(c,g,h,i){"undefined"==typeof h&&(h=g,g=O),i=d(i,ha);var j=f(i.characterOptions),k=e(i.wordOptions),l=a;b&&(l=h>=0,this.collapse(!l));var m=F(c.getRangeBoundaryPosition(this,l),g,h,j,k),n=m.position;return this[l?"setStart":"setEnd"](n.node,n.offset),m.unitsMoved})}function M(a){return K(function(b,c){c=f(c);for(var d,e=G(b,this,c,!a),g=0;(d=e.next())&&W.test(d.character);)++g;e.dispose();var h=g>0;return h&&this[a?"moveStart":"moveEnd"]("character",a?g:-g,{characterOptions:c}),h})}function N(a){return K(function(b,c){var d=!1;return this.changeEachRange(function(b){d=b[a](c)||d}),d})}var O="character",P="word",Q=a.dom,R=a.util,S=R.extend,T=Q.getBody,U=/^[ \t\f\r\n]+$/,V=/^[ \t\f\r]+$/,W=/^[\t-\r \u0085\u00A0\u1680\u180E\u2000-\u200B\u2028\u2029\u202F\u205F\u3000]+$/,X=/^[\t \u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000]+$/,Y="en",Z=a.Selection.isDirectionBackward,$=!1,_=!1,aa=!1,ba=!0;!function(){var b=document.createElementNS("http://www.w3.org/1999/xhtml","div");b.contentEditable="true",b.innerHTML="<p>1 </p><p></p>";var c=T(document),d=b.firstChild,e=a.getSelection();c.appendChild(b),e.collapse(d.lastChild,2),e.setStart(d.firstChild,0),$=1==(""+e).length,b.innerHTML="1 <br>",e.collapse(b,2),e.setStart(b.firstChild,0),_=1==(""+e).length,b.innerHTML="1 <p>1</p>",e.collapse(b,2),e.setStart(b.firstChild,0),aa=1==(""+e).length,c.removeChild(b),e.removeAllRanges()}();var ca,da={includeBlockContentTrailingSpace:!0,includeSpaceBeforeBr:!0,includeSpaceBeforeBlock:!0,includePreLineTrailingSpace:!0},ea={includeBlockContentTrailingSpace:!ba,includeSpaceBeforeBr:!_,includeSpaceBeforeBlock:!aa,includePreLineTrailingSpace:!0},fa={en:{wordRegex:/[a-z0-9]+('[a-z0-9]+)*/gi,includeTrailingSpace:!1,tokenizer:c}},ga={caseSensitive:!1,withinRange:null,wholeWordsOnly:!1,wrap:!1,direction:"forward",wordOptions:null,characterOptions:null},ha={wordOptions:null,characterOptions:null},ia={wordOptions:null,characterOptions:null,trim:!1,trimStart:!0,trimEnd:!0},ja={wordOptions:null,characterOptions:null,direction:"forward"},ka=Q.getComputedStyleProperty;!function(){var a=document.createElementNS("http://www.w3.org/1999/xhtml","table"),b=T(document);b.appendChild(a),ca="block"==ka(a,"display"),b.removeChild(a)}(),a.features.tableCssDisplayBlock=ca;var la={table:"table",caption:"table-caption",colgroup:"table-column-group",col:"table-column",thead:"table-header-group",tbody:"table-row-group",tfoot:"table-footer-group",tr:"table-row",td:"table-cell",th:"table-cell"};v.prototype={get:function(a){return this.store.hasOwnProperty(a)?this.store[a]:null},set:function(a,b){return this.store[a]=b}};var ma=0,na=0,oa={getPosition:function(a){var b=this.positions;return b.get(a)||b.set(a,new y(this,a))},toString:function(){return"[NodeWrapper("+Q.inspectNode(this.node)+")]"}};x.prototype=oa;var pa="EMPTY",qa="NON_SPACE",ra="UNCOLLAPSIBLE_SPACE",sa="COLLAPSIBLE_SPACE",ta="TRAILING_SPACE_BEFORE_BLOCK",ua="TRAILING_SPACE_IN_BLOCK",va="TRAILING_SPACE_BEFORE_BR",wa="PRE_LINE_TRAILING_SPACE_BEFORE_LINE_BREAK",xa="TRAILING_LINE_BREAK_AFTER_BR";S(oa,{isCharacterDataNode:w("isCharacterDataNode",Q.isCharacterDataNode,"node"),getNodeIndex:w("nodeIndex",Q.getNodeIndex,"node"),getLength:w("nodeLength",Q.getNodeLength,"node"),containsPositions:w("containsPositions",l,"node"),isWhitespace:w("isWhitespace",r,"node"),isCollapsedWhitespace:w("isCollapsedWhitespace",s,"node"),getComputedDisplay:w("computedDisplay",h,"node"),isCollapsed:w("collapsed",t,"node"),isIgnored:w("ignored",u,"node"),next:w("nextPos",p,"node"),previous:w("previous",q,"node"),getTextNodeInfo:w("textNodeInfo",function(a){var b=null,c=!1,d=ka(a.parentNode,"whiteSpace"),e="pre-line"==d;return e?(b=V,c=!0):("normal"==d||"nowrap"==d)&&(b=U,c=!0),{node:a,text:a.data,spaceRegex:b,collapseSpaces:c,preLine:e}},"node"),hasInnerText:w("hasInnerText",function(a,b){for(var c=this.session,d=c.getPosition(a.parentNode,this.getNodeIndex()+1),e=c.getPosition(a,0),f=b?d:e,g=b?e:d;f!==g;){if(f.prepopulateChar(),f.isDefinitelyNonEmpty())return!0;f=b?f.previousVisible():f.nextVisible()}return!1},"node"),isRenderedBlock:w("isRenderedBlock",function(a){for(var b=a.getElementsByTagName("br"),c=0,d=b.length;d>c;++c)if(!t(b[c]))return!0;return this.hasInnerText()},"node"),getTrailingSpace:w("trailingSpace",function(a){if("br"==a.tagName.toLowerCase())return"";switch(this.getComputedDisplay()){case"inline":for(var b=a.lastChild;b;){if(!u(b))return 1==b.nodeType?this.session.getNodeWrapper(b).getTrailingSpace():"";b=b.previousSibling}break;case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":break;case"table-cell":return"	";default:return this.isRenderedBlock(!0)?"\n":""}return""},"node"),getLeadingSpace:w("leadingSpace",function(a){switch(this.getComputedDisplay()){case"inline":case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":case"table-cell":break;default:return this.isRenderedBlock(!1)?"\n":""}return""},"node")});var ya={character:"",characterType:pa,isBr:!1,prepopulateChar:function(){var a=this;if(!a.prepopulatedChar){var b=a.node,c=a.offset,d="",e=pa,f=!1;if(c>0)if(3==b.nodeType){var g=b.data,h=g.charAt(c-1),i=a.nodeWrapper.getTextNodeInfo(),j=i.spaceRegex;i.collapseSpaces?j.test(h)?c>1&&j.test(g.charAt(c-2))||(i.preLine&&"\n"===g.charAt(c)?(d=" ",e=wa):(d=" ",e=sa)):(d=h,e=qa,f=!0):(d=h,e=ra,f=!0)}else{var k=b.childNodes[c-1];if(k&&1==k.nodeType&&!t(k)&&("br"==k.tagName.toLowerCase()?(d="\n",a.isBr=!0,e=sa,f=!1):a.checkForTrailingSpace=!0),!d){var l=b.childNodes[c];l&&1==l.nodeType&&!t(l)&&(a.checkForLeadingSpace=!0)}}a.prepopulatedChar=!0,a.character=d,a.characterType=e,a.isCharInvariant=f}},isDefinitelyNonEmpty:function(){var a=this.characterType;return a==qa||a==ra},resolveLeadingAndTrailingSpaces:function(){if(this.prepopulatedChar||this.prepopulateChar(),this.checkForTrailingSpace){var a=this.session.getNodeWrapper(this.node.childNodes[this.offset-1]).getTrailingSpace();a&&(this.isTrailingSpace=!0,this.character=a,this.characterType=sa),this.checkForTrailingSpace=!1}if(this.checkForLeadingSpace){var b=this.session.getNodeWrapper(this.node.childNodes[this.offset]).getLeadingSpace();b&&(this.isLeadingSpace=!0,this.character=b,this.characterType=sa),this.checkForLeadingSpace=!1}},getPrecedingUncollapsedPosition:function(a){for(var b,c=this;c=c.previousVisible();)if(b=c.getCharacter(a),""!==b)return c;return null},getCharacter:function(a){function b(){return i||(f=j.getPrecedingUncollapsedPosition(a),i=!0),f}if(this.resolveLeadingAndTrailingSpaces(),this.isCharInvariant)return this.character;var c=["character",a.includeSpaceBeforeBr,a.includeBlockContentTrailingSpace,a.includePreLineTrailingSpace].join("_"),d=this.cache.get(c);if(null!==d)return d;var e,f,g="",h=this.characterType==sa,i=!1,j=this;return h?(" "!=this.character||b()&&!f.isTrailingSpace&&"\n"!=f.character)&&("\n"==this.character&&this.isLeadingSpace?b()&&"\n"!=f.character&&(g="\n"):(e=this.nextUncollapsed(),e&&(e.isBr?this.type=va:e.isTrailingSpace&&"\n"==e.character?this.type=ua:e.isLeadingSpace&&"\n"==e.character&&(this.type=ta),"\n"===e.character?(this.type!=va||a.includeSpaceBeforeBr)&&(this.type!=ta||a.includeSpaceBeforeBlock)&&(this.type==ua&&e.isTrailingSpace&&!a.includeBlockContentTrailingSpace||(this.type!=wa||e.type!=qa||a.includePreLineTrailingSpace)&&("\n"===this.character?e.isTrailingSpace?this.isTrailingSpace||this.isBr&&(e.type=xa,b()&&f.isLeadingSpace&&"\n"==f.character&&(e.character="")):g="\n":" "===this.character&&(g=" "))):g=this.character))):"\n"===this.character&&(!(e=this.nextUncollapsed())||e.isTrailingSpace),this.cache.set(c,g),g},equals:function(a){return!!a&&this.node===a.node&&this.offset===a.offset},inspect:z,toString:function(){return this.character}};y.prototype=ya,S(ya,{next:w("nextPos",function(a){var b=a.nodeWrapper,c=a.node,d=a.offset,e=b.session;if(!c)return null;var f,g,h;return d==b.getLength()?(f=c.parentNode,g=f?b.getNodeIndex()+1:0):b.isCharacterDataNode()?(f=c,g=d+1):(h=c.childNodes[d],e.getNodeWrapper(h).containsPositions()?(f=h,g=0):(f=c,g=d+1)),f?e.getPosition(f,g):null}),previous:w("previous",function(a){var b,c,d,e=a.nodeWrapper,f=a.node,g=a.offset,h=e.session;return 0==g?(b=f.parentNode,c=b?e.getNodeIndex():0):e.isCharacterDataNode()?(b=f,c=g-1):(d=f.childNodes[g-1],h.getNodeWrapper(d).containsPositions()?(b=d,c=Q.getNodeLength(d)):(b=f,c=g-1)),b?h.getPosition(b,c):null}),nextVisible:w("nextVisible",function(a){var b=a.next();if(!b)return null;var c=b.nodeWrapper,d=b.node,e=b;return c.isCollapsed()&&(e=c.session.getPosition(d.parentNode,c.getNodeIndex()+1)),e}),nextUncollapsed:w("nextUncollapsed",function(a){for(var b=a;b=b.nextVisible();)if(b.resolveLeadingAndTrailingSpaces(),""!==b.character)return b;return null}),previousVisible:w("previousVisible",function(a){var b=a.previous();if(!b)return null;var c=b.nodeWrapper,d=b.node,e=b;return c.isCollapsed()&&(e=c.session.getPosition(d.parentNode,c.getNodeIndex())),e})});var za=null,Aa=function(){function a(a){var b=new v;return{get:function(c){var d=b.get(c[a]);if(d)for(var e,f=0;e=d[f++];)if(e.node===c)return e;return null},set:function(c){var d=c.node[a],e=b.get(d)||b.set(d,[]);e.push(c)}}}function b(){this.initCaches()}var c=R.isHostProperty(document.documentElement,"uniqueID");return b.prototype={initCaches:function(){this.elementCache=c?function(){var a=new v;return{get:function(b){return a.get(b.uniqueID)},set:function(b){a.set(b.node.uniqueID,b)}}}():a("tagName"),this.textNodeCache=a("data"),this.otherNodeCache=a("nodeName")},getNodeWrapper:function(a){var b;switch(a.nodeType){case 1:b=this.elementCache;break;case 3:b=this.textNodeCache;break;default:b=this.otherNodeCache}var c=b.get(a);return c||(c=new x(a,this),b.set(c)),c},getPosition:function(a,b){return this.getNodeWrapper(a).getPosition(b)},getRangeBoundaryPosition:function(a,b){var c=b?"start":"end";return this.getPosition(a[c+"Container"],a[c+"Offset"])},detach:function(){this.elementCache=this.textNodeCache=this.otherNodeCache=null}},b}();S(Q,{nextNode:p,previousNode:q});var Ba=Array.prototype.indexOf?function(a,b){return a.indexOf(b)}:function(a,b){for(var c=0,d=a.length;d>c;++c)if(a[c]===b)return c;return-1};S(a.rangePrototype,{moveStart:L(!0,!1),moveEnd:L(!1,!1),move:L(!0,!0),trimStart:M(!0),trimEnd:M(!1),trim:K(function(a,b){var c=this.trimStart(b),d=this.trimEnd(b);return c||d}),expand:K(function(a,b,c){var g=!1;c=d(c,ia);var h=f(c.characterOptions);if(b||(b=O),b==P){var i,j,k=e(c.wordOptions),l=a.getRangeBoundaryPosition(this,!0),m=a.getRangeBoundaryPosition(this,!1),n=E(l,h,k),o=n.nextEndToken(),p=o.chars[0].previousVisible();if(this.collapsed)i=o;else{var q=E(m,h,k);i=q.previousStartToken()}return j=i.chars[i.chars.length-1],p.equals(l)||(this.setStart(p.node,p.offset),g=!0),j&&!j.equals(m)&&(this.setEnd(j.node,j.offset),g=!0),c.trim&&(c.trimStart&&(g=this.trimStart(h)||g),c.trimEnd&&(g=this.trimEnd(h)||g)),g}return this.moveEnd(O,1,c)}),text:K(function(a,b){return this.collapsed?"":H(a,this,f(b)).join("")}),selectCharacters:K(function(a,b,c,d,e){var f={characterOptions:e};b||(b=T(this.getDocument())),this.selectNodeContents(b),this.collapse(!0),this.moveStart("character",c,f),this.collapse(!0),this.moveEnd("character",d-c,f)}),toCharacterRange:K(function(a,b,c){b||(b=T(this.getDocument()));var d,e,f=b.parentNode,g=Q.getNodeIndex(b),h=-1==Q.comparePoints(this.startContainer,this.endContainer,f,g),i=this.cloneRange();return h?(i.setStartAndEnd(this.startContainer,this.startOffset,f,g),d=-i.text(c).length):(i.setStartAndEnd(f,g,this.startContainer,this.startOffset),d=i.text(c).length),e=d+this.text(c).length,{start:d,end:e}}),findText:K(function(b,c,f){f=d(f,ga),f.wholeWordsOnly&&(f.wordOptions=e(f.wordOptions),f.wordOptions.includeTrailingSpace=!1);var g=Z(f.direction),h=f.withinRange;h||(h=a.createRange(),h.selectNodeContents(this.getDocument()));var i=c,j=!1;"string"==typeof i?f.caseSensitive||(i=i.toLowerCase()):j=!0;var k=b.getRangeBoundaryPosition(this,!g),l=h.comparePoint(k.node,k.offset);-1===l?k=b.getRangeBoundaryPosition(h,!0):1===l&&(k=b.getRangeBoundaryPosition(h,!1));for(var m,n=k,o=!1;;)if(m=J(n,i,j,h,f)){if(m.valid)return this.setStartAndEnd(m.startPos.node,m.startPos.offset,m.endPos.node,m.endPos.offset),!0;n=g?m.startPos:m.endPos}else{if(!f.wrap||o)return!1;h=h.cloneRange(),n=b.getRangeBoundaryPosition(h,!g),h.setBoundary(k.node,k.offset,g),o=!0}}),pasteHtml:function(a){if(this.deleteContents(),a){var b=this.createContextualFragment(a),c=b.lastChild;this.insertNode(b),this.collapseAfter(c)}}}),S(a.selectionPrototype,{expand:K(function(a,b,c){this.changeEachRange(function(a){a.expand(b,c)})}),move:K(function(a,b,c,d){var e=0;if(this.focusNode){this.collapse(this.focusNode,this.focusOffset);var f=this.getRangeAt(0);d||(d={}),d.characterOptions=g(d.characterOptions),e=f.move(b,c,d),this.setSingleRange(f)}return e}),trimStart:N("trimStart"),trimEnd:N("trimEnd"),trim:N("trim"),selectCharacters:K(function(b,c,d,e,f,g){var h=a.createRange(c);h.selectCharacters(c,d,e,g),this.setSingleRange(h,f)}),saveCharacterRanges:K(function(a,b,c){for(var d=this.getAllRanges(),e=d.length,f=[],g=1==e&&this.isBackward(),h=0,i=d.length;i>h;++h)f[h]={characterRange:d[h].toCharacterRange(b,c),backward:g,characterOptions:c};return f}),restoreCharacterRanges:K(function(b,c,d){this.removeAllRanges();for(var e,f,g,h=0,i=d.length;i>h;++h)f=d[h],g=f.characterRange,e=a.createRange(c),e.selectCharacters(c,g.start,g.end,f.characterOptions),this.addRange(e,f.backward)}),text:K(function(a,b){for(var c=[],d=0,e=this.rangeCount;e>d;++d)c[d]=this.getRangeAt(d).text(b);return c.join("")})}),a.innerText=function(b,c){var d=a.createRange(b);d.selectNodeContents(b);var e=d.text(c);return d.detach(),e},a.createWordIterator=function(a,b,c){var g=B();c=d(c,ja);var h=f(c.characterOptions),i=e(c.wordOptions),j=g.getPosition(a,b),k=E(j,h,i),l=Z(c.direction);return{next:function(){return l?k.previousStartToken():k.nextEndToken()},dispose:function(){k.dispose(),this.next=function(){}}}},a.noMutation=function(a){var b=B();a(b),C()},a.noMutation.createEntryPointFunction=K,a.textRange={isBlockNode:k,isCollapsedWhitespaceNode:s,createPosition:K(function(a,b,c){return a.getPosition(b,c)})}}),define("rangy-textrange",["rangy-core"],function(a){return function(){var b;return b||a.rangy.modules.TextRange}}(this)),rangy.createModule("Position",["WrappedSelection"],function(a,b){function c(a){var b=0,c=0;if(typeof a.pageXOffset==v&&typeof a.pageYOffset==v)b=a.pageXOffset,c=a.pageYOffset;else{var d=a.document,e=d.documentElement,f=d.compatMode,g="string"==typeof f&&f.indexOf("CSS")>=0&&e?e:z.getBody(d);if(g&&typeof g.scrollLeft==v&&typeof g.scrollTop==v)try{b=g.scrollLeft,c=g.scrollTop}catch(h){}}return{x:b,y:c}}function d(a,b){for(b=b.toLowerCase();a;){if(1==a.nodeType&&a.tagName.toLowerCase()==b)return a;a=a.parentNode}return null}function e(a,b,c,d){this.top=a,this.right=b,this.bottom=c,this.left=d,this.width=b-d,this.height=c-a}function f(a,b,c){return new e(a.top+c,a.right+b,a.bottom+c,a.left+b)}function g(a,b){var c=0,d=0,e=b.documentElement,g=z.getBody(b),h=0===e.clientWidth&&typeof g.clientTop==v?g:e,i=h.clientLeft,j=h.clientTop;return i&&(c=-i),j&&(d=-j),f(a,c,d)}function h(a){for(var b,c=[],d=[],f=[],g=[],h=0,i=a.length;i>h;++h)b=a[h],b&&(c.push(b.top),d.push(b.bottom),f.push(b.left),g.push(b.right));return new e(Math.min.apply(Math,c),Math.max.apply(Math,g),Math.max.apply(Math,d),Math.min.apply(Math,f))}function i(b,c,d){var e=z.getBody(b).createTextRange();e.moveToPoint(c,d);var f=new a.WrappedTextRange(e);return new B(f.startContainer,f.startOffset)}function j(a,b,c){var d=a.caretPositionFromPoint(b,c);return new B(d.offsetNode,d.offset)}function k(a,b,c){var d=a.caretRangeFromPoint(b,c);return new B(d.startContainer,d.startOffset)}function l(a){var b=(a.nativeRange||a).getClientRects();return b.length>0?b[b.length-1]:null}function m(a,b,c){return console.log("pointIsInOrAboveRect",a,b,Math.floor(c.top),Math.floor(c.right),Math.floor(c.bottom),Math.floor(c.left)),b<c.bottom&&a>=c.left&&a<=c.right}function n(b,c,d,e){var f=b.elementFromPoint(c,d);console.log("elementFromPoint is ",f);
var g=a.createRange(b);g.selectNodeContents(f),g.collapse(!0);var h,i,j,k=f.firstChild;if(k){a:for(;k;){if(console.log(k),3==k.nodeType){for(h=0,j=k.length;j>=h;++h)if(g.setEnd(k,h),i=l(g),i&&m(c,d,i)){i.right-c>c-i.left&&--h;break a}}else if(g.setEndAfter(k),i=l(g),i&&m(c,d,i)){h=z.getNodeIndex(k),k=f.parentNode,e||++h;break}k=k.nextSibling}k||(k=f,h=f.childNodes.length)}else k=f.parentNode,h=z.getNodeIndex(f),e||++h;return new B(k,h)}function o(c){if(a.features.implementsTextRange)return i;if(typeof c.caretPositionFromPoint!=w)return j;if(typeof c.caretRangeFromPoint!=w)return k;if(typeof c.elementFromPoint!=w&&E)return n;throw b.createError("createCaretPositionFromPointGetter(): Browser does not provide a recognised method to create a selection from pixel coordinates")}function p(c,d,e,f,g){g=z.getContentDocument(g,b,"createRangeFromPoints");var h=o(g),i=h(g,c,d,!1),j=h(g,e,f,!0);console.log(i.node,i.offset,j.node,j.offset);var k=a.createRange(g);return k.setStartAndEnd(i.node,i.offset,j.node,j.offset),k}function q(a,b,c,d,e){var f,g,h,i,j=b>d||b==d&&a>c;j?(f=c,g=d,h=a,i=b):(f=a,g=b,h=c,i=d);var k=rangy.getSelection(e),l=p(f,g,h,i,e);return k.setSingleRange(l),k}function r(a){return function(){var b=this["get"+(a?"Start":"End")+"ClientPos"](),d=c(z.getWindow(this.startContainer));return{x:b.x+d.x,y:b.y+d.y}}}function s(a,b){return a.compareBoundaryPoints(b.START_TO_START,b)}function t(a){return function(){for(var b="getBounding"+(a?"Document":"Client")+"Rect",c=[],d=0;d<this.rangeCount;++d)c.push(this.getRangeAt(d)[b]());return h(c)}}function u(a,b){return function(){if(0==this.rangeCount)return null;var c=b?"Document":"Client",d=this.getAllRanges();return d.length>1&&d.sort(s),a?d[0]["getStart"+c+"Pos"]():d[d.length-1]["getEnd"+c+"Pos"]()}}var v="number",w="undefined",x=a.WrappedRange,y=a.WrappedTextRange,z=a.dom,A=a.util,B=z.DomPosition,C=document.createElementNS("http://www.w3.org/1999/xhtml","span"),D=A.isHostMethod(C,"getBoundingClientRect");C=null;var E=!1,F=!1;if(a.features.implementsDomRange){var G=a.createNativeRange();E=A.isHostMethod(G,"getClientRects"),F=A.isHostMethod(G,"getBoundingClientRect"),G.detach()}A.extend(a.features,{rangeSupportsGetBoundingClientRect:F,rangeSupportsGetClientRects:E,elementSupportsGetBoundingClientRect:D});var H=function(a){return function(){var b=this.cloneRange();b.collapse(a);var c=b.getBoundingClientRect();return{x:c[a?"left":"right"],y:c[a?"top":"bottom"]}}},I=a.rangePrototype;if(a.features.implementsTextRange&&D)I.getBoundingClientRect=function(){var a,b=y.rangeToTextRange(this),c=this.getNodes([1],function(a){return/^t[dh]$/i.test(a.tagName)}),e=[];if(c.length>0){for(var f,i,j,k,l=d(this.startContainer,"table"),m=0;f=c[m];++m)j=d(f,"table"),l&&j==l||(k=this.cloneRange(),l&&k.setStartAfter(l),k.setEndBefore(j),e.push(y.rangeToTextRange(k).getBoundingClientRect())),this.containsNode(f)?e.push(f.getBoundingClientRect()):(i=b.duplicate(),i.moveToElementText(f),-1==i.compareEndPoints("StartToStart",b)?i.setEndPoint("StartToStart",b):1==i.compareEndPoints("EndToEnd",b)&&i.setEndPoint("EndToEnd",b),e.push(i.getBoundingClientRect())),l=j;var n=d(this.endContainer,"table");!n&&l&&(k=this.cloneRange(),k.setStartAfter(l),e.push(y.rangeToTextRange(k).getBoundingClientRect())),a=h(e)}else a=b.getBoundingClientRect();return g(a,z.getDocument(this.startContainer))};else if(a.features.implementsDomRange){var J=function(a){return a instanceof x?a:new x(a)};if(F){if(I.getBoundingClientRect=function(){var a=J(this).nativeRange,b=a.getBoundingClientRect()||a.getClientRects()[0];return g(b,z.getDocument(this.startContainer))},E){H=function(a){return function(){var c,d=J(this).nativeRange,e=d.getClientRects();if(0==e.length&&D&&(console.log(d,d.getClientRects(),d.getBoundingClientRect()),this.collapsed&&1==this.startContainer.nodeType&&this.startOffset<this.startContainer.childNodes.length)){var f=this.startContainer.childNodes[this.startOffset];f.getClientRects&&console.log(f,f.getClientRects(),this.startContainer.getClientRects())}if(e.length>0)return a?(c=e[0],{x:c.left,y:c.top}):(c=e[e.length-1],{x:c.right,y:c.bottom});throw b.createError("Cannot get position for range "+this.inspect())}}}}else{var K=D?function(a){return g(a.getBoundingClientRect(),z.getDocument(a))}:function(a){for(var b=0,c=0,d=a,f=a.offsetWidth,h=a.offsetHeight;d;)b+=d.offsetLeft,c+=d.offsetTop,d=d.offsetParent;return g(new e(c,b+f,c+h,b),z.getDocument(a))},L=function(a){var b;a.splitBoundaries();var c=document.createElementNS("http://www.w3.org/1999/xhtml","span");if(a.collapsed)a.insertNode(c),b=K(c),c.parentNode.removeChild(c);else{var d=a.cloneRange();d.collapse(!0),d.insertNode(c);var e=K(c);c.parentNode.removeChild(c),d.collapseToPoint(a.endContainer,a.endOffset),d.insertNode(c);var f=K(c);c.parentNode.removeChild(c);for(var g=[e,f],i=a.getNodes([1],function(b){return a.containsNode(b)}),j=0,k=i.length;k>j;++j)g.push(K(i[j]));b=h(g)}return a.normalizeBoundaries(),b};I.getBoundingClientRect=function(a){return L(J(a))}}}A.extend(I,{getBoundingDocumentRect:function(){var a=c(z.getWindow(this.startContainer));return f(this.getBoundingClientRect(),a.x,a.y)},getStartClientPos:H(!0),getEndClientPos:H(!1),getStartDocumentPos:r(!0),getEndDocumentPos:r(!1)}),A.extend(a.selectionPrototype,{getBoundingClientRect:t(!1),getBoundingDocumentRect:t(!0),getStartClientPos:u(!0,!1),getEndClientPos:u(!1,!1),getStartDocumentPos:u(!0,!0),getEndDocumentPos:u(!1,!0)}),a.positionFromPoint=function(a,c,d){return d=z.getContentDocument(d,b,"positionFromPoint"),o(d)(d,a,c)},a.createRangeFromPoints=p,a.moveSelectionToPoints=q}),define("rangy-position",["rangy-core"],function(a){return function(){var b;return b||a.rangy.modules.Position}}(this)),define("rangy",["rangy-core","rangy-highlighter","rangy-cssclassapplier","rangy-textrange","rangy-position"],function(a,b,c,d,e){return a}),ReadiumSDK.Views.MediaOverlayElementHighlighter=function(a){function b(a,b,d){if(n)try{if(n[0].ownerDocument===a[0].ownerDocument)return}catch(e){}$head=$("head",a[0].ownerDocument.documentElement),n=$("<style type='text/css'> </style>"),n.append("."+c+" {");var f="background-color: yellow !important; color: black !important; border-radius: 0.4em;",g=d;if(g){var h=!1;for(var i in g.declarations)g.declarations.hasOwnProperty(i)&&(h=!0,n.append(i+": "+g.declarations[i]+"; "));h||b||n.append(f)}else b||n.append(f);n.append("}"),n.appendTo($head)}this.includeParWhenAdjustingToSeqSyncGranularity=!0;var c="mo-active-default",d="mo-sub-sync",e=void 0;this.isElementHighlighted=function(a){return e&&a===e};var f=void 0;this.isCfiHighlighted=function(a){return f&&a===f};var g="",h="",i=a,j=!0&&"undefined"!=typeof rangy,k=void 0,l=void 0,m="MO_SPEAK",n=void 0;this.reDo=function(){n&&n.remove(),n=void 0;var a=e,b=f,c=g,d=h;e?(this.reset(),this.highlightElement(a,c,d)):f&&(this.reset(),this.highlightCfi(b,c,d))},this.highlightElement=function(a,j,k){if(a&&a!==e){this.reset(),e=a,f=void 0,g=j,h=k;var l=this.adjustParToSeqSyncGranularity(e),m=l.element;h&&""!==h&&$(m.ownerDocument.documentElement).addClass(h);var n=$(m),o=g&&""!==g,p=i.userStyles().findStyle("."+c);b(n,o,p),p||!o?(o&&n.addClass(g),n.addClass(c)):n.addClass(g),(this.includeParWhenAdjustingToSeqSyncGranularity||e!==l)&&$(e.element).addClass(d)}},this.highlightCfi=function(a,d,n){if(a&&a!==f){this.reset(),e=void 0,f=a,g=d,h=n;var o=$(f.cfi.cfiTextParent),p=g&&""!==g,q=i.userStyles().findStyle("."+c);b(o,p,q);var r=q||!p?(p?g+" ":"")+c:g;if(j){var s=f.cfi.cfiTextParent.ownerDocument;l=rangy.createRange(s);var t="epubcfi("+f.cfi.partialStartCfi+")",u=EPUBcfi.getTextTerminusInfoWithPartialCFI(t,s,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),v="epubcfi("+f.cfi.partialEndCfi+")",w=EPUBcfi.getTextTerminusInfoWithPartialCFI(v,s,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);l.setStartAndEnd(u.textNode[0],u.textOffset,w.textNode[0],w.textOffset);l.MO_createCssClassApplier=!0,k&&k.cssClass===r||(k=rangy.createCssClassApplier(r,{elementTagName:"span",elementProperties:{className:"mo-cfi-highlight"},ignoreWhiteSpace:!0,applyToEditableOnly:!1,normalize:!0},["span"])),k.applyToRange(l)}else try{var x=a.getSmil().spineItemId;i.addHighlight(x,a.cfi.partialRangeCfi,m,"highlight",void 0)}catch(y){console.error(y)}}},this.reset=function(){if(f){var a=f.cfi.cfiTextParent.ownerDocument;if(j){if(k&&l.MO_createCssClassApplier)k.undoToRange(l);else for(var b=void 0;null!==(b=a.getElementById(m));){var n=b.textContent,o=a.createTextNode(n);b.parentNode.replaceChild(o,b),o.parentNode.normalize()}l=void 0}else try{i.removeHighlight(m);for(var b=void 0;null!==(b=a.getElementById("start-"+m));)console.log("toRemove START"),console.log(b),b.parentNode.removeChild(b);for(;null!==(b=a.getElementById("end-"+m));)console.log("toRemove END"),console.log(b),b.parentNode.removeChild(b)}catch(p){console.error(p)}f=void 0}if(e){var q=this.adjustParToSeqSyncGranularity(e),r=q.element;(this.includeParWhenAdjustingToSeqSyncGranularity||e!==q)&&$(e.element).removeClass(d),h&&""!==h&&$(r.ownerDocument.documentElement).removeClass(h),g&&""!==g&&$(r).removeClass(g),$(r).removeClass(c),e=void 0}g="",h=""},this.adjustParToSeqSyncGranularity=function(a){if(!a)return void 0;var b=i.viewerSettings().mediaOverlaysSynchronizationGranularity;if(b&&b.length>0){var c=a.element||(a.cfi?a.cfi.cfiTextParent:void 0);if(!c)return console.error("adjustParToSeqSyncGranularity !element ???"),a;var d=a.getFirstSeqAncestorWithEpubType(b,this.includeParWhenAdjustingToSeqSyncGranularity);if(d&&d.element)return d}return a}},define("mediaOverlayElementHighlighter",["readiumSDK","rangy"],function(a){return function(){var b;return b||a.mediaOverlayElementHighlighter}}(this)),ReadiumSDK.Views.MediaOverlayPlayer=function(a,b){function c(a){var b=a.getSmil();return m&&m.smil==b?m.reset():m=new ReadiumSDK.Models.SmilIterator(b),m.goToPar(a),m.currentPar?void e():void console.error("playPar !_smilIterator.currentPar")}function d(){x.resetBlankPage(),C=setTimeout(function(){if(C){if(x.resetBlankPage(),!m||!m.currentPar)return void x.reset();E=0,g(m.currentPar.audio.clipEnd+.1,2)}},2e3),b({isPlaying:!0})}function e(){if(L=!1,!m||!m.currentPar)return void console.error("playCurrentPar !_smilIterator || !_smilIterator.currentPar ???");if(!m.smil.id)return n.reset(),x.resetTTS(),x.resetEmbedded(),void setTimeout(function(){d()},100);if(m.currentPar.audio.src){x.resetTTS(),x.resetEmbedded(),x.resetBlankPage();var a=m.currentPar.audio.clipEnd-m.currentPar.audio.clipBegin;(0>=a||B>a)&&(console.error("### MO XXX PAR OFFSET: "+B+" / "+a),B=0);var c=ReadiumSDK.Helpers.ResolveContentRef(m.currentPar.audio.src,m.smil.href),e=v.resolveRelativeUrlMO(c),f=m.currentPar.audio.clipBegin+B;n.playFile(m.currentPar.audio.src,e,f)}else{B=0,n.reset();var g=m.currentPar.element;if(g){E=0;var h=g.nodeName?g.nodeName.toLowerCase():void 0;"audio"===h||"video"===h?(x.resetTTS(),x.resetBlankPage(),u&&x.resetEmbedded(),u=g,u.pause(),u.currentTime=0,u.play(),$(u).on("ended",x.onEmbeddedEnd),t=!0,setTimeout(function(){b({isPlaying:!0})},80)):(x.resetEmbedded(),x.resetBlankPage(),p=g.textContent,p&&""!=p?I(p):p=void 0)}var i=m.currentPar.cfi;if(i){E=0,x.resetEmbedded(),x.resetBlankPage(),y.reset();var j=i.cfiTextParent.ownerDocument,k="epubcfi("+i.partialStartCfi+")",o=EPUBcfi.getTextTerminusInfoWithPartialCFI(k,j,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),q="epubcfi("+i.partialEndCfi+")",r=EPUBcfi.getTextTerminusInfoWithPartialCFI(q,j,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(rangy){var s=rangy.createRange(j);s.setStartAndEnd(o.textNode[0],o.textOffset,r.textNode[0],r.textOffset),p=s.toString()}else p=void 0;p&&""!=p?I(p):p=void 0}}B=0,l()}function f(b){x.pause();var c=b?v.media_overlay.getNextSmil(m.smil):v.media_overlay.getPreviousSmil(m.smil);if(c){if(m=new ReadiumSDK.Models.SmilIterator(c),m.currentPar){if(!b)for(;!m.isLast();)m.next();a.openContentUrl(m.currentPar.text.src,m.smil.href,x)}}else console.log("No more SMIL"),x.reset()}function g(a,b,c){if(E=a,D=!1,m&&m.currentPar){var d=m.currentPar,h=m.currentPar.audio;if(!(a>F&&a<=h.clipEnd)){D=!0;var i=n.isPlaying();i&&6===b&&console.debug("from userNav _audioPlayer.isPlaying() ???");var j=a>h.clipEnd,k=!N&&6!==b&&j,o=m&&m.smil&&m.smil.spineItemId?m.smil.spineItemId:A&&A.spineItem&&A.spineItem.idref?A.spineItem.idref:void 0;if(k&&o&&A&&A.paginationInfo&&A.paginationInfo.openPages&&A.paginationInfo.openPages.length>1){var p=0,q=A.paginationInfo.openPages[p];o===q.idref&&(k=!1)}if(j?m.next():m.previous(),!m.currentPar)return void(k?(M=!0,x.reset()):f(j));if(!m.currentPar.audio)return void x.pause();if(w.mediaOverlaysSkipSkippables){for(var r=!1,s=m.currentPar;s;){if(s.isSkippable&&s.isSkippable(w.mediaOverlaysSkippables)){r=!0;break}s=s.parent}if(r){console.log("MO SKIP: "+s.epubtype),x.pause();var t=j?m.currentPar.audio.clipEnd+.1:F-1;return void g(t,b,!0)}}if(!i&&(m.currentPar.element||m.currentPar.cfi&&m.currentPar.cfi.cfiTextParent)){var u=y.adjustParToSeqSyncGranularity(m.currentPar);if(u&&u!==m.currentPar){var v=y.adjustParToSeqSyncGranularity(d);if(v&&(v===u||!j)){if(v===u){do j?m.next():m.previous();while(m.currentPar&&m.currentPar.hasAncestor(v));if(!m.currentPar)return void(k?(M=!0,x.reset()):f(j))}if(!j){var z=y.adjustParToSeqSyncGranularity(m.currentPar);if(z&&z!==m.currentPar){var B=m.currentPar,C=void 0;do C=m.currentPar,m.previous();while(m.currentPar&&m.currentPar.hasAncestor(z));m.currentPar?(m.next(),m.currentPar.hasAncestor(z)||console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar.hasAncestor(landed) ???")):(m.reset(),m.currentPar!==C&&console.error("adjustParToSeqSyncGranularity _smilIterator.currentPar !=== innerPar???")),m.currentPar||(console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar ?????"),m.goToPar(B))}}}}}return n.isPlaying()&&m.currentPar.audio.src&&m.currentPar.audio.src==n.currentSmilSrc()&&a>=m.currentPar.audio.clipBegin&&a<=m.currentPar.audio.clipEnd?void l():void e()}}}function h(a){if(!H||H[0].ownerDocument!==a[0].ownerDocument){var b=".tts_on{background-color:red;color:white;} .tts_off{}";$head=$("head",a[0].ownerDocument.documentElement),H=$("<style type='text/css'> </style>").appendTo($head),H.append(b)}}function i(){j();var a=function(){if(m&&m.currentPar){var a=m.smil;if(a.mo){var c=E-m.currentPar.audio.clipBegin;if(!(0>=c)){for(var d=a.mo.smil_models.indexOf(a),e=new ReadiumSDK.Models.SmilIterator(a),f=-1;e.currentPar&&(f++,e.currentPar!=m.currentPar);)e.next();b({playPosition:c,smilIndex:d,parIndex:f})}}}};setTimeout(a,500),K=setInterval(a,1500)}function j(){E=0,void 0!==K&&clearInterval(K),K=void 0}function k(){return j(),D?void(D=!1):m&&m.currentPar?void g(m.currentPar.audio.clipEnd+.1,5):void x.reset()}function l(){if(m&&m.currentPar){if(m.currentPar.text.srcFragmentId&&m.currentPar.text.srcFragmentId.length>0){if(m.currentPar.element)return void(y.isElementHighlighted(m.currentPar)||(y.highlightElement(m.currentPar,v.media_overlay.activeClass,v.media_overlay.playbackActiveClass),L||a.insureElementVisibility(m.currentPar.getSmil().spineItemId,m.currentPar.element,x)));if(m.currentPar.cfi)return void(y.isCfiHighlighted(m.currentPar)||(y.highlightCfi(m.currentPar,v.media_overlay.activeClass,v.media_overlay.playbackActiveClass),L||a.insureElementVisibility(m.currentPar.getSmil().spineItemId,m.currentPar.cfi.cfiTextParent,x)))}if(!m.currentPar.element){var b=m.currentPar.text.src,c=m.smil.href;m=void 0,a.openContentUrl(b,c,x)}}}var m=void 0,n=new ReadiumSDK.Views.AudioPlayer(b,g,k,i,j),o=!1,p=void 0,q=!0&&"undefined"!=typeof window.speechSynthesis&&null!=speechSynthesis,r=void 0,s=!1,t=!1,u=void 0;this.isPlaying=function(){return n.isPlaying()||o||t||C};var v=a["package"](),w=a.viewerSettings(),x=this,y=new ReadiumSDK.Views.MediaOverlayElementHighlighter(a);a.on(ReadiumSDK.Events.READER_VIEW_DESTROYED,function(){x.reset()}),this.applyStyles=function(){y.reDo()},this.onSettingsApplied=function(){n.setRate(w.mediaOverlaysRate),n.setVolume(w.mediaOverlaysVolume/100)},x.onSettingsApplied(),a.on(ReadiumSDK.Events.SETTINGS_APPLIED,this.onSettingsApplied,this);var z=!1;this.onDocLoadStart=function(){var a=x.isPlaying();a&&(z=!0,x.pause())};var A=void 0;this.onPageChanged=function(b){A=b;var d=M;M=!1;var f=z;if(z=!1,!b)return void x.reset();var g=void 0,h="/99!",i="epubcfi";if(b.elementId||b.initiator==x){for(var j=a.getLoadedSpineItems(),k=a.spine().isRightToLeft(),n=k?j.length-1:0;k&&n>=0||!k&&n<j.length;n+=k?-1:1){var o=j[n];if(!b.spineItem||b.spineItem==o){if(b.elementId&&0===b.elementId.indexOf(i)){y.reset();var p=b.elementId.substr(i.length+1,b.elementId.length-i.length-2);0===p.indexOf(h)&&(p=p.substr(h.length,p.length-h.length));var q=p.split(",");if(q&&3===q.length)try{var r=q[0]+q[1],s=a.getElementByCfi(o,r,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(g=s&&s.length>0?s[0]:void 0){g.nodeType===Node.TEXT_NODE&&(g=g.parentNode);break}}catch(t){console.error(t)}else try{var s=a.getElementByCfi(o,p,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(g=s&&s.length>0?s[0]:void 0){g.nodeType===Node.TEXT_NODE&&(g=g.parentNode);break}}catch(t){console.error(t)}}if(!g){if(b.initiator!=x||b.elementId){var s=a.getElementById(o,b.elementId);g=s&&s.length>0?s[0]:void 0}else{var s=a.getElement(o,"body");g=s&&s.length>0?s[0]:void 0}if(g)break}}}g||console.error("paginationData.elementId BUT !element: "+b.elementId)}var u=x.isPlaying()||f;if(!m||!m.currentPar){if(b.initiator!==x)return B=0,x.reset(),void(b.elementId&&g?(u||d)&&(b.elementIdResolved=g,x.toggleMediaOverlayRefresh(b)):(u||d)&&x.toggleMediaOverlay());if(!g)return console.error("!element: "+b.elementId),void(B=0);var v=$(g).data("mediaOverlayData");if(!v)return console.error("!moData: "+b.elementId),void(B=0);var w=v.par?v.par:v.pars[0];if(v.pars)for(var C=0;C<v.pars.length;C++){var D=v.pars[C];if(b.elementId===D.cfi.smilTextSrcCfi){w=D;break}}return void c(w)}var E=!m.currentPar.element&&!m.currentPar.cfi;if(E&&console.error("!! _smilIterator.currentPar.element ??"),b.initiator==x){var F=b.elementId&&b.elementId!==m.currentPar.text.srcFragmentId;if(F&&console.error("!! paginationData.elementId !== _smilIterator.currentPar.text.srcFragmentId"),F||E)return void(B=0);u?l():e()}else{if(!u&&!d)return void x.reset();if(!b.elementId,b.elementId&&!g)return;b.elementId&&(b.elementIdResolved=g),x.toggleMediaOverlayRefresh(b)}};var B=0,C=void 0,D=!1,E=0,F=-999;this.touchInit=function(){var a=n.touchInit();a&&q&&I("o",0)};var G=function(a){var b=["p","div","pagenum","td","table","li","ul","ol"],c=[",",";",".","-","??","??","?","!"],d=function(a,b){if(!(a.word.length<=0)){var c=a.text.length;b.spanMap[c]=a.counter,a.text+=a.word,a.markup+=a.html.substring(0,a.wordStart)+'<span class="tts_off" id="tts_'+a.counter+'">'+a.html.substring(a.wordStart,a.wordEnd)+"</span>"+a.html.substring(a.wordEnd,a.html.length),a.word="",a.html="",a.wordStart=-1,a.wordEnd=-1,a.counter++}},e={element:a,innerHTML_tts:"",spanMap:{},text:"",lastCharIndex:void 0};e.element.innerHTML_original=a.innerHTML;for(var f={inTag:!1,counter:0,wordStart:-1,wordEnd:-1,text:"",markup:"",word:"",html:""},g=e.element.innerHTML_original.length,h=0;g>=h;){if(f.inTag){if(f.html+=e.element.innerHTML_original[h],">"==e.element.innerHTML_original[h]){f.inTag=!1;var i=f.html.match(/<\/(.*?)>$/);i&&b.indexOf(i[1])>-1&&(d(f,e),f.text+=" ")}}else h==g||e.element.innerHTML_original[h].match(/\s/)?(d(f,e),g>h&&(f.text+=e.element.innerHTML_original[h],f.markup+=e.element.innerHTML_original[h])):c.indexOf(e.element.innerHTML_original[h])>-1?(d(f,e),f.wordStart=f.html.length,f.wordEnd=f.html.length+1,f.word+=e.element.innerHTML_original[h],f.html+=e.element.innerHTML_original[h],d(f,e)):"<"==e.element.innerHTML_original[h]?(f.inTag=!0,f.html+=e.element.innerHTML_original[h]):(0==f.word.length&&(f.wordStart=f.html.length),f.wordEnd=f.html.length+1,f.word+=e.element.innerHTML_original[h],f.html+=e.element.innerHTML_original[h]);h++}return e.text=f.text,e.innerHTML_tts=f.markup,e.element.innerHTML=e.innerHTML_tts,e},H=void 0,I=function(c,d){function e(a){a||window.speechSynthesis.pending?(console.debug("TTS cancel before speak"),window.speechSynthesis.cancel(),setTimeout(function(){e(!1)},5)):f()}function f(){r=new SpeechSynthesisUtterance,s&&g&&(r.tokenData=g,r.onboundary=function(a){if(r){console.debug("TTS boundary: "+a.name+" / "+a.charIndex);var b=a.target.tokenData;if(b&&b.spanMap.hasOwnProperty(a.charIndex)){var c;[].forEach.call(b.element.querySelectorAll(".tts_on"),function(a){console.debug("TTS OFF "+a.id),a.className="tts_off"});var c="tts_"+b.spanMap[a.charIndex];console.debug("TTS charIndex ID: "+c);var d=b.element.querySelector("#"+c);d&&(console.debug("TTS ON"),d.className="tts_on"),b.lastCharIndex=a.charIndex}}}),r.onend=function(a){if(r)if(console.debug("TTS ended"),s){var b=a.target.tokenData,c=!a.forceSkipEnd&&r===a.target&&(!b||b.element.innerHTML_original);b&&(b.element.innerHTML_original?b.element.innerHTML=b.element.innerHTML_original:[].forEach.call(b.element.querySelectorAll(".tts_on"),function(a){console.debug("TTS OFF (end)"+a.id),a.className="tts_off"}),b.element.innerHTML_original=void 0),c?x.onTTSEnd():console.debug("TTS end SKIPPED")}else x.onTTSEnd()},r.onerror=function(a){if(r&&(console.error("TTS error"),console.debug(r.text),console.debug(window.speechSynthesis.paused),console.debug(window.speechSynthesis.pending),console.debug(window.speechSynthesis.speaking),s)){var b=a.target.tokenData;b&&(b.element.innerHTML_original?b.element.innerHTML=b.element.innerHTML_original:[].forEach.call(b.element.ownerDocument.querySelectorAll(".tts_on"),function(a){console.debug("TTS OFF (error)"+a.id),a.className="tts_off"}),b.element.innerHTML_original=void 0)}};var a=d||n.getVolume();r.volume=a,r.rate=n.getRate(),r.pitch=1,r.text=l,window.speechSynthesis.speak(r),window.speechSynthesis.paused&&(console.debug("TTS resume"),window.speechSynthesis.resume())}var g=void 0,i=m&&m.currentPar?m.currentPar:void 0,j=i?i.element:void 0;i?i.cfi:void 0;if((!d||d>0)&&(setTimeout(function(){b({isPlaying:!0})},80),o=!0,s&&j)){var k=$(j);h(k),j.innerHTML_original&&(j.innerHTML=j.innerHTML_original,j.innerHTML_original=void 0),g=G(j)}if(!q)return void a.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_TTS_SPEAK,{tts:c});if(!c&&window.speechSynthesis.paused)return void window.speechSynthesis.resume();var l=c||p;l&&(r&&(s&&(r.onend&&r.onend({forceSkipEnd:!0,target:r}),r.tokenData=void 0,r.onboundary=void 0),r.onend=void 0,r.onerror=void 0,r=void 0),console.debug("paused: "+window.speechSynthesis.paused),console.debug("speaking: "+window.speechSynthesis.speaking),console.debug("pending: "+window.speechSynthesis.pending),e(!0))},J=function(){return b({isPlaying:!1}),o=!1,q?void window.speechSynthesis.pause():void a.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_TTS_STOP,void 0)},K=void 0;this.onEmbeddedEnd=function(){return E=0,t=!1,m&&m.currentPar?void g(m.currentPar.audio.clipEnd+.1,3):void x.reset()},this.onTTSEnd=function(){return E=0,o=!1,m&&m.currentPar?void g(m.currentPar.audio.clipEnd+.1,4):void x.reset()},this.escape=function(){if(!m||!m.currentPar)return void this.toggleMediaOverlay();if(!x.isPlaying())return void x.play();if(w.mediaOverlaysEscapeEscapables)for(var a=m.currentPar;a;){if(a.isEscapable&&a.isEscapable(w.mediaOverlaysEscapables)){do m.next();while(m.currentPar&&m.currentPar.hasAncestor(a));return m.currentPar?void e():void f(!0)}a=a.parent}this.nextMediaOverlay(!0)},this.playUserPar=function(a){if(x.isPlaying()&&x.pause(),a.element||a.cfi&&a.cfi.cfiTextParent){var b=y.adjustParToSeqSyncGranularity(a);if(b&&b!==a){var d=function(a){if(a.nodeType&&"par"===a.nodeType)return a;if(!a.children||a.children.length<=0)return void 0;for(var b=0;b<a.children.length;b++){var c=a.children[b],e=d(c);if(e)return e}},e=d(b);e&&(a=e)}}c(a)},this.resetTTS=function(){p=void 0,J()},this.resetBlankPage=function(){if(C){var a=C;C=void 0,clearTimeout(a)}C=void 0,b({isPlaying:!1})},this.resetEmbedded=function(){u&&($(u).off("ended",x.onEmbeddedEnd),u.pause()),u=void 0,b({isPlaying:!1}),t=!1},this.reset=function(){B=0,n.reset(),x.resetTTS(),x.resetEmbedded(),x.resetBlankPage(),y.reset(),m=void 0,D=!1},this.play=function(){if(m&&m.smil&&!m.smil.id)return void d();if(u)t=!0,u.play(),b({isPlaying:!0});else if(p)I(void 0);else if(!n.play())return console.log("Audio player was dead, reactivating..."),this.reset(),void this.toggleMediaOverlay();l()},this.pause=function(){L=!1,C?this.resetBlankPage():t?(t=!1,u&&u.pause(),b({isPlaying:!1})):o?J():n.pause(),y.reset()},this.isMediaOverlayAvailable=function(){var b=a.getFirstVisibleMediaOverlayElement();return"undefined"!=typeof b},this.nextOrPreviousMediaOverlay=function(a){if(x.isPlaying())x.pause();else if(m&&m.currentPar)return void x.play();if(!m)return void this.toggleMediaOverlay();var b=a?F-1:m.currentPar.audio.clipEnd+.1;g(b,6)},this.nextMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!1)},this.previousMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!0)},this.mediaOverlaysOpenContentUrl=function(b,c,d){B=d,m=void 0,a.openContentUrl(b,c,x)},this.toggleMediaOverlay=function(){return x.isPlaying()?void x.pause():m?void x.play():void this.toggleMediaOverlayRefresh(void 0)};var L=!1;this.toggleMediaOverlayRefresh=function(b){var c=a.getLoadedSpineItems(),d=a.spine().isRightToLeft(),f=void 0,g=x.isPlaying();if(g&&m){var h=b.initiator&&b.initiator instanceof ReadiumSDK.Views.ScrollView;if(h&&w.mediaOverlaysPreservePlaybackWhenScroll)return void(L=!0);f=m.currentPar,x.pause()}L=!1;var i=b&&b.elementIdResolved?b.elementIdResolved:void 0,j=b&&b.elementId?b.elementId:void 0;if(!i){j&&console.error("[WARN] id did not resolve to element?");for(var k=d?c.length-1:0;d&&k>=0||!d&&k<c.length;k+=d?-1:1){var l=c[k];if(l){if(!b||!b.spineItem||b.spineItem==l){if(j){var n=a.getElementById(l,j);i=n&&n.length>0?n[0]:void 0}else if(l.isFixedLayout()&&b&&b.paginationInfo&&b.paginationInfo.openPages){var o=0;if(b.paginationInfo.openPages[o]&&b.paginationInfo.openPages[o].idref&&b.paginationInfo.openPages[o].idref===l.idref){var n=a.getElement(l,"body");i=n&&n.length>0?n[0]:void 0}}if(i)break}}else console.error("spineItems[i] is undefined??")}}if(i||(i=a.getFirstVisibleMediaOverlayElement()),!i)return void x.reset();var p=$(i).data("mediaOverlayData");if(!p){for(var q=!1,r=function(a){if(!a)return!1;for(var b=0;b<a.length;b++){if(i===a[b]&&(q=!0),q){var c=$(a[b]).data("mediaOverlayData");if(c)return p=c,!0}var d=r(a[b].children);if(d)return!0}return!1},s=i;s&&"body"!==s.nodeName.toLowerCase();)s=s.parentNode;if(!s)return void x.reset();r([s])}if(!p)return void x.reset();var t=p.par?p.par:p.pars[0],u=t.getSmil();return m&&m.smil==u?m.reset():m=new ReadiumSDK.Models.SmilIterator(u),m.goToPar(t),!m.currentPar&&j&&(m.reset(),m.findTextId(j)),m.currentPar?void(g&&f&&f===m.currentPar?x.play():e()):void x.reset()},this.isPlayingCfi=function(){return m&&m.currentPar&&m.currentPar.cfi};var M=!1,N=!0;this.setAutomaticNextSmil=function(a){N=a}},define("mediaOverlayPlayer",["readiumSDK","mediaOverlay","audioPlayer","mediaOverlayElementHighlighter","rangy"],function(a){return function(){var b;return b||a.mediaOverlayPlayer}}(this)),ReadiumSDK.Models.PageOpenRequest=function(a,b){this.spineItem=a,this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1,this.initiator=b,this.reset=function(){this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1},this.setFirstPage=function(){this.reset(),this.firstPage=!0},this.setLastPage=function(){this.reset(),this.lastPage=!0},this.setPageIndex=function(a){this.reset(),this.spineItemPageIndex=a},this.setElementId=function(a){this.reset(),this.elementId=a},this.setElementCfi=function(a){this.reset(),this.elementCfi=a}},define("pageOpenRequest",["readiumSDK"],function(a){return function(){var b;return b||a.pageOpenRequest}}(this)),function(a){var b={};b.Parser=function(){function a(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var b={parse:function(b,c){function d(a){I>G||(G>I&&(I=G,J=[]),J.push(a))}function e(){var a,c,e,h,i;return h=G,i=G,"epubcfi("===b.substr(G,8)?(a="epubcfi(",G+=8):(a=null,0===H&&d('"epubcfi("')),null!==a?(c=f(),null===c&&(c=g()),null!==c?(41===b.charCodeAt(G)?(e=")",G++):(e=null,0===H&&d('")"')),null!==e?a=[a,c,e]:(a=null,G=i)):(a=null,G=i)):(a=null,G=i),null!==a&&(a=function(a,b){return{type:"CFIAST",cfiString:b}}(h,a[1])),null===a&&(G=h),a}function f(){var a,c,e,f,g,j,k,l;return k=G,l=G,a=i(),null!==a?(c=h(),null!==c?(44===b.charCodeAt(G)?(e=",",G++):(e=null,0===H&&d('","')),null!==e?(f=h(),null!==f?(44===b.charCodeAt(G)?(g=",",G++):(g=null,0===H&&d('","')),null!==g?(j=h(),null!==j?a=[a,c,e,f,g,j]:(a=null,G=l)):(a=null,G=l)):(a=null,G=l)):(a=null,G=l)):(a=null,G=l)):(a=null,G=l),null!==a&&(a=function(a,b,c,d,e){return{type:"range",path:b,localPath:c,range1:d,range2:e}}(k,a[0],a[1],a[3],a[5])),null===a&&(G=k),a}function g(){var a,b,c,d;return c=G,d=G,a=i(),null!==a?(b=h(),null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d),null!==a&&(a=function(a,b,c){return{type:"path",path:b,localPath:c}}(c,a[0],a[1])),null===a&&(G=c),a}function h(){var a,b,c,d;if(c=G,d=G,b=i(),null===b&&(b=j()),null!==b)for(a=[];null!==b;)a.push(b),b=i(),null===b&&(b=j());else a=null;return null!==a?(b=k(),b=null!==b?b:"",null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d),null!==a&&(a=function(a,b,c){return{steps:b,termStep:c}}(c,a[0],a[1])),null===a&&(G=c),a}function i(){var a,c,e,f,g,h,i,j;return h=G,i=G,47===b.charCodeAt(G)?(a="/",G++):(a=null,0===H&&d('"/"')),null!==a?(c=t(),null!==c?(j=G,91===b.charCodeAt(G)?(e="[",G++):(e=null,0===H&&d('"["')),null!==e?(f=l(),null!==f?(93===b.charCodeAt(G)?(g="]",G++):(g=null,0===H&&d('"]"')),null!==g?e=[e,f,g]:(e=null,G=j)):(e=null,G=j)):(e=null,G=j),e=null!==e?e:"",null!==e?a=[a,c,e]:(a=null,G=i)):(a=null,G=i)):(a=null,G=i),null!==a&&(a=function(a,b,c){return{type:"indexStep",stepLength:b,idAssertion:c[1]}}(h,a[1],a[2])),null===a&&(G=h),a}function j(){var a,c,e,f,g,h,i,j;return h=G,i=G,"!/"===b.substr(G,2)?(a="!/",G+=2):(a=null,0===H&&d('"!/"')),null!==a?(c=t(),null!==c?(j=G,91===b.charCodeAt(G)?(e="[",G++):(e=null,0===H&&d('"["')),null!==e?(f=l(),null!==f?(93===b.charCodeAt(G)?(g="]",G++):(g=null,0===H&&d('"]"')),null!==g?e=[e,f,g]:(e=null,G=j)):(e=null,G=j)):(e=null,G=j),e=null!==e?e:"",null!==e?a=[a,c,e]:(a=null,G=i)):(a=null,G=i)):(a=null,G=i),null!==a&&(a=function(a,b,c){return{type:"indirectionStep",stepLength:b,idAssertion:c[1]}}(h,a[1],a[2])),null===a&&(G=h),a}function k(){var a,c,e,f,g,h,i,j;return h=G,i=G,58===b.charCodeAt(G)?(a=":",G++):(a=null,0===H&&d('":"')),null!==a?(c=t(),null!==c?(j=G,91===b.charCodeAt(G)?(e="[",G++):(e=null,0===H&&d('"["')),null!==e?(f=m(),null!==f?(93===b.charCodeAt(G)?(g="]",G++):(g=null,0===H&&d('"]"')),null!==g?e=[e,f,g]:(e=null,G=j)):(e=null,G=j)):(e=null,G=j),e=null!==e?e:"",null!==e?a=[a,c,e]:(a=null,G=i)):(a=null,G=i)):(a=null,G=i),null!==a&&(a=function(a,b,c){return{type:"textTerminus",offsetValue:b,textAssertion:c[1]}}(h,a[1],a[2])),null===a&&(G=h),a}function l(){var a,b;return b=G,a=q(),null!==a&&(a=function(a,b){return b}(b,a)),null===a&&(G=b),a}function m(){var a,b,c,d;return c=G,d=G,a=o(),a=null!==a?a:"",null!==a?(b=n(),b=null!==b?b:"",null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d),null!==a&&(a=function(a,b,c){return{type:"textLocationAssertion",csv:b,parameter:c}}(c,a[0],a[1])),null===a&&(G=c),a}function n(){var a,c,e,f,g,h;return g=G,h=G,59===b.charCodeAt(G)?(a=";",G++):(a=null,0===H&&d('";"')),null!==a?(c=p(),null!==c?(61===b.charCodeAt(G)?(e="=",G++):(e=null,0===H&&d('"="')),null!==e?(f=p(),null!==f?a=[a,c,e,f]:(a=null,G=h)):(a=null,G=h)):(a=null,G=h)):(a=null,G=h),null!==a&&(a=function(a,b,c){return{type:"parameter",
LHSValue:b,RHSValue:c}}(g,a[1],a[3])),null===a&&(G=g),a}function o(){var a,c,e,f,g;return f=G,g=G,a=q(),a=null!==a?a:"",null!==a?(44===b.charCodeAt(G)?(c=",",G++):(c=null,0===H&&d('","')),null!==c?(e=q(),e=null!==e?e:"",null!==e?a=[a,c,e]:(a=null,G=g)):(a=null,G=g)):(a=null,G=g),null!==a&&(a=function(a,b,c){return{type:"csv",preAssertion:b,postAssertion:c}}(f,a[0],a[2])),null===a&&(G=f),a}function p(){var a,b,c;if(c=G,b=r(),null===b&&(b=C()),null!==b)for(a=[];null!==b;)a.push(b),b=r(),null===b&&(b=C());else a=null;return null!==a&&(a=function(a,b){return b.join("")}(c,a)),null===a&&(G=c),a}function q(){var a,b,c;if(c=G,b=r(),null===b&&(b=C(),null===b&&(b=u())),null!==b)for(a=[];null!==b;)a.push(b),b=r(),null===b&&(b=C(),null===b&&(b=u()));else a=null;return null!==a&&(a=function(a,b){return b.join("")}(c,a)),null===a&&(G=c),a}function r(){var a,b,c,d;return c=G,d=G,a=v(),null!==a?(b=v(),null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d),null===a&&(d=G,a=v(),null!==a?(b=x(),null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d),null===a&&(d=G,a=v(),null!==a?(b=y(),null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d),null===a&&(d=G,a=v(),null!==a?(b=z(),null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d),null===a&&(d=G,a=v(),null!==a?(b=A(),null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d),null===a&&(d=G,a=v(),null!==a?(b=B(),null!==b?a=[a,b]:(a=null,G=d)):(a=null,G=d)))))),null!==a&&(a=function(a,b){return b[1]}(c,a)),null===a&&(G=c),a}function s(){var a,c,e,f,g,h,i;if(g=G,h=G,i=G,/^[1-9]/.test(b.charAt(G))?(a=b.charAt(G),G++):(a=null,0===H&&d("[1-9]")),null!==a){if(/^[0-9]/.test(b.charAt(G))?(e=b.charAt(G),G++):(e=null,0===H&&d("[0-9]")),null!==e)for(c=[];null!==e;)c.push(e),/^[0-9]/.test(b.charAt(G))?(e=b.charAt(G),G++):(e=null,0===H&&d("[0-9]"));else c=null;null!==c?a=[a,c]:(a=null,G=i)}else a=null,G=i;if(null!==a)if(46===b.charCodeAt(G)?(c=".",G++):(c=null,0===H&&d('"."')),null!==c){for(i=G,e=[],/^[0-9]/.test(b.charAt(G))?(f=b.charAt(G),G++):(f=null,0===H&&d("[0-9]"));null!==f;)e.push(f),/^[0-9]/.test(b.charAt(G))?(f=b.charAt(G),G++):(f=null,0===H&&d("[0-9]"));null!==e?(/^[1-9]/.test(b.charAt(G))?(f=b.charAt(G),G++):(f=null,0===H&&d("[1-9]")),null!==f?e=[e,f]:(e=null,G=i)):(e=null,G=i),null!==e?a=[a,c,e]:(a=null,G=h)}else a=null,G=h;else a=null,G=h;return null!==a&&(a=function(a,b,c){return b.join("")+"."+c.join("")}(g,a[0],a[2])),null===a&&(G=g),a}function t(){var a,c,e,f,g;if(f=G,48===b.charCodeAt(G)?(a="0",G++):(a=null,0===H&&d('"0"')),null===a)if(g=G,/^[1-9]/.test(b.charAt(G))?(a=b.charAt(G),G++):(a=null,0===H&&d("[1-9]")),null!==a){for(c=[],/^[0-9]/.test(b.charAt(G))?(e=b.charAt(G),G++):(e=null,0===H&&d("[0-9]"));null!==e;)c.push(e),/^[0-9]/.test(b.charAt(G))?(e=b.charAt(G),G++):(e=null,0===H&&d("[0-9]"));null!==c?a=[a,c]:(a=null,G=g)}else a=null,G=g;return null!==a&&(a=function(a,b){return"0"===b?"0":b[0].concat(b[1].join(""))}(f,a)),null===a&&(G=f),a}function u(){var a,c;return c=G,32===b.charCodeAt(G)?(a=" ",G++):(a=null,0===H&&d('" "')),null!==a&&(a=function(a){return" "}(c)),null===a&&(G=c),a}function v(){var a,c;return c=G,94===b.charCodeAt(G)?(a="^",G++):(a=null,0===H&&d('"^"')),null!==a&&(a=function(a){return"^"}(c)),null===a&&(G=c),a}function w(){var a,c;return c=G,34===b.charCodeAt(G)?(a='"',G++):(a=null,0===H&&d('"\\""')),null!==a&&(a=function(a){return'"'}(c)),null===a&&(G=c),a}function x(){var a,c;return c=G,91===b.charCodeAt(G)?(a="[",G++):(a=null,0===H&&d('"["')),null===a&&(93===b.charCodeAt(G)?(a="]",G++):(a=null,0===H&&d('"]"'))),null!==a&&(a=function(a,b){return b}(c,a)),null===a&&(G=c),a}function y(){var a,c;return c=G,40===b.charCodeAt(G)?(a="(",G++):(a=null,0===H&&d('"("')),null===a&&(41===b.charCodeAt(G)?(a=")",G++):(a=null,0===H&&d('")"'))),null!==a&&(a=function(a,b){return b}(c,a)),null===a&&(G=c),a}function z(){var a,c;return c=G,44===b.charCodeAt(G)?(a=",",G++):(a=null,0===H&&d('","')),null!==a&&(a=function(a){return","}(c)),null===a&&(G=c),a}function A(){var a,c;return c=G,59===b.charCodeAt(G)?(a=";",G++):(a=null,0===H&&d('";"')),null!==a&&(a=function(a){return";"}(c)),null===a&&(G=c),a}function B(){var a,c;return c=G,61===b.charCodeAt(G)?(a="=",G++):(a=null,0===H&&d('"="')),null!==a&&(a=function(a){return"="}(c)),null===a&&(G=c),a}function C(){var a,c;return c=G,/^[a-z]/.test(b.charAt(G))?(a=b.charAt(G),G++):(a=null,0===H&&d("[a-z]")),null===a&&(/^[A-Z]/.test(b.charAt(G))?(a=b.charAt(G),G++):(a=null,0===H&&d("[A-Z]")),null===a&&(/^[0-9]/.test(b.charAt(G))?(a=b.charAt(G),G++):(a=null,0===H&&d("[0-9]")),null===a&&(45===b.charCodeAt(G)?(a="-",G++):(a=null,0===H&&d('"-"')),null===a&&(95===b.charCodeAt(G)?(a="_",G++):(a=null,0===H&&d('"_"')),null===a&&(46===b.charCodeAt(G)?(a=".",G++):(a=null,0===H&&d('"."'))))))),null!==a&&(a=function(a,b){return b}(c,a)),null===a&&(G=c),a}function D(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}function E(){for(var a=1,c=1,d=!1,e=0;e<Math.max(G,I);e++){var f=b.charAt(e);"\n"===f?(d||a++,c=1,d=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(a++,c=1,d=!0):(c++,d=!1)}return{line:a,column:c}}var F={fragment:e,range:f,path:g,local_path:h,indexStep:i,indirectionStep:j,terminus:k,idAssertion:l,textLocationAssertion:m,parameter:n,csv:o,valueNoSpace:p,value:q,escapedSpecialChars:r,number:s,integer:t,space:u,circumflex:v,doubleQuote:w,squareBracket:x,parentheses:y,comma:z,semicolon:A,equal:B,character:C};if(void 0!==c){if(void 0===F[c])throw new Error("Invalid rule name: "+a(c)+".")}else c="fragment";var G=0,H=0,I=0,J=[],K=F[c]();if(null===K||G!==b.length){var L=Math.max(G,I),M=L<b.length?b.charAt(L):null,N=E();throw new this.SyntaxError(D(J),M,L,N.line,N.column)}return K},toSource:function(){return this._source}};return b.SyntaxError=function(b,c,d,e,f){function g(b,c){var d,e;switch(b.length){case 0:d="end of input";break;case 1:d=b[0];break;default:d=b.slice(0,b.length-1).join(", ")+" or "+b[b.length-1]}return e=c?a(c):"end of input","Expected "+d+" but "+e+" found."}this.name="SyntaxError",this.expected=b,this.found=c,this.message=g(b,c),this.offset=d,this.line=e,this.column=f},b.SyntaxError.prototype=Error.prototype,b}(),b.CFIInstructions={getNextNode:function(a,b,c,d,e){var f;return f=a%2==0?this.elementNodeStep(a,b,c,d,e):this.inferTargetTextNode(a,b,c,d,e)},followIndirectionStep:function(a,c,d,e,f){var g,h,i,j;if(void 0===c||!c.is("iframe"))throw b.NodeTypeError(c,"expected an iframe element");return c.is("iframe")?(g=c.contents(),h=this.applyBlacklist(g.children(),d,e,f),i=$(h[0]),j=this.getNextNode(a,i,d,e,f)):void 0},textTermination:function(a,c,d){var e;if(void 0===a)throw b.NodeTypeError(a,"expected a terminating node, or node list");if(0===a.length)throw b.TerminusError("Text","Text offset:"+c,"no nodes found for termination condition");return e=this.injectCFIMarkerIntoText(a,c,d)},targetIdMatchesIdAssertion:function(a,b){return a.attr("id")===b?!0:!1},elementNodeStep:function(a,c,d,e,f){var g,h,i,j=a/2-1;if(h=this.applyBlacklist(c.children(),d,e,f),i=h.length,this.indexOutOfRange(j,i))throw b.OutOfRangeError(j,i-1,"");return g=$(h[j])},retrieveItemRefHref:function(a,b){return $("#"+a.attr("idref"),b).attr("href")},indexOutOfRange:function(a,b){return a>b-1?!0:!1},injectCFIMarkerIntoText:function(a,c,d){var e,f,g,h,i,j=0;for(e=0;e<=a.length;e++)if(3===a[e].nodeType){if(currNodeMaxIndex=a[e].nodeValue.length+j,f=c-j,currNodeMaxIndex>c)return g=a[e].nodeValue,a[e].nodeValue=g.slice(0,f),h=$(d).insertAfter(a.eq(e)),i=$(document.createTextNode(g.slice(f,g.length))),$(i).insertAfter(h),h;if(currNodeMaxIndex==c)return h=$(d).insertAfter(a.eq(e));j=currNodeMaxIndex}throw b.TerminusError("Text","Text offset:"+c,"The offset exceeded the length of the text")},inferTargetTextNode:function(a,c,d,e,f){var g,h,i,j,k;if(g=this.applyBlacklist(c.contents(),d,e,f),i=(parseInt(a)+1)/2-1,h=0,k=!1,j=g.filter(function(){return h!==i?(this.nodeType===Node.TEXT_NODE?k=!0:k&&this.nodeType!==Node.TEXT_NODE&&this!==g.lastChild&&(h++,k=!1),!1):this.nodeType===Node.TEXT_NODE?(k=!0,!0):k&&this.nodeType!==Node.TEXT_NODE?(h++,k=!1,!1):void 0}),0===j.length)throw b.OutOfRangeError(logicalTargetTextNodeIndex,h,"Index out of range");return j},applyBlacklist:function(a,b,c,d){var e;return e=a.filter(function(){var a=$(this),e=!0;return b&&$.each(b,function(b,c){return a.hasClass(c)?(e=!1,!1):void 0}),c&&$.each(c,function(b,c){return a.is(c)?(e=!1,!1):void 0}),d&&$.each(d,function(b,c){return a.attr("id")===c?(e=!1,!1):void 0}),e})}},b.Interpreter={getContentDocHref:function(a,c,d,e,f){var g=$(c),h=decodeURI(a),i=b.Parser.parse(h);if(!i||"CFIAST"!==i.type)throw b.NodeTypeError(i,"expected CFI AST root node");var j=$($("package",g)[0]),k=this.interpretIndexStepNode(i.cfiString.path,j,d,e,f);return foundHref=this.searchLocalPathForHref(k,g,i.cfiString.localPath,d,e,f),foundHref?foundHref:void 0},injectElement:function(a,c,d,e,f,g){var h,i,j,k=decodeURI(a),l=b.Parser.parse(k);return i=this.getFirstIndirectionStepNum(l),h=l.cfiString.localPath.steps[i],h.type="indexStep",j=this.interpretLocalPath(l.cfiString.localPath,i,$("html",c),e,f,g),j=this.interpretTextTerminusNode(l.cfiString.localPath.termStep,j,d)},injectRangeElements:function(a,c,d,e,f,g,h){var i,j,k,l,m,n=decodeURI(a),o=b.Parser.parse(n);return j=this.getFirstIndirectionStepNum(o),i=o.cfiString.localPath.steps[j],i.type="indexStep",k=this.interpretLocalPath(o.cfiString.localPath,j,$("html",c),f,g,h),l=this.interpretLocalPath(o.cfiString.range1,0,k,f,g,h),l=this.interpretTextTerminusNode(o.cfiString.range1.termStep,l,d),m=this.interpretLocalPath(o.cfiString.range2,0,k,f,g,h),m=this.interpretTextTerminusNode(o.cfiString.range2.termStep,m,e),{startElement:l[0],endElement:m[0]}},getTargetElement:function(a,c,d,e,f){var g,h,i,j=decodeURI(a),k=b.Parser.parse(j);return h=this.getFirstIndirectionStepNum(k),g=k.cfiString.localPath.steps[h],g.type="indexStep",i=this.interpretLocalPath(k.cfiString.localPath,h,$("html",c),d,e,f)},getRangeTargetElements:function(a,c,d,e,f){var g,h,i,j,k,l=decodeURI(a),m=b.Parser.parse(l);return h=this.getFirstIndirectionStepNum(m),g=m.cfiString.localPath.steps[h],g.type="indexStep",i=this.interpretLocalPath(m.cfiString.localPath,h,$("html",c),d,e,f),j=this.interpretLocalPath(m.cfiString.range1,0,i,d,e,f),k=this.interpretLocalPath(m.cfiString.range2,0,i,d,e,f),{startElement:j[0],endElement:k[0]}},getTargetElementWithPartialCFI:function(a,c,d,e,f){var g=decodeURI(a),h=b.Parser.parse(g),i=this.interpretIndexStepNode(h.cfiString.path,$("html",c),d,e,f);return i=this.interpretLocalPath(h.cfiString.localPath,0,i,d,e,f)},getTextTerminusInfoWithPartialCFI:function(a,c,d,e,f){var g,h=decodeURI(a),i=b.Parser.parse(h),j=this.interpretIndexStepNode(i.cfiString.path,$("html",c),d,e,f);return j=this.interpretLocalPath(i.cfiString.localPath,0,j,d,e,f),g=parseInt(i.cfiString.localPath.termStep.offsetValue),{textNode:j,textOffset:g}},getFirstIndirectionStepNum:function(a){var b=0;for(b;b<=a.cfiString.localPath.steps.length-1;b++)if(nextStepNode=a.cfiString.localPath.steps[b],"indirectionStep"===nextStepNode.type)return b},interpretLocalPath:function(a,b,c,d,e,f){var g,h=b;for(h;h<=a.steps.length-1;h++)g=a.steps[h],"indexStep"===g.type?c=this.interpretIndexStepNode(g,c,d,e,f):"indirectionStep"===g.type&&(c=this.interpretIndirectionStepNode(g,c,d,e,f));return c},interpretIndexStepNode:function(a,c,d,e,f){if(void 0===a||"indexStep"!==a.type)throw b.NodeTypeError(a,"expected index step node");var g=b.CFIInstructions.getNextNode(a.stepLength,c,d,e,f);if(a.idAssertion&&!b.CFIInstructions.targetIdMatchesIdAssertion(g,a.idAssertion))throw b.CFIAssertionError(a.idAssertion,g.attr("id"),"Id assertion failed");return g},interpretIndirectionStepNode:function(a,c,d,e,f){if(void 0===a||"indirectionStep"!==a.type)throw b.NodeTypeError(a,"expected indirection step node");var g=b.CFIInstructions.followIndirectionStep(a.stepLength,c,d,e);if(a.idAssertion&&!b.CFIInstructions.targetIdMatchesIdAssertion(g,a.idAssertion))throw b.CFIAssertionError(a.idAssertion,g.attr("id"),"Id assertion failed");return g},interpretTextTerminusNode:function(a,c,d){if(void 0===a||"textTerminus"!==a.type)throw b.NodeTypeError(a,"expected text terminus node");var e=b.CFIInstructions.textTermination(c,a.offsetValue,d);return e},searchLocalPathForHref:function(a,c,d,e,f,g){var h,i=0;for(i=0;i<=d.steps.length-1;i++)if(h=d.steps[i],"indexStep"===h.type?a=this.interpretIndexStepNode(h,a,e,f,g):"indirectionStep"===h.type&&(a=this.interpretIndirectionStepNode(h,a,e,f,g)),a.is("itemref"))return b.CFIInstructions.retrieveItemRefHref(a,c);return void 0}},b.NodeTypeError=function(a,b){function c(){this.node=a}return c.prototype=new Error(b),c.constructor=c,new c},b.OutOfRangeError=function(a,b,c){function d(){this.targetIndex=a,this.maxIndex=b}return d.prototype=new Error(c),d.constructor=d(),new d},b.TerminusError=function(a,b,c){function d(){this.terminusType=a,this.terminusCondition=b}return d.prototype=new Error(c),d.constructor=d(),new d},b.CFIAssertionError=function(a,b,c){function d(){this.expectedAssertion=a,this.targetElementAssertion=b}return d.prototype=new Error(c),d.constructor=d(),new d},b.Generator={generateCharOffsetRangeComponent:function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n;return this.validateStartTextNode(a),this.validateStartTextNode(c),$(a).parent()[0]===$(c).parent()[0]?(j=this.createCFITextNodeStep($(a),b,e,f,g),l=this.createCFITextNodeStep($(c),d,e,f,g),n=this.createCFIElementSteps($(a).parent(),"html",e,f,g),n.substring(1,n.length)+","+j+","+l):(h=document.createRange(),h.setStart(a,b),h.setEnd(c,d),i=h.commonAncestorContainer,j=this.createCFITextNodeStep($(a),b,e,f,g),k=this.createCFIElementSteps($(a).parent(),i,e,f,g)+j,l=this.createCFITextNodeStep($(c),d,e,f,g),m=this.createCFIElementSteps($(c).parent(),i,e,f,g)+l,n=this.createCFIElementSteps($(i),"html",e,f,g),n.substring(1,n.length)+","+k+","+m)},generateElementRangeComponent:function(a,b,c,d,e){var f,g,h,i,j;if(this.validateStartElement(a),this.validateStartElement(b),a===b)throw new Error("Start and end element cannot be the same for a CFI range");return f=document.createRange(),f.setStart(a),f.setEnd(b),g=f.commonAncestorContainer,h=this.createCFIElementSteps($(a),g,c,d,e),i=this.createCFIElementSteps($(b),g,c,d,e),j=this.createCFIElementSteps($(g),"html",c,d,e),j.substring(1,j.length)+","+h+","+i},generateCharacterOffsetCFIComponent:function(a,b,c,d,e){var f,g;return this.validateStartTextNode(a,b),f=this.createCFITextNodeStep($(a),b,c,d,e),g=this.createCFIElementSteps($(a).parent(),"html",c,d,e)+f,g.substring(1,g.length)},generateElementCFIComponent:function(a,b,c,d){var e;return this.validateStartElement(a),e=this.createCFIElementSteps($(a),"html",b,c,d),e.substring(1,e.length)},generatePackageDocumentCFIComponent:function(a,b,c,d,e){return this.validateContentDocumentName(a),this.validatePackageDocument(b,a),$itemRefStartNode=$("itemref[idref='"+a+"']",$(b)),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",c,d,e),packageDocCFIComponent+"!"},generatePackageDocumentCFIComponentWithSpineIndex:function(a,b,c,d,e){return $itemRefStartNode=$($("spine",b).children()[a]),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",c,d,e),packageDocCFIComponent+"!"},generateCompleteCFI:function(a,b){return"epubcfi("+a+b+")"},validateStartTextNode:function(a,c){if(!a)throw new b.NodeTypeError(a,"Cannot generate a character offset from a starting point that is not a text node");if(3!=a.nodeType)throw new b.NodeTypeError(a,"Cannot generate a character offset from a starting point that is not a text node");if(0>c)throw new b.OutOfRangeError(c,0,"Character offset cannot be less than 0");if(c>a.nodeValue.length)throw new b.OutOfRangeError(c,a.nodeValue.length-1,"character offset cannot be greater than the length of the text node")},validateStartElement:function(a){if(!a)throw new b.NodeTypeError(a,"CFI target element is undefined");if(!a.nodeType||1!==a.nodeType)throw new b.NodeTypeError(a,"CFI target element is not an HTML element")},validateContentDocumentName:function(a){if(!a)throw new Error("The idref for the content document, as found in the spine, must be supplied")},validatePackageDocument:function(a,b){if(!a)throw new Error("A package document must be supplied to generate a CFI");if(0===$($("itemref[idref='"+b+"']",a)[0]).length)throw new Error("The idref of the content document could not be found in the spine")},createCFITextNodeStep:function(a,c,d,e,f){var g,h,i,j;g=a.parent(),h=b.CFIInstructions.applyBlacklist(g.contents(),d,e,f);var k,l,m=0,n=0,o=0;return $.each(h,function(b){if(this.nodeType===Node.TEXT_NODE){if(this===a[0])return k?(j=l,o=n):j=m,!1;k=!0,n+=this.length,void 0===l&&(l=m,m+=1)}else k=!1,l=void 0,n=0}),i=2*j+1,"/"+i+":"+(o+c)},createCFIElementSteps:function(a,c,d,e,f){var g,h,i,j,k;return g=b.CFIInstructions.applyBlacklist(a.parent().children(),d,e,f),$.each(g,function(b,c){return this===a[0]?(i=b,!1):void 0}),j=2*(i+1),k=a.attr("id")?"/"+j+"["+a.attr("id")+"]":"/"+j,h=a.parent(),h.is(c)||a.is(c)?"html"===c?"!"+k:k:this.createCFIElementSteps(h,c,d,e,f)+k}};var c=b.Interpreter,d=b.Generator,e=b.CFIInstructions;if(a.EPUBcfi)throw new Error("The EPUB cfi library has already been defined");a.EPUBcfi=b;var f=b.CFIInstructions,g=b.Parser,h=b.OutOfRangeError,i=b.Interpreter,j=b.NodeTypeError,k=b.OutOfRangeError,l=b.TerminusError,m=b.CFIAssertionError;a.EPUBcfi=b={getContentDocHref:function(a,b){return c.getContentDocHref(a,b)},injectElement:function(a,b,d,e,f,g){return c.injectElement(a,b,d,e,f,g)},getTargetElement:function(a,b,d,e,f){return c.getTargetElement(a,b,d,e,f)},getTargetElementWithPartialCFI:function(a,b,d,e,f){return c.getTargetElementWithPartialCFI(a,b,d,e,f)},getTextTerminusInfoWithPartialCFI:function(a,b,d,e,f){return c.getTextTerminusInfoWithPartialCFI(a,b,d,e,f)},generateCharacterOffsetCFIComponent:function(a,b,c,e,f){return d.generateCharacterOffsetCFIComponent(a,b,c,e,f)},generateElementCFIComponent:function(a,b,c,e){return d.generateElementCFIComponent(a,b,c,e)},generatePackageDocumentCFIComponent:function(a,b,c,e,f){return d.generatePackageDocumentCFIComponent(a,b,c,e,f)},generatePackageDocumentCFIComponentWithSpineIndex:function(a,b,c,e,f){return d.generatePackageDocumentCFIComponentWithSpineIndex(a,b,c,e,f)},generateCompleteCFI:function(a,b){return d.generateCompleteCFI(a,b)},injectElementAtOffset:function(a,b,c){return e.injectCFIMarkerIntoText(a,b,c)},injectRangeElements:function(a,b,d,e,f,g,h){return c.injectRangeElements(a,b,d,e,f,g,h)},getRangeTargetElements:function(a,b,d,e,f){return c.getRangeTargetElements(a,b,d,e,f)},generateCharOffsetRangeComponent:function(a,b,c,e,f,g,h){return d.generateCharOffsetRangeComponent(a,b,c,e,f,g,h)},generateElementRangeComponent:function(a,b,c,e,f){return d.generateElementRangeComponent(a,b,c,e,f)}},b.CFIInstructions=f,b.Parser=g,b.OutOfRangeError=h,b.Interpreter=i,b.Generator=d,b.NodeTypeError=j,b.OutOfRangeError=k,b.TerminusError=l,b.CFIAssertionError=m}("undefined"==typeof window?this:window),define("epubCfi",function(){}),ReadiumSDK.Views.CfiNavigationLogic=function(a,b,c){function d(){return c.paginationInfo&&!!c.paginationInfo.rightToLeft}function e(){return c.paginationInfo&&!!c.paginationInfo.isVerticalWritingMode}function f(a,b,c){return c?a.top>=0&&a.top<b.height:a.left>=0&&a.left<b.width}function g(){return!c.paginationInfo||e()?b.width():c.paginationInfo.columnWidth+c.paginationInfo.columnGap}function h(){return e()?{top:c.paginationInfo?c.paginationInfo.pageOffset:0}:{left:(c.paginationInfo?c.paginationInfo.pageOffset:0)*(d()?-1:1)}}function i(a,b,c){var d=ReadiumSDK.Helpers.Rect.fromElement(a);_.isNaN(d.left)&&(d=new ReadiumSDK.Helpers.Rect(a.position().top,a.position().left,0,0));var e=b.top||0,f=d.bottom()>e,g=void 0!==b.bottom?d.top<b.bottom:!0,h=0;return f&&g?c?(d.top<=e&&(h=Math.ceil(100*(e-d.top)/d.height)),100-h):100:0}function j(a,c,h){var i=m(a),j=i.clientRectangles;if(0===j.length)return null;var k=d(),n=e(),o=g(),q={width:b.width(),height:b.height()};1===j.length&&p(j[0],q,o,k,n,!0);for(var r=0,s=0,t=j.length;t>s;++s)if(f(j[s],q,n)){r=h?l(j,s):100;break}return r}function k(a,f){var i=h(),j=m(a,i),k=j.clientRectangles;if(0===k.length)return null;var l=d(),n=e(),o=g(),r=b.height(),s=b.width();f&&q(k,f,r,o,l,n);var t=_.first(k);1===k.length&&p(t,{height:r,width:s},o,l,n);var u;if(n){var v=t.top;u=Math.floor(v/r)}else{var w=t.left;l&&(w=o*(c.paginationInfo?c.paginationInfo.visibleColumnCount:1)-w),u=Math.floor(w/o)}return 0>u?u=0:u>=(c.paginationInfo?c.paginationInfo.columnCount:1)&&(u=c.paginationInfo?c.paginationInfo.columnCount-1:0),u}function l(a,b){var c=0,d=0;return a.length>1?_.each(a,function(a,e){c+=a.height,e>=b&&(d+=a.height)}):(c=a[0].height,d=a[0].height-Math.max(0,-a[0].top)),d===c?100:Math.floor(100*d/c)}function m(a,b){b=b||{};for(var c=b.left||0,d=b.top||0,e=n(a[0].getBoundingClientRect(),c,d),f=[],g=a[0].getClientRects(),h=0,i=g.length;i>h;++h)g[h].height>0&&f.push(n(g[h],c,d));return 0===f.length&&(a=a.next(),a.length)?m(a,b):{wrapperRectangle:e,clientRectangles:f}}function n(a,b,c){var d={left:a.left,right:a.right,top:a.top,bottom:a.bottom,width:a.right-a.left,height:a.bottom-a.top};return o(d,b,c),d}function o(a,b,c){a.left+=b,a.right+=b,a.top+=c,a.bottom+=c}function p(a,b,c,d,e,g){if(!e){for(d&&(c*=-1);a.top<0;)o(a,-c,b.height);if(g)for(;a.bottom>=b.height&&!f(a,b,e);)o(a,c,-b.height)}}function q(a,b,c,d,e,f){if(!f){var g=_.reduce(a,function(a,b){return a+b.height},0),h=g*b/100;if(a.length>1){var i=0;do{if(i+=a[0].height,i>h)break;a.shift()}while(a.length>1)}else{for(e&&(d*=-1);a[0].bottom>=c;)o(a[0],d,-c);a[0].top+=h,a[0].height-=h}}}function r(a,c,d,e){var f=b[0].contentDocument,g="epubcfi("+a+")",h=EPUBcfi.getTargetElementWithPartialCFI(g,f,c,d,e);return h&&0!=h.length?h:void console.log("Can't find element for CFI: "+a)}function s(a){var b={cfi:"",x:0,y:0},c=a.indexOf("@");if(-1!=c){var d=a.substring(c+1),e=d.indexOf(":");-1!=e?(b.x=parseInt(d.substr(0,e)),b.y=parseInt(d.substr(e+1))):console.log("Unexpected terminating step format"),b.cfi=a.substring(0,c)}else b.cfi=a;return b}function t(a){if(a.nodeType===Node.TEXT_NODE){var b=a.nodeValue.replace(/\n/g,"");return b=b.replace(/ /g,""),b.length>0}return!1}c=c||{},this.getRootElement=function(){return b[0].contentDocument.documentElement};var u=c.rectangleBased?j:i;this.findFirstVisibleElement=function(a){"object"!=typeof a&&(a={top:a});var b,c=null,d=0;return b=$("body",this.getRootElement()).find(":not(iframe)").contents().filter(function(){return t(this)||"img"===this.nodeName.toLowerCase()}),$.each(b,function(){var b;b=this.nodeType===Node.TEXT_NODE?$(this).parent():$(this);var e=u(b,a,!0);return e?(c=b,d=100-e,!1):!0}),{$element:c,percentY:d}},this.getFirstVisibleElementCfi=function(a){var b=this.findFirstVisibleElement(a);if(!b.$element)return void console.log("Could not generate CFI no visible element on page");var c=EPUBcfi.Generator.generateElementCFIComponent(b.$element[0]);return"!"==c[0]&&(c=c.substring(1)),c+"@0:"+b.percentY},this.getPageForElementCfi=function(a,b,c,d){var e=s(a),f=r(e.cfi,b,c,d);return f?this.getPageForPointOnElement(f,e.x,e.y):-1},this.getElementByCfi=function(a,b,c,d){var e=s(a);return r(e.cfi,b,c,d)},this.getPageForElement=function(a){return this.getPageForPointOnElement(a,0,0)},this.getPageForPointOnElement=function(b,d,e){var f;if(c.rectangleBased)return f=k(b,e),null===f?(console.warn("Impossible to locate a hidden element: ",b),0):f;var g=this.getVerticalOffsetForPointOnElement(b,d,e);return Math.floor(g/a.height())},this.getVerticalOffsetForElement=function(a){return this.getVerticalOffsetForPointOnElement(a,0,0)},this.getVerticalOffsetForPointOnElement=function(a,b,c){var d=ReadiumSDK.Helpers.Rect.fromElement(a);return Math.ceil(d.top+c*d.height/100)},this.getElementById=function(a){var c=b[0].contentDocument,d=$(c.getElementById(a));return 0==d.length?void 0:d},this.getPageForElementId=function(a){var b=this.getElementById(a);return b?this.getPageForElement(b):-1},this.getFirstVisibleMediaOverlayElement=function(a){function b(c){if(!c||!c.length)return void 0;for(var d=0,g=c.length;g>d;d++){var h=c[d];if(h){var i=$(h);if(i.data("mediaOverlayData")){var j=e.getElementVisibility(i,a);if(j&&(f||(f=h),100==j))return h}else{var k=b(h.children);if(k)return k}}}return void 0}var c=this.getRootElement();if(!c)return void 0;var d=$("body",c);if(!d||!d.length||!d[0])return void 0;var e=this,f=void 0,g=b([d[0]]);return g||(g=f),g},this.getElementVisibility=function(a,b){return u(a,b,!0)},this.isElementVisible=u,this.getAllVisibleElementsWithSelector=function(a,b){var c=$(a,this.getRootElement()).filter(function(a){return!0}),d=[];$.each(c,function(){d.push($(this))});var e=this.getVisibleElements(d,b);return e},this.getVisibleElements=function(a,b){var c=[];return $.each(a,function(){var a=this,d=u(a,b,!0);if(d){var e=a;return c.push({element:e[0],percentVisible:d}),!0}return null===d?!0:0===c.length}),c},this.getVisibleTextElements=function(a){var b=this.getTextElements($("body",this.getRootElement()));return this.getVisibleElements(b,a)},this.getMediaOverlayElements=function(a){function b(a){if(void 0!=a)for(var d=0,e=a.length;e>d;d++){var f=$(a[d]);f.data("mediaOverlayData")?c.push(f):b(f[0].children)}}var c=[];return b([a[0]]),c},this.getTextElements=function(a){var b=[];return a.find(":not(iframe)").contents().each(function(){t(this)&&b.push($(this).parent())}),b},this.getElement=function(a){var b=$(a,this.getRootElement());return b.length>0?b:void 0}},define("cfiNavigationLogic",["readiumSDK","epubCfi"],function(a){return function(){var b;return b||a.cfiNavigationLogic}}(this)),ReadiumSDK.Views.OnePageView=function(a,b,c,d){function e(a){if(a){t=!0;var b=l[0].contentDocument;j=$("html",b),j&&0!=j.length||(j=$("svg",b)),w&&o.applyBookStyles(),h(),v.onIFrameLoad()}}function f(){w&&j&&y&&ReadiumSDK.Helpers.UpdateHtmlFontSize(j,y.fontSize)}function g(){if(!l||!l.length)return 0;if(ReadiumSDK.Helpers.isIframeAlive(l[0])){var a=l[0].contentWindow,b=l[0].contentDocument,c=Math.round(parseFloat(a.getComputedStyle(b.documentElement).height));return c}if(j){console.error("getContentDocHeight ??");var d=j.height();return d}return 0}function h(){x.width=0,x.height=0;var a=void 0,b=!1,c=void 0,d=void 0,e=l[0].contentDocument,f=$("meta[name=viewport]",e).attr("content");if(f||(f=$("meta[name=viewbox]",e).attr("content")),f&&(a=i(f)),!a&&e&&e.documentElement&&e.documentElement.nodeName&&"svg"==e.documentElement.nodeName.toLowerCase()){var g=void 0,h=void 0,j=e.documentElement.getAttribute("width"),k=j&&j.length>=1&&"%"==j[j.length-1];if(j)try{g=parseInt(j,10)}catch(n){}g&&k&&(c=g,g=void 0);var o=e.documentElement.getAttribute("height"),p=o&&o.length>=1&&"%"==o[o.length-1];if(o)try{h=parseInt(o,10)}catch(n){}h&&p&&(d=h,h=void 0),g&&h&&(a={width:g,height:h})}if(!a&&m&&(f=m.getRenditionViewport(),f&&(a=i(f),a&&console.log("Viewport: using rendition:viewport dimensions"))),!a){var q=$(e).find("img");if(q.length>0){a={width:q.width(),height:q.height()};var r=m&&m.media_type&&m.media_type.length&&0==m.media_type.indexOf("image/");r||console.warn("Viewport: using img dimensions!")}else if(q=$(e).find("image"),q.length>0){var g=void 0,h=void 0,j=q[0].getAttribute("width");if(j)try{g=parseInt(j,10)}catch(n){}var o=q[0].getAttribute("height");if(o)try{h=parseInt(o,10)}catch(n){}g&&h&&(a={width:g,height:h},b=!0,console.warn("Viewport: using image dimensions!"))}}if(!a){g=s.width(),h=s.height();var t=$("iframe.iframe-fixed",s).length>1;t&&(g*=.5),c&&(g*=c/100),d&&(h*=d/100),a={width:g,height:h},b=!0,console.warn("Viewport: using browser / e-reader viewport dimensions!")}a&&(x.width=a.width,x.height=a.height)}function i(a){for(var b=a.replace(/\s/g,"").split(","),c={},d=0;d<b.length;d++){var e=b[d].split("=");2==e.length&&(c[e[0]]=e[1])}var f=Number.NaN,g=Number.NaN;return c.width&&(f=parseInt(c.width)),c.height&&(g=parseInt(c.height)),isNaN(f)||isNaN(g)?void 0:{width:f,height:g}}_.extend(this,Backbone.Events);var j,k,l,m,n,o=this,p=a.spine,q=a.iframeLoader,r=a.bookStyles,s=a.$viewport,t=!1,u=function(a){var c=function(a,b){this.begin=a,this.end=b},d=new c(function(a,b,c,d,e,f,g){d.css("opacity","0")},function(a,b,c,d,e,f,g){d.css("transform","none"),ReadiumSDK.Helpers.CSSTransition(d,"opacity 150ms ease-out"),d.css("opacity","1")}),e=new c(function(a,b,c,d,e,f,g){d.css("opacity","0");var h=Math.ceil(e*a),i=.8*h*(2===g?1:-1),j=ReadiumSDK.Helpers.CSSTransformString({left:Math.round(i),origin:"50% 50% 0",enable3D:k});d.css(j)},function(a,b,c,d,e,f,g){d.css("opacity","1"),ReadiumSDK.Helpers.CSSTransition(d,"transform 150ms ease-out"),d.css("transform","none")}),f=new c(function(a,b,c,d,e,f,g){d.css("opacity","0");var h=Math.ceil(e*a),i=1.7*h*(2===g?1:-1),j=ReadiumSDK.Helpers.CSSTransformString({left:Math.round(i),angle:30*(2===g?-1:1),origin:"50% 50% 0",enable3D:k});d.css(j)},function(a,b,c,d,e,f,g){d.css("opacity","1"),ReadiumSDK.Helpers.CSSTransition(d,"transform 300ms ease-in-out"),d.css("transform","none")}),g=new c(function(a,c,d,e,f,g,h){e.css("opacity","0");for(var i=!1,j=!1,l=!1,m=0;m<b.length;m++){var n=b[m].toLowerCase();if(n.indexOf("left")>=0){i=!0;break}if(n.indexOf("right")>=0){l=!0;break}if(n.indexOf("center")>=0){j=!0;break}}var o=Math.ceil(f*a),p=.5*o*(i||j&&1===h?1:-1),q=ReadiumSDK.Helpers.CSSTransformString({scale:.2,left:Math.round(p),angle:30*(i||j&&1===h?1:-1),origin:"50% 50% 0",enable3D:k});e.css(q)},function(a,b,c,d,e,f,g){d.css("opacity","1"),ReadiumSDK.Helpers.CSSTransition(d,"transform 400ms ease-out"),d.css("transform","none")}),h=[];h.push(d),h.push(e),h.push(f),h.push(g);var i=a.disablePageTransitions||!1,j=-1,k=new ReadiumSDK.Models.ViewerSettings({}).enableGPUHardwareAccelerationCSS3D,l=void 0;this.updateOptions=function(a){l=a;var b=l;b&&"undefined"!=typeof b.enableGPUHardwareAccelerationCSS3D||(b=new ReadiumSDK.Models.ViewerSettings({})),b.enableGPUHardwareAccelerationCSS3D&&(k=!0),null!==a.pageTransition&&"undefined"!=typeof a.pageTransition&&(j=a.pageTransition)},this.updateOptions(a);var m=0,n=!1,p=!1;this.updatePageSwitchDir=function(a,b){p||(m=a,n=b)},this.onIFrameLoad=function(){p=!0},this.transformContentImmediate_BEGIN=function(a,b,c,d){var e=n||p;if(p=!1,!i&&-1!==j&&(ReadiumSDK.Helpers.CSSTransition(a,"all 0 ease 0"),e)){var f=j>=0&&j<h.length?h[j]:void 0;0!==m&&f?f.begin(b,c,d,a,o.meta_width(),o.meta_height(),m):a.css("opacity","0")}},this.transformContentImmediate_END=function(a,b,c,d){return i||-1===j?void a.css("transform","none"):void setTimeout(function(){var e=j>=0&&j<h.length?h[j]:void 0;0!==m&&e?e.end(b,c,d,a,o.meta_width(),o.meta_height(),m):(a.css("transform","none"),ReadiumSDK.Helpers.CSSTransition(a,"opacity 250ms linear"),a.css("opacity","1"))},10)}},v=new u(a),w=c||!1,x={width:0,height:0};this.element=function(){return k},this.meta_height=function(){return x.height},this.meta_width=function(){return x.width},this.isDisplaying=function(){return t},this.render=function(){var a=ReadiumSDK.Helpers.loadTemplate("single_page_frame",{});k=$(a),n=$("#scaler",k),ReadiumSDK.Helpers.CSSTransition(k,"all 0 ease 0"),k.css("transform","none");var c=d.viewerSettings();c&&"undefined"!=typeof c.enableGPUHardwareAccelerationCSS3D||(c=new ReadiumSDK.Models.ViewerSettings({})),c.enableGPUHardwareAccelerationCSS3D&&k.css("transform","translateZ(0)"),k.css("height","100%"),k.css("width","100%");for(var e=0,f=b.length;f>e;e++)k.addClass(b[e]);return l=$("iframe",k),this},this.decorateIframe=function(){l&&l.length&&(l.css("border-bottom","1px dashed silver"),l.css("border-top","1px dashed silver"))},this.remove=function(){t=!1,m=void 0,k.remove()},this.clear=function(){t=!1,l[0].src=""},this.currentSpineItem=function(){return m};var y=void 0;this.setViewSettings=function(a){y=a,w&&o.applyBookStyles(),h(),v.updateOptions(a)},this.applyBookStyles=function(){w&&j&&(ReadiumSDK.Helpers.setStyles(r.getStyles(),j),f())},this.scaleToWidth=function(a){if(!(x.width<=0)){var b=a/x.width;o.transformContentImmediate(b,0,0);
}},this.resizeIFrameToContent=function(){var a=g();o.setHeight(a),o.showIFrame()},this.setHeight=function(a){n.css("height",a+"px"),k.css("height",a+"px")};var z=!0;this.showIFrame=function(){if(l.css("visibility","visible"),z){l.css("transform","none");var a=!1,b=y;b&&"undefined"!=typeof b.enableGPUHardwareAccelerationCSS3D||(b=new ReadiumSDK.Models.ViewerSettings({})),b.enableGPUHardwareAccelerationCSS3D&&(a=!0,l.css("transform","translateZ(0)"))}else l.css({left:"0px",top:"0px"})},this.hideIFrame=function(){if(l.css("visibility","hidden"),z){var a=!1,b=y;b&&"undefined"!=typeof b.enableGPUHardwareAccelerationCSS3D||(b=new ReadiumSDK.Models.ViewerSettings({})),b.enableGPUHardwareAccelerationCSS3D&&(a=!0);var c=ReadiumSDK.Helpers.CSSTransformString({left:"10000",top:"10000",enable3D:a});l.css(c)}else l.css({left:"10000px",top:"10000px"})},this.updatePageSwitchDir=function(a,b){v.updatePageSwitchDir(a,b)},this.transformContentImmediate=function(a,b,c){var e=Math.ceil(x.width*a),f=Math.floor(x.height*a);if(v.transformContentImmediate_BEGIN(k,a,b,c),k.css("left",b+"px"),k.css("top",c+"px"),k.css("width",e+"px"),k.css("height",f+"px"),j){var g=!1,h=y;if(h&&"undefined"!=typeof h.enableGPUHardwareAccelerationCSS3D||(h=new ReadiumSDK.Models.ViewerSettings({})),h.enableGPUHardwareAccelerationCSS3D&&(g=!0),d.needsFixedLayoutScalerWorkAround()){var i=ReadiumSDK.Helpers.CSSTransformString({scale:a,enable3D:g});j.css(i);var l=ReadiumSDK.Helpers.CSSTransformString({scale:1,enable3D:g});l.width=x.width,l.height=x.height,n.css(l)}else{var m=ReadiumSDK.Helpers.CSSTransformString({scale:a,enable3D:g});m.width=x.width,m.height=x.height,n.css(m)}j.css("opacity","0.999"),o.showIFrame(),setTimeout(function(){j.css("opacity","1")},0),v.transformContentImmediate_END(k,a,b,c)}},this.getCalculatedPageHeight=function(){return k.height()},this.transformContent=_.bind(_.debounce(this.transformContentImmediate,50),o),this.loadSpineItem=function(a,b,c){if(m!=a){m=a;var d=p["package"].resolveRelativeUrl(a.href);o.hideIFrame(),o.trigger(ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START,l,m),q.loadIframe(l[0],d,function(d){if(d&&b){var f=function(){b(d,l,m,!0,c)};ReadiumSDK.Helpers.isIframeAlive(l[0])?(e(d),f()):(console.error("onIFrameLoad !! doc && win + TIMEOUT"),console.debug(a.href),e(d),setTimeout(f,500))}else e(d)},o,{spineItem:m})}else b&&b(!0,l,m,!1,c)},this.getFirstVisibleElementCfi=function(){var a=new ReadiumSDK.Views.CfiNavigationLogic(k,l);return a.getFirstVisibleElementCfi(0)},this.getNavigator=function(){return new ReadiumSDK.Views.CfiNavigationLogic(k,l)},this.getElementByCfi=function(a,b,c,d,e){if(a!=m)return void console.error("spine item is not loaded");var f=new ReadiumSDK.Views.CfiNavigationLogic(k,l);return f.getElementByCfi(b,c,d,e)},this.getElementById=function(a,b){if(a!=m)return void console.error("spine item is not loaded");var c=new ReadiumSDK.Views.CfiNavigationLogic(k,l);return c.getElementById(b)},this.getElement=function(a,b){if(a!=m)return void console.error("spine item is not loaded");var c=new ReadiumSDK.Views.CfiNavigationLogic(k,l);return c.getElement(b)},this.getFirstVisibleMediaOverlayElement=function(){var a=new ReadiumSDK.Views.CfiNavigationLogic(k,l);return a.getFirstVisibleMediaOverlayElement({top:0,bottom:l.height()})},this.offset=function(){return l?l.offset():void 0}},ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START="SpineItemOpenStart",define("onePageView",["readiumSDK","cfiNavigationLogic"],function(a){return function(){var b;return b||a.onePageView}}(this)),ReadiumSDK.Models.CurrentPagesInfo=function(a,b){this.isRightToLeft=a.isRightToLeft(),this.isFixedLayout=b,this.spineItemCount=a.items.length,this.openPages=[],this.addOpenPage=function(a,b,c,d){this.openPages.push({spineItemPageIndex:a,spineItemPageCount:b,idref:c,spineItemIndex:d}),this.sort()},this.canGoLeft=function(){return this.isRightToLeft?this.canGoNext():this.canGoPrev()},this.canGoRight=function(){return this.isRightToLeft?this.canGoPrev():this.canGoNext()},this.canGoNext=function(){if(0==this.openPages.length)return!1;var b=this.openPages[this.openPages.length-1];return b.spineItemIndex<a.last().index||b.spineItemPageIndex<b.spineItemPageCount-1},this.canGoPrev=function(){if(0==this.openPages.length)return!1;var b=this.openPages[0];return a.first().index<b.spineItemIndex||0<b.spineItemPageIndex},this.sort=function(){this.openPages.sort(function(a,b){return a.spineItemIndex!=b.spineItemIndex?a.spineItemIndex-b.spineItemIndex:a.pageIndex-b.pageIndex})}},define("currentPagesInfo",["readiumSDK"],function(a){return function(){var b;return b||a.currentPagesInfo}}(this)),ReadiumSDK.Models.Spread=function(a,b){function c(){g.leftItem=void 0,g.rightItem=void 0,g.centerItem=void 0}function d(a,b){b==ReadiumSDK.Models.Spread.POSITION_LEFT?g.leftItem=a:b==ReadiumSDK.Models.Spread.POSITION_RIGHT?g.rightItem=a:(b!=ReadiumSDK.Models.Spread.POSITION_CENTER&&console.error("Unrecognized position value"),g.centerItem=a)}function e(a){return h?a.isLeftPage()?ReadiumSDK.Models.Spread.POSITION_LEFT:a.isRightPage()?ReadiumSDK.Models.Spread.POSITION_RIGHT:ReadiumSDK.Models.Spread.POSITION_CENTER:ReadiumSDK.Models.Spread.POSITION_CENTER}function f(a){return a.isLeftPage()?g.spine.isRightToLeft()?g.spine.prevItem(a):g.spine.nextItem(a):a.isRightPage()?g.spine.isRightToLeft()?g.spine.nextItem(a):g.spine.prevItem(a):void 0}var g=this;this.spine=a,this.leftItem=void 0,this.rightItem=void 0,this.centerItem=void 0;var h=b;this.setSyntheticSpread=function(a){h=a},this.isSyntheticSpread=function(){return h},this.openFirst=function(){0==this.spine.items.length?c():this.openItem(this.spine.first())},this.openLast=function(){0==this.spine.items.length?c():this.openItem(this.spine.last())},this.openItem=function(a){c();var b=e(a);if(d(a,b),b!=ReadiumSDK.Models.Spread.POSITION_CENTER&&this.spine.isValidLinearItem(a.index)){var g=f(a);if(g){var h=e(g);h!=b&&h!=ReadiumSDK.Models.Spread.POSITION_CENTER&&!g.isReflowable()&&g.isRenditionSpreadAllowed()&&d(g,h)}}},this.openNext=function(){var a=this.validItems();if(0==a.length)this.openFirst();else{var b=this.spine.nextItem(a[a.length-1]);b&&this.openItem(b)}},this.openPrev=function(){var a=this.validItems();if(0==a.length)this.openLast();else{var b=this.spine.prevItem(a[0]);b&&this.openItem(b)}},this.validItems=function(){var a=[];return this.leftItem&&a.push(this.leftItem),this.rightItem&&a.push(this.rightItem),this.centerItem&&a.push(this.centerItem),a.sort(function(a,b){return a.index-b.index}),a}},ReadiumSDK.Models.Spread.POSITION_LEFT="left",ReadiumSDK.Models.Spread.POSITION_RIGHT="right",ReadiumSDK.Models.Spread.POSITION_CENTER="center",define("fixedPageSpread",["readiumSDK"],function(a){return function(){var b;return b||a.fixedPageSpread}}(this)),ReadiumSDK.Models.BookmarkData=function(a,b){this.idref=a,this.contentCFI=b,this.toString=function(){return JSON.stringify(this)}},define("bookmarkData",["readiumSDK"],function(a){return function(){var b;return b||a.bookmarkData}}(this)),ReadiumSDK.Views.FixedView=function(a,b){function c(c){var d=new ReadiumSDK.Views.OnePageView(a,[c],!1,b);return d.on(ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START,function(a,b){r.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,a,b)}),d}function d(){var a=D.validItems();return a[0]}function e(a,b){if(E)return void(F={initiator:a,paginationRequest:b});E=!0;var c={isElementAdded:!1},d=f([{pageView:x,spineItem:D.leftItem,context:c},{pageView:y,spineItem:D.rightItem,context:c},{pageView:z,spineItem:D.centerItem,context:c}]);$.when.apply($,d).done(function(){if(E=!1,F){var d=F.initiator,f=F.paginationRequest;F=void 0,e(d,f)}else c.isElementAdded&&r.applyStyles(),b?g(a,b.spineItem,b.elementId):g(a)})}function f(a){for(var b=[],c=0;c<a.length;c++){var d=n(a[c].pageView,a[c].spineItem,a[c].context);b.push(d)}return b}function g(a,b,c){l(),j(),r.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:r.getPaginationInfo(),initiator:a,spineItem:b,elementId:c})}function h(a,b){var c=new ReadiumSDK.Models.Spread(t,b);return c.openItem(a),D.leftItem!=c.leftItem||D.rightItem!=c.rightItem||D.centerItem!=c.centerItem}function i(){if(!C||!B)return!1;var a=s.width(),b=s.height();return a&&b}function j(a){if(G(0,!1),i()){var b=s.width(),c=s.height(),d=x.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(x.element()):ReadiumSDK.Helpers.Margins.empty(),e=y.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(y.element()):ReadiumSDK.Helpers.Margins.empty(),f=z.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(z.element()):ReadiumSDK.Helpers.Margins.empty(),g=k(d,e,f),h={width:b-B.width(),height:c-B.height()},j={width:h.width-g.width(),height:h.height-g.height()};if(!(h.width<=0||h.height<=0)){var l=j.width/C.width,m=j.height/C.height;s.css("overflow","auto");var n;"fit-width"==v.style?n=l:"fit-height"==v.style?n=m:"user"==v.style?n=v.scale:(n=Math.min(l,m),s.css("overflow","hidden")),q=n;var o={width:C.width*n,height:C.height*n},t={width:o.width+g.width(),height:o.height+g.height()},u={width:t.width+B.width(),height:t.height+B.height()},w=Math.floor((b-u.width)/2),A=Math.floor((c-u.height)/2);0>w&&(w=0),0>A&&(A=0),p.css("left",w+"px"),p.css("top",A+"px"),p.css("width",t.width+"px"),p.css("height",t.height+"px");var D=B.padding.left,E=B.padding.top,F=a?"transformContentImmediate":"transformContent";x.isDisplaying()&&x[F](n,D,E),y.isDisplaying()&&(D+=C.separatorPosition*n,x.isDisplaying()&&(D+=d.left),y[F](n,D,E)),z.isDisplaying()&&z[F](n,D,E),r.trigger(ReadiumSDK.Events.FXL_VIEW_RESIZED)}}}function k(a,b,c){var d={left:Math.max(a.margin.left,b.margin.left,c.margin.left),right:Math.max(a.margin.right,b.margin.right,c.margin.right),top:Math.max(a.margin.top,b.margin.top,c.margin.top),bottom:Math.max(a.margin.bottom,b.margin.bottom,c.margin.bottom)},e={left:Math.max(a.border.left,b.border.left,c.border.left),right:Math.max(a.border.right,b.border.right,c.border.right),top:Math.max(a.border.top,b.border.top,c.border.top),bottom:Math.max(a.border.bottom,b.border.bottom,c.border.bottom)},f={left:Math.max(a.padding.left,b.padding.left,c.padding.left),right:Math.max(a.padding.right,b.padding.right,c.padding.right),top:Math.max(a.padding.top,b.padding.top,c.padding.top),bottom:Math.max(a.padding.bottom,b.padding.bottom,c.padding.bottom)};return new ReadiumSDK.Helpers.Margins(d,e,f)}function l(){C={},z.isDisplaying()?(C.width=z.meta_width(),C.height=z.meta_height(),C.separatorPosition=0):x.isDisplaying()&&y.isDisplaying()?x.meta_height()==y.meta_height()?(C.width=x.meta_width()+y.meta_width(),C.height=x.meta_height(),C.separatorPosition=x.meta_width()):(C.width=x.meta_width()+y.meta_width()*(x.meta_height()/y.meta_height()),C.height=x.meta_height(),C.separatorPosition=x.meta_width()):x.isDisplaying()?(C.width=2*x.meta_width(),C.height=x.meta_height(),C.separatorPosition=x.meta_width()):y.isDisplaying()?(C.width=2*y.meta_width(),C.height=y.meta_height(),C.separatorPosition=y.meta_width()):C=void 0}function m(){B=ReadiumSDK.Helpers.Margins.fromElement(p)}function n(a,b,c){var d=$.Deferred();return b?(a.isDisplaying()||(p.append(a.render().element()),c.isElementAdded=!0),a.loadSpineItem(b,function(b,c,e,f,g){b&&f&&(a.meta_height()&&a.meta_width()||console.error("Invalid document "+e.href+": viewport is not specified!"),r.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,c,e)),d.resolve()},c)):(a.isDisplaying()&&a.remove(),d.resolve()),d.promise()}function o(){var a=[];a=t.isLeftToRight()?[x,z,y]:[y,z,x];for(var b=[],c=0,d=a.length;d>c;c++)a[c].isDisplaying()&&b.push(a[c]);return b}_.extend(this,Backbone.Events);var p,q,r=this,s=a.$viewport,t=a.spine,u=a.userStyles,v=(a.bookStyles,a.zoom||{style:"default"}),w=(a.iframeLoader,void 0),x=c("fixed-page-frame-left"),y=c("fixed-page-frame-right"),z=c("fixed-page-frame-center"),A=[];A.push(x),A.push(y),A.push(z);var B,C,D=new ReadiumSDK.Models.Spread(t,!1),E=!1,F=!1;this.isReflowable=function(){return!1},this.setZoom=function(a){v=a,j(!1)},this.render=function(){var a=ReadiumSDK.Helpers.loadTemplate("fixed_book_frame",{});return p=$(a),ReadiumSDK.Helpers.CSSTransition(p,"all 0 ease 0"),p.css("overflow","hidden"),s.append(p),r.applyStyles(),this},this.remove=function(){p.remove()},this.setViewSettings=function(a){w=a,D.setSyntheticSpread(1==ReadiumSDK.Helpers.deduceSyntheticSpread(s,d(),w));for(var b=o(),c=0,e=b.length;e>c;c++)b[c].setViewSettings(a)};var G=function(a,b){x&&x.updatePageSwitchDir(a,b),y&&y.updatePageSwitchDir(a,b),z&&z.updatePageSwitchDir(a,b)};this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(u.getStyles(),p.parent()),m(),l(),j()},this.applyBookStyles=function(){for(var a=o(),b=0,c=a.length;c>b;b++)a[b].applyBookStyles()},this.onViewportResize=function(){var a=d();if(a){var b=1==ReadiumSDK.Helpers.deduceSyntheticSpread(s,a,w);if(h(a,b)){D.setSyntheticSpread(b);var c=new ReadiumSDK.Models.PageOpenRequest(a,r);r.openPage(c)}else j(!0)}},this.getViewScale=function(){return q},this.openPage=function(a,b){if(a.spineItem){var c=D.leftItem,d=D.rightItem,f=D.centerItem,g=1==ReadiumSDK.Helpers.deduceSyntheticSpread(s,a.spineItem,w);D.setSyntheticSpread(g),D.openItem(a.spineItem);var h=c!==D.leftItem||d!==D.rightItem||f!==D.centerItem;(null===b||"undefined"==typeof b)&&(b=0),G(0===b?0:D.spine.isRightToLeft()?1===b?2:1:b,h),e(a.initiator,a)}},this.openPagePrev=function(a){D.openPrev(),G(D.spine.isRightToLeft()?2:1,!0),e(a,void 0)},this.openPageNext=function(a){D.openNext(),G(D.spine.isRightToLeft()?1:2,!0),e(a,void 0)},this.getPaginationInfo=function(){for(var a=new ReadiumSDK.Models.CurrentPagesInfo(t,!0),b=[D.leftItem,D.rightItem,D.centerItem],c=0;c<b.length;c++){var d=b[c];d&&a.addOpenPage(0,1,d.idref,d.index)}return a},this.bookmarkCurrentPage=function(){var a=o();if(a.length>0){var b=a[0].currentSpineItem().idref,c=a[0].getFirstVisibleElementCfi();return void 0==c&&(c=""),new ReadiumSDK.Models.BookmarkData(b,c)}return new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){return D.validItems()},this.getElement=function(a,b){for(var c=o(),d=0,e=c.length;e>d;d++){var f=c[d];if(f.currentSpineItem()==a)return f.getElement(a,b)}return void console.error("spine item is not loaded")},this.getElementById=function(a,b){for(var c=o(),d=0,e=c.length;e>d;d++){var f=c[d];if(f.currentSpineItem()==a)return f.getElementById(a,b)}return void console.error("spine item is not loaded")},this.getElementByCfi=function(a,b,c,d,e){for(var f=o(),g=0,h=f.length;h>g;g++){var i=f[g];if(i.currentSpineItem()==a)return i.getElementByCfi(a,b,c,d,e)}return void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){for(var a=o(),b=0,c=a.length;c>b;b++){var d=a[b].getFirstVisibleMediaOverlayElement();if(d)return d}return void 0},this.insureElementVisibility=function(a,b,c){}},define("fixedView",["readiumSDK","onePageView","currentPagesInfo","fixedPageSpread","bookmarkData"],function(a){return function(){var b;return b||a.fixedView}}(this)),ReadiumSDK.Views.ReflowableView=function(a,b){function c(a){u.css("left",a.left+"px"),u.css("top",a.top+"px"),u.css("right",a.right+"px"),u.css("bottom",a.bottom+"px")}function d(){u&&u.remove();var a=ReadiumSDK.Helpers.loadTemplate("reflowable_book_page_frame",{}),b=$(a);b=w.append(b),u=$("#reflowable-content-frame",b),x=$("#epubContentIframe",b),x.css("left",""),x.css("right",""),x.css("position","relative"),x.css("overflow","hidden"),v=new ReadiumSDK.Views.CfiNavigationLogic(u,x,{rectangleBased:!0,paginationInfo:N})}function e(a){if(s!=a){d(),N.pageOffset=0,N.currentSpreadIndex=0,s=a,J=!0;var b=F["package"].resolveRelativeUrl(a.href);D.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,x,a),x.css("opacity","0.01"),I.loadIframe(x[0],b,h,D,{spineItem:a})}}function f(){y&&ReadiumSDK.Helpers.UpdateHtmlFontSize(y,K)}function g(){y&&y.css("column-gap",N.columnGap+"px")}function h(a){if(J=!1,t&&t.spineItem!=s)return void e(t.spineItem);if(!a)return x.css("opacity","1"),void(t=void 0);D.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,x,s);var b=x[0].contentDocument;y=$("html",b),z=$("body",y),A=!1,B=!0,C=void 0;var c=x[0].contentDocument.defaultView||x[0].contentWindow,d=c.getComputedStyle(z[0],null);if(d){B="ltr"===d.direction;var h=void 0;h=d.getPropertyValue?d.getPropertyValue("-webkit-writing-mode")||d.getPropertyValue("-moz-writing-mode")||d.getPropertyValue("-ms-writing-mode")||d.getPropertyValue("-o-writing-mode")||d.getPropertyValue("-epub-writing-mode")||d.getPropertyValue("writing-mode"):d.webkitWritingMode||d.mozWritingMode||d.msWritingMode||d.oWritingMode||d.epubWritingMode||d.writingMode,h&&(C=h.indexOf("-lr")>=0,(h.indexOf("vertical")>=0||h.indexOf("tb-")>=0||h.indexOf("bt-")>=0)&&(A=!0))}B&&("rtl"===z[0].getAttribute("dir")||"rtl"===y[0].getAttribute("dir"))&&(B=!1),F.isLeftToRight()||!B||A||(z[0].setAttribute("dir","rtl"),B=!1,C=!1),N.isVerticalWritingMode=A,n(),x.css("opacity","1"),k(),y.css("height",M.height+"px"),y.css("position","relative"),y.css("margin","0"),y.css("padding","0"),y.css("column-axis",A?"vertical":"horizontal"),D.applyBookStyles(),q(),f(),g(),D.applyStyles()}function i(){if(t){var a=t;t=void 0,D.openPage(a)}}function j(){var a=-N.pageOffset+"px";if(A)y.css("top",a);else{var b=B||C;y.css("left",b?a:""),y.css("right",b?"":a)}o()}function k(){var a=u.width(),b=u.height();return M.width!==a||M.height!==b?(M.width=a,M.height=b,!0):!1}function l(a,b,c){N.pageOffset=(N.columnWidth+N.columnGap)*N.visibleColumnCount*N.currentSpreadIndex,j(),D.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:D.getPaginationInfo(),initiator:a,spineItem:b,elementId:c})}function m(){var a=550,b=400,c=ReadiumSDK.Helpers.deduceSyntheticSpread(E,s,O),d=c===!1||c===!0;if(0===c&&(c=1),N.visibleColumnCount=c?2:1,A&&(a*=2,c=!1,d=!0,N.visibleColumnCount=1),y){n();var e=parseInt(E.css("border-left-width")),f=parseInt(E.css("border-right-width")),g=N.columnGap/2;g=Math.max(0,g-e);var h=N.columnGap/2;h=Math.max(0,h-f);var j=0;if(O.fontSize){var m=.8*O.fontSize/100;a=Math.floor(a*m),b=Math.floor(b*m)}var o=E.width(),p=o-e-f-g-h;c&&(p=.5*(p-N.columnGap)),p>a?j=Math.floor((p-a)*(c?1:.5)):!d&&b>p&&c&&(c=!1,N.visibleColumnCount=1,p=o-e-f-g-h,p>a&&(j=Math.floor(.5*(p-a)))),w.css({left:j+g+"px",right:j+h+"px"}),k(),x.css("width",M.width+"px"),x.css("height",M.height+"px"),y.css("height",M.height+"px"),y.css("min-height",M.height+"px"),y.css("max-height",M.height+"px"),y.css("margin",0),y.css("padding",0),y.css("border",0),z.css("margin",0),z.css("padding",0),N.rightToLeft=F.isRightToLeft(),N.columnWidth=Math.round(((A?M.height:M.width)-N.columnGap*(N.visibleColumnCount-1))/N.visibleColumnCount);var q=N.visibleColumnCount>1;q?(y.css("width",M.width+"px"),y.css("column-count",N.visibleColumnCount)):(y.css("width",(A?M.width:N.columnWidth)+"px"),y.css("column-width",N.columnWidth+"px")),y.css("column-fill","auto"),y.css({left:"0",right:"0",top:"0"}),ReadiumSDK.Helpers.triggerLayout(x),N.columnCount=((A?y[0].scrollHeight:y[0].scrollWidth)+N.columnGap)/(N.columnWidth+N.columnGap),N.columnCount=Math.round(N.columnCount);var r=(N.columnCount-1)*N.columnGap,u=((A?y[0].scrollHeight:y[0].scrollWidth)-r)/N.columnCount;u=Math.round(u),u>N.columnWidth&&(console.debug("ADJUST COLUMN"),console.log(N.columnWidth),console.log(u),N.columnWidth=u),N.spreadCount=Math.ceil(N.columnCount/N.visibleColumnCount),N.currentSpreadIndex>=N.spreadCount&&(N.currentSpreadIndex=N.spreadCount-1),t?i():l(D)}}function n(){-1==L&&(L=y.css("opacity"),y.css("opacity","0"))}function o(){-1!=L&&y.css("opacity",L),L=-1}function p(){for(var a=[],b=N.currentSpreadIndex*N.visibleColumnCount,c=0;c<N.visibleColumnCount&&b+c<N.columnCount;c++)a.push(b+c);return a}function q(){if(y){var a;$("img, svg",y).each(function(){a=$(this),a.css("max-width","98%"),a.css("max-height","98%"),a.css("height")||a.css("height","auto"),a.css("width")||a.css("width","auto")})}}function r(){var a=Math.round(N.pageOffset/(N.columnWidth+N.columnGap)),b=a*u.height(),c=b+N.visibleColumnCount*u.height();return{top:b,bottom:c}}_.extend(this,Backbone.Events);var s,t,u,v,w,x,y,z,A,B,C,D=this,E=a.$viewport,F=a.spine,G=a.userStyles,H=a.bookStyles,I=a.iframeLoader,J=!1,K=100,L=-1,M={width:void 0,height:void 0},N={visibleColumnCount:2,columnGap:20,spreadCount:0,currentSpreadIndex:0,columnWidth:void 0,pageOffset:0,columnCount:0};this.render=function(){var a=ReadiumSDK.Helpers.loadTemplate("reflowable_book_frame",{});w=$(a),E.append(w);var c=b.viewerSettings();return c&&"undefined"!=typeof c.enableGPUHardwareAccelerationCSS3D||(c=new ReadiumSDK.Models.ViewerSettings({})),c.enableGPUHardwareAccelerationCSS3D&&w.css("transform","translateZ(0)"),d(),D},this.remove=function(){w.remove()},this.isReflowable=function(){return!0},this.onViewportResize=function(){k()&&m()};var O=void 0;this.setViewSettings=function(a){O=a,N.columnGap=a.columnGap,K=a.fontSize,f(),g(),k(),m()},this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(G.getStyles(),w.parent());var a=ReadiumSDK.Helpers.Margins.fromElement(w);c(a.padding),k(),m()},this.applyBookStyles=function(){y&&ReadiumSDK.Helpers.setStyles(H.getStyles(),y)},this.openPage=function(a){if(J)return void(t=a);if(a.spineItem&&a.spineItem!=s)return t=a,void e(a.spineItem);var b=void 0;if(void 0!==a.spineItemPageIndex)b=a.spineItemPageIndex;else if(a.elementId)b=v.getPageForElementId(a.elementId);else if(a.elementCfi)try{b=v.getPageForElementCfi(a.elementCfi,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(c){b=0,console.error(c)}else a.firstPage?b=0:a.lastPage?b=N.columnCount-1:(console.debug("No criteria in pageRequest"),b=0);b>=0&&b<N.columnCount?(N.currentSpreadIndex=Math.floor(b/N.visibleColumnCount),l(a.initiator,a.spineItem,a.elementId)):console.log("Illegal pageIndex value: ",b,"column count is ",N.columnCount)},this.openPagePrev=function(a){if(s)if(N.currentSpreadIndex>0)N.currentSpreadIndex--,l(a);else{var b=F.prevItem(s,!0);if(b){var c=new ReadiumSDK.Models.PageOpenRequest(b,a);c.setLastPage(),D.openPage(c)}}},this.openPageNext=function(a){if(s)if(N.currentSpreadIndex<N.spreadCount-1)N.currentSpreadIndex++,l(a);else{var b=F.nextItem(s,!0);if(b){var c=new ReadiumSDK.Models.PageOpenRequest(b,a);c.setFirstPage(),D.openPage(c)}}},this.getFirstVisibleElementCfi=function(){var a=r();return v.getFirstVisibleElementCfi(a)},this.getPaginationInfo=function(){var a=new ReadiumSDK.Models.CurrentPagesInfo(F,!1);if(!s)return a;for(var b=p(),c=0,d=b.length;d>c;c++)a.addOpenPage(b[c],N.columnCount,s.idref,s.index);return a},this.bookmarkCurrentPage=function(){return s?new ReadiumSDK.Models.BookmarkData(s.idref,D.getFirstVisibleElementCfi()):new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){return[s]},this.getElementByCfi=function(a,b,c,d,e){return a!=s?void console.error("spine item is not loaded"):v.getElementByCfi(b,c,d,e)},this.getElementById=function(a,b){return a!=s?void console.error("spine item is not loaded"):v.getElementById(b)},this.getElement=function(a,b){return a!=s?void console.error("spine item is not loaded"):v.getElement(b)},this.getFirstVisibleMediaOverlayElement=function(){var a=r();return v.getFirstVisibleMediaOverlayElement(a)},this.insureElementVisibility=function(a,b,c){var d=$(b);if(!v.isElementVisible(d,r())){var e=v.getPageForElement(d);if(-1!=e){var f=new ReadiumSDK.Models.PageOpenRequest(s,c);f.setPageIndex(e);var g=b.id;g||(g=b.getAttribute("id")),g&&f.setElementId(g),D.openPage(f)}}}},define("reflowableView",["readiumSDK","cfiNavigationLogic","bookmarkData"],function(a){return function(){var b;return b||a.reflowableView}}(this)),ReadiumSDK.Models.SmilIterator=function(a){function b(a,c,d){for(var e=a,f=c.children.length;e>=0&&f>e;e+=d?-1:1){var g=c.children[e];if("par"==g.nodeType)return g;if(g=b(d?g.children.length-1:0,g,d))return g}return c.parent?b(c.index+(d?-1:1),c.parent,d):void 0}this.smil=a,this.currentPar=void 0,this.reset=function(){this.currentPar=b(0,this.smil,!1)},this.findTextId=function(a){if(!this.currentPar)return void console.debug("Par iterator is out of range");if(!a)return!1;for(;this.currentPar;){if(this.currentPar.element){if(a===this.currentPar.text.srcFragmentId)return!0;for(var b=this.currentPar.element.parentNode;b;){if(b.id&&b.id==a)return!0;b=b.parentNode}var c=$("#"+ReadiumSDK.Helpers.escapeJQuerySelector(a),this.currentPar.element);if(c&&c.length&&c[0])return!0}this.next()}return!1},this.next=function(){return this.currentPar?void(this.currentPar=b(this.currentPar.index+1,this.currentPar.parent,!1)):void console.debug("Par iterator is out of range")},this.previous=function(){return this.currentPar?void(this.currentPar=b(this.currentPar.index-1,this.currentPar.parent,!0)):void console.debug("Par iterator is out of range")},this.isLast=function(){return this.currentPar?b(this.currentPar.index+1,this.currentPar.parent,!1)?!1:!0:void console.debug("Par iterator is out of range")},this.goToPar=function(a){for(;this.currentPar&&this.currentPar!=a;)this.next()},this.reset()},define("smilIterator",["readiumSDK"],function(a){return function(){var b;return b||a.smilIterator}}(this)),ReadiumSDK.Views.MediaOverlayDataInjector=function(a,b){this.attachMediaOverlayData=function(c,d,e){var f=c[0].contentDocument.documentElement;if(d.media_overlay_id||0!==a.smil_models.length){var g=$("body",f);if(0==g.length)console.error("! BODY ???");else{var h=g.data("mediaOverlayClick");if(h)console.error("[WARN] already mediaOverlayClick");else{g.data("mediaOverlayClick",{ping:"pong"});var i=function(a){var c=$(this)[0];if(c=a.target,!c)return b.touchInit(),!0;var d=void 0,f=c,g=!1;for("a"===f.nodeName.toLowerCase()&&(g=!0);!(d=$(f).data("mediaOverlayData"))&&("a"===f.nodeName.toLowerCase()&&(g=!0),f=f.parentNode););if(d&&(d.par||d.pars)){if(!e.mediaOverlaysEnableClick)return console.log("MO CLICK DISABLED"),b.touchInit(),!0;if(g)return console.log("MO CLICKED LINK"),b.touchInit(),!0;var h=d.par?d.par:d.pars[0];if(d.pars&&"undefined"!=typeof rangy){var i=!1;b.isPlayingCfi()&&(i=!0,b.pause());try{var j=rangy.positionFromPoint(a.pageX,a.pageY,c.ownerDocument);h=void 0;for(var k=0;k<d.pars.length;k++){var l=d.pars[k],m="epubcfi("+l.cfi.partialStartCfi+")",n=EPUBcfi.getTextTerminusInfoWithPartialCFI(m,c.ownerDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),o="epubcfi("+l.cfi.partialEndCfi+")",p=EPUBcfi.getTextTerminusInfoWithPartialCFI(o,c.ownerDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),q=rangy.createRange(c.ownerDocument);if(q.setStartAndEnd(n.textNode[0],n.textOffset,p.textNode[0],p.textOffset),q.isPointInRange(j.node,j.offset)){h=l;break}}}catch(r){console.error(r)}if(!h)return i&&b.toggleMediaOverlay(),!0}return f&&f!=c&&"body"===f.nodeName.toLowerCase()&&h&&!h.getSmil().id?(b.touchInit(),!0):(b.playUserPar(h),!0)}var s=$(c).attr("ibooks:readaloud");if(s||(s=$(c).attr("epub:readaloud")),s){console.debug("MO readaloud attr: "+s);var t=b.isPlaying();if("start"===s&&!t||"stop"===s&&t||"startstop"===s)return b.toggleMediaOverlay(),!0}return b.touchInit(),!0},j=_.debounce(i,200);"ontouchstart"in document.documentElement&&g[0].addEventListener("touchstart",j,!1),g[0].addEventListener("mousedown",j,!1)}}var k=a.getSmilBySpineItem(d);if(!k)return void console.error("NO SMIL?? "+d.idref+" /// "+d.media_overlay_id);var l=function(a){if(a){if(a.nodeType&&"seq"===a.nodeType&&a.textref){var b=a.textref.split("#"),e=b[0],f=2===b.length?b[1]:"";if(e&&f){var g=ReadiumSDK.Helpers.ResolveContentRef(e,k.href),h=g===d.href;h&&(a.element=c[0].contentDocument.getElementById(f),a.element||console.error("seq.textref !element? "+a.textref))}}if(a.children&&a.children.length)for(var i=0;i<a.children.length;i++){var j=a.children[i];l(j)}}};l(k);for(var m=new ReadiumSDK.Models.SmilIterator(k),n="/99!",o="epubcfi";m.currentPar;){m.currentPar.element=void 0,m.currentPar.cfi=void 0;var p=ReadiumSDK.Helpers.ResolveContentRef(m.currentPar.text.srcFile,m.smil.href),q=p===d.href;if(q){var r=!m.currentPar.text.srcFragmentId||0==m.currentPar.text.srcFragmentId.length,s=0==m.currentPar.text.srcFragmentId.indexOf(o)?void 0:m.currentPar.text.srcFragmentId,t=void 0,u=!1;if(r||s)t=r?g:$(c[0].contentDocument.getElementById(s));else if(0===m.currentPar.text.srcFragmentId.indexOf(o)){var v=m.currentPar.text.srcFragmentId.substr(o.length+1,m.currentPar.text.srcFragmentId.length-o.length-2);0===v.indexOf(n)&&(v=v.substr(n.length,v.length-n.length));var w=v.split(",");if(w&&3===w.length)try{var x=w[0]+w[1],y="epubcfi("+x+")",z=EPUBcfi.getTextTerminusInfoWithPartialCFI(y,c[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),A=w[0]+w[2],B="epubcfi("+A+")",C=(EPUBcfi.getTextTerminusInfoWithPartialCFI(B,c[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),z.textNode[0].parentNode);m.currentPar.cfi={smilTextSrcCfi:m.currentPar.text.srcFragmentId,partialRangeCfi:v,partialStartCfi:x,partialEndCfi:A,cfiTextParent:C},u=!0,t=$(C);var D=t.data("mediaOverlayData");if(D){D.par&&(console.error("[WARN] non-CFI MO DATA already exists!"),D.par=void 0);var E=!1;if(D.pars)for(var F=0;F<D.pars.length;F++){var G=D.pars[F];G===m.currentPar&&(E=!0,console.error("[WARN] mediaOverlayData CFI PAR already registered!"))}else D.pars=[];E||D.pars.push(m.currentPar)}else D={pars:[m.currentPar]},t.data("mediaOverlayData",D)}catch(H){console.error(H)}else try{var I="epubcfi("+v+")";t=EPUBcfi.getTargetElementWithPartialCFI(I,c[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(H){console.error(H)}}else console.error("SMIL text@src CFI fragment identifier scheme not supported: "+m.currentPar.text.srcFragmentId);if(t&&t.length>0){if(!u){m.currentPar.element&&m.currentPar.element!==t[0]&&console.error("DIFFERENT ELEMENTS??! "+m.currentPar.text.srcFragmentId+" /// "+m.currentPar.element.id);var J=t[0].nodeName?t[0].nodeName.toLowerCase():void 0;("audio"===J||"video"===J)&&t.attr("preload","auto"),m.currentPar.element=t[0];var D=t.data("mediaOverlayData");D&&(console.error("[WARN] MO DATA already exists."),D.par&&D.par!==m.currentPar&&console.error("DIFFERENT PARS??!")),t.data("mediaOverlayData",{par:m.currentPar})}}else console.error("!! CANNOT FIND ELEMENT: "+m.currentPar.text.srcFragmentId+" == "+m.currentPar.text.srcFile+" /// "+d.href)}m.next()}}}},define("mediaOvelayDataInjector",["readiumSDK","mediaOverlay","mediaOverlayPlayer","smilModel","spineItem","smilIterator","rangy"],function(a){return function(){var b;return b||a.mediaOvelayDataInjector}}(this)),ReadiumSDK.Views.InternalLinksSupport=function(a){function b(a){var b=a.indexOf("("),c=a.indexOf("!"),d=a.indexOf(")");return-1==c?void 0:(-1==d&&(d=a.length),{spineItemCfi:a.substring(b+1,c),elementCfi:a.substring(c+1,d)})}function c(b,c){var d=a["package"]().resolveRelativeUrl(c.href),e=b.absoluteTo(d);return e}function d(d,f){var g=c(d,f);if(!g)return void console.error("Unable to resolve "+d.href());var i=d.fragment(),j=g.toString();j=ReadiumSDK.Helpers.RemoveFromString(j,"#"+i),e(j,function(c){if(c){var d=new window.DOMParser,e=d.parseFromString(c,"text/xml"),f=b(i);if(!f)return void console.warn("Unable to split cfi:"+i);var g=EPUBcfi.Interpreter.getContentDocHref("epubcfi("+f.spineItemCfi+")",e);if(g){var j=a.spine().getItemByHref(g);j?a.openSpineItemElementCfi(j.idref,f.elementCfi,h):console.warn("Unable to find spineItem with href="+g)}else console.warn("Unable to find document ref from "+i+" cfi")}})}function e(a,b){$.ajax({isLocal:0===a.indexOf("http")?!1:!0,url:a,dataType:"text",async:!0,success:function(a){b(a)},error:function(c,d,e){console.error("Error when AJAX fetching "+a),console.error(d),console.error(e),b()}})}function f(a){var b=a.filename();return b&&ReadiumSDK.Helpers.EndsWith(b,".opf")}function g(b,c){var d,e=b.filename();if(e){var f=new URI(b,c.href),g=decodeURIComponent(f.pathname()),i=a.spine().getItemByHref(g);if(!i)return void console.error("spine item with href="+g+" not found");d=i.idref}else d=c.idref;var j=b.fragment();
a.openSpineItemElementId(d,j,h)}var h=this;this.processLinkElements=function(a,b){var c=a[0].contentDocument;$("a",c).click(function(a){var c;c=a.currentTarget.attributes["xlink:href"]?a.currentTarget.attributes["xlink:href"].value:a.currentTarget.attributes.href.value;var e=!1,h=new URI(c),i=h.is("relative");i?f(h)?(d(h,b),e=!0):(g(h,b),e=!0):(window.open(c,"_blank"),e=!0),e&&(a.preventDefault(),a.stopPropagation())})}},define("internalLinksSupport",["readiumSDK","URIjs"],function(a){return function(){var b;return b||a.internalLinksSupport}}(this)),ReadiumSDK.Views.IFrameLoader=function(){var a=this,b={};this.addIFrameEventListener=function(a,c,d){void 0==b[a]&&(b[a]=[]),b[a].push({callback:c,context:d})},this.updateIframeEvents=function(a){_.each(b,function(b,c){for(var d=0,e=b.length;e>d;d++)$(a.contentWindow).off(c),$(a.contentWindow).on(c,b[d].callback,b[d].context)})},this.loadIframe=function(b,c,d,e,f){b.setAttribute("data-baseUri",b.baseURI),b.setAttribute("data-src",c);var g=new URI(c).absoluteTo(b.baseURI).toString();a._loadIframeWithUri(b,f,g,function(){var a=b.contentDocument||b.contentWindow.document;$("svg",a).load(function(){console.log("loaded")}),d.call(e,!0,f)})},this._loadIframeWithUri=function(b,c,d,e){b.onload=function(){a.updateIframeEvents(b);var c=b.contentWindow.MathJax;if(c){var d=_.once(e);try{c.Hub.Queue(d)}catch(f){console.error("MathJax fail!"),e()}}else e()},b.setAttribute("src",d)}},define("iframeLoader",["readiumSDK"],function(a){return function(){var b;return b||a.iframeLoader}}(this));var EpubAnnotationsModule=function(a,b,c){var d={};d.TextLineInferrer=Backbone.Model.extend({initialize:function(a,b){},inferLines:function(a){for(var b,c,d,e=[],f=a.length,g=0,h=0;f-1>=h;h++){c=a[h],d=!1;for(var i=0;g-1>=i;i++)if(b=e[i],this.includeRectInLine(b,c.top,c.left,c.width,c.height)){this.expandLine(b,c.left,c.top,c.width,c.height),d=!0;break}d||(e.push(this.createNewLine(c.left,c.top,c.width,c.height)),g+=1)}return e},includeRectInLine:function(a,b,c,d,e){return this.rectIsWithinLineVertically(b,e,a.maxTop,a.maxBottom)&&this.rectIsWithinLineHorizontally(c,d,a.left,a.width,a.avgHeight)?!0:!1},rectIsWithinLineVertically:function(a,b,c,d){var e=a+b,f=d-c,g=.75*f/2,h=.75*b/2;return a+=h,e-=h,c+=g,d-=g,a===c&&e===d?!0:c>a&&d>e&&e>c?!0:a>c&&e>d&&d>a?!0:a>c&&d>e?!0:c>a&&e>d?!0:!1},rectIsWithinLineHorizontally:function(a,b,c,d,e){var f=2*e,g=a+b,h=a+d;return c-g>f?!1:a-h>f?!1:!0},createNewLine:function(a,b,c,d){var e=b+d;return{left:a,startTop:b,width:c,avgHeight:d,maxTop:b,maxBottom:e,numRects:1}},expandLine:function(a,b,c,d,e){var f=(a.left+a.width,b+d),g=c+e,h=a.numRects+1,i=a.avgHeight*a.numRects,j=(i+e)/h;return a.avgHeight=j,a.numRects=h,a=this.expandLineVertically(a,c,g),a=this.expandLineHorizontally(a,b,f)},expandLineVertically:function(a,b,c){return b<a.maxTop&&(a.maxTop=b),c>a.maxBottom&&(a.maxBottom=c),a},expandLineHorizontally:function(a,b,c){var d=a.left<=b?a.left:b,e=a.left+a.width,f=e>=c?e:c,g=f-d;return a.left=d,a.width=g,a}}),d.Highlight=Backbone.Model.extend({defaults:{isVisible:!1},initialize:function(a,b){}}),d.HighlightGroup=Backbone.Model.extend({defaults:function(){return{selectedNodes:[],highlightViews:[]}},initialize:function(a,b){this.set("scale",a.scale),this.constructHighlightViews()},highlightGroupCallback:function(a){var b=this;return"click"===a.type?void b.get("bbPageSetView").trigger("annotationClicked","highlight",b.get("CFI"),b.get("id"),a):"contextmenu"===a.type?void b.get("bbPageSetView").trigger("annotationRightClicked","highlight",b.get("CFI"),b.get("id"),a):void _.each(this.get("highlightViews"),function(b){"mouseenter"===a.type?b.setHoverHighlight():"mouseleave"===a.type&&b.setBaseHighlight()})},constructHighlightViews:function(){var a,b,c=this,e=[];_.each(this.get("selectedNodes"),function(a,b){var c,d=document.createRange();d.selectNodeContents(a),c=d.getClientRects(),_.each(c,function(a){e.push(a)})}),a=new d.TextLineInferrer,b=a.inferLines(e);var f=this.get("scale");_.each(b,function(a,b){var e=a.startTop/f,g=a.left/f,h=a.avgHeight/f,i=a.width/f,j=new d.HighlightView({CFI:c.get("CFI"),top:e+c.get("offsetTopAddition"),left:g+c.get("offsetLeftAddition"),height:h,width:i,styles:c.get("styles"),highlightGroupCallback:c.highlightGroupCallback,callbackContext:c});c.get("highlightViews").push(j)})},resetHighlights:function(a,b,c){b&&this.set({offsetTopAddition:b}),c&&this.set({offsetLeftAddition:c}),this.destroyCurrentHighlights(),this.constructHighlightViews(),this.renderHighlights(a)},destroyCurrentHighlights:function(){_.each(this.get("highlightViews"),function(a){a.remove(),a.off()}),this.get("highlightViews").length=0},renderHighlights:function(a){_.each(this.get("highlightViews"),function(b,c){$(a).append(b.render())})},toInfo:function(){return{id:this.get("id"),type:"highlight",CFI:this.get("CFI")}},setStyles:function(a){var b=this.get("highlightViews");this.set({styles:a}),_.each(b,function(b,c){b.setStyles(a)})}}),d.Underline=Backbone.Model.extend({defaults:{isVisible:!1},initialize:function(a,b){}}),d.UnderlineGroup=Backbone.Model.extend({defaults:function(){return{selectedNodes:[],underlineViews:[]}},initialize:function(a,b){this.constructUnderlineViews()},underlineGroupCallback:function(a){var b=this;return"click"===a.type?void b.get("bbPageSetView").trigger("annotationClicked","underline",b.get("CFI"),b.get("id"),a):void _.each(this.get("underlineViews"),function(b){"mouseenter"===a.type?b.setHoverUnderline():"mouseleave"===a.type&&b.setBaseUnderline()})},constructUnderlineViews:function(){var a,b,c=this,e=[];_.each(this.get("selectedNodes"),function(a,b){var c,d=document.createRange();d.selectNodeContents(a),c=d.getClientRects(),_.each(c,function(a){e.push(a)})}),a=new d.TextLineInferrer,b=a.inferLines(e),_.each(b,function(a,b){var e=a.startTop,f=a.left,g=a.avgHeight,h=a.width,i=new d.UnderlineView({CFI:c.get("CFI"),top:e+c.get("offsetTopAddition"),left:f+c.get("offsetLeftAddition"),height:g,width:h,styles:c.get("styles"),underlineGroupCallback:c.underlineGroupCallback,callbackContext:c});c.get("underlineViews").push(i)})},resetUnderlines:function(a,b,c){b&&this.set({offsetTopAddition:b}),c&&this.set({offsetLeftAddition:c}),this.destroyCurrentUnderlines(),this.constructUnderlineViews(),this.renderUnderlines(a)},destroyCurrentUnderlines:function(){_.each(this.get("underlineViews"),function(a){a.remove(),a.off()}),this.get("underlineViews").length=0},renderUnderlines:function(a){_.each(this.get("underlineViews"),function(b,c){$(a).append(b.render())})},toInfo:function(){return{id:this.get("id"),type:"underline",CFI:this.get("CFI")}},setStyles:function(a){var b=this.get("underlineViews");this.set({styles:a}),_.each(b,function(b,c){b.setStyles(a)})}}),d.Bookmark=Backbone.Model.extend({defaults:{isVisible:!1,bookmarkCenteringAdjustment:15,bookmarkTopAdjustment:45},initialize:function(a,b){},getAbsoluteTop:function(){var a=$(this.get("targetElement")).offset().top,b=this.get("offsetTopAddition")+a-this.get("bookmarkTopAdjustment");return b},getAbsoluteLeft:function(){var a=$(this.get("targetElement")).offset().left,b=this.get("offsetLeftAddition")+a-this.get("bookmarkCenteringAdjustment");return b},toInfo:function(){return{id:this.get("id"),type:"bookmark",CFI:this.get("CFI")}}}),d.ReflowableAnnotations=Backbone.Model.extend({initialize:function(a,b){this.epubCFI=EPUBcfi,this.annotations=new d.Annotations({offsetTopAddition:0,offsetLeftAddition:0,readerBoundElement:$("html",this.get("contentDocumentDOM"))[0],scale:0,bbPageSetView:this.get("bbPageSetView")});var c=this.get("annotationCSSUrl");c&&this.injectAnnotationCSS(c);var e=$(this.get("contentDocumentDOM")),f=this;e.on("mouseup",function(a){var b=f.getCurrentSelectionRange();void 0!==b&&b.startOffset-b.endOffset&&f.annotations.get("bbPageSetView").trigger("textSelectionEvent",a)})},redraw:function(){var a=-this.getPaginationLeftOffset();this.annotations.redrawAnnotations(0,a)},removeHighlight:function(a){return this.annotations.removeHighlight(a)},addHighlight:function(a,b,c,d){var e,f,g,h,i,j=this.getRangeStartMarker(a,b),k=this.getRangeEndMarker(a,b),l=$(this.get("contentDocumentDOM")),m=$("html",l).css("-webkit-transform"),n=new WebKitCSSMatrix(m).a;this.set("scale",n);try{return e=this.epubCFI.injectRangeElements(a,this.get("contentDocumentDOM"),j,k,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),g=e.startElement.nextSibling?e.startElement.nextSibling:e.startElement,h=e.endElement.previousSibling?e.endElement.previousSibling:e.endElement,f=document.createRange(),f.setStart(g,0),f.setEnd(h,h.length),selectionInfo=this.getSelectionInfo(f),i=-this.getPaginationLeftOffset(),"highlight"===c?(this.annotations.set("scale",this.get("scale")),this.annotations.addHighlight(a,selectionInfo.selectedElements,b,0,i,e.startElement,e.endElement,d)):"underline"===c&&this.annotations.addUnderline(a,selectionInfo.selectedElements,b,0,i,d),{CFI:a,selectedElements:selectionInfo.selectedElements}}catch(o){console.log(o.message)}},addBookmark:function(a,b,c){var d,e,f=this.getBookmarkMarker(a,b);try{return d=this.epubCFI.injectElement(a,this.get("contentDocumentDOM"),f,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),e=-this.getPaginationLeftOffset(),this.annotations.addBookmark(a,d[0],b,0,e,c),{CFI:a,selectedElements:d[0]}}catch(g){console.log(g.message)}},addImageAnnotation:function(a,b){var c;this.getBookmarkMarker(a,b);try{return c=this.epubCFI.getTargetElement(a,this.get("contentDocumentDOM"),["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),this.annotations.addImageAnnotation(a,c[0],b),{CFI:a,selectedElements:c[0]}}catch(d){console.log(d.message)}},getCurrentSelectionCFI:function(){var a,b=this.getCurrentSelectionRange();return b&&(selectionInfo=this.getSelectionInfo(b),a=selectionInfo.CFI),a},getCurrentSelectionOffsetCFI:function(){var a,b=this.getCurrentSelectionRange();return b&&(a=this.generateCharOffsetCFI(b)),a},addSelectionHighlight:function(a,b,c){var d,e,f,g,h="/99!",i=this.getCurrentSelectionRange();if(i)return f=this.getSelectionInfo(i),d=f.CFI,e="epubcfi("+h+d+")","highlight"===b?g=this.addHighlight(e,a,b,c):"underline"===b&&(g=this.addHighlight(e,a,b,c)),g.CFI=d,g;throw new Error("Nothing selected")},addSelectionBookmark:function(a,b){var c,d,e,f="/99!",g=this.getCurrentSelectionRange();if(g)return c=this.generateCharOffsetCFI(g),d="epubcfi("+f+c+")",e=this.addBookmark(d,a,b),e.CFI=c,e;throw new Error("Nothing selected")},addSelectionImageAnnotation:function(a){var b,c,d,e,f,g="/99!",h=this.getCurrentSelectionRange();if(h)return d=this.getSelectionInfo(h,["img"]),f=d.selectedElements[0],b=this.epubCFI.generateElementCFIComponent(f,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),c="epubcfi("+g+b+")",e=this.addImageAnnotation(c,a),e.CFI=b,e;throw new Error("Nothing selected")},updateAnnotationView:function(a,b){var c=this.annotations.updateAnnotationView(a,b);return c},getSelectionInfo:function(a,b){var c=this.generateRangeCFI(a),d={startElementFound:!1,endElementFound:!1},e=[];if(!b)var b=["text"];return this.findSelectedElements(a.commonAncestorContainer,a.startContainer,a.endContainer,d,e,b),{CFI:c,selectedElements:e}},generateRangeCFI:function(a){var b,c,d,e=a.startContainer,f=a.endContainer;if(e.nodeType===Node.TEXT_NODE&&f.nodeType===Node.TEXT_NODE)return b=a.startOffset,c=a.endOffset,d=this.epubCFI.generateCharOffsetRangeComponent(e,b,f,c,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);throw new Error("Selection start and end must be text nodes")},generateCharOffsetCFI:function(a){var b,c=a.startContainer,d=a.startOffset;return c.nodeType===Node.TEXT_NODE&&(b=this.epubCFI.generateCharacterOffsetCFIComponent(c,d,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])),b},findSelectedElements:function(a,b,c,d,e,f){return a===b&&(d.startElementFound=!0),d.startElementFound===!0&&this.addElement(a,e,f),a===c?void(d.endElementFound=!0):void(a.firstChild&&(this.findSelectedElements(a.firstChild,b,c,d,e,f),d.endElementFound)||a.nextSibling&&(this.findSelectedElements(a.nextSibling,b,c,d,e,f),d.endElementFound))},addElement:function(a,b,c){_.each(c,function(c){"text"===c?a.nodeType===Node.TEXT_NODE&&b.push(a):$(a).is(c)&&b.push(a)})},getCurrentSelectionRange:function(){var a,b=this.get("contentDocumentDOM");return b.getSelection?(a=b.getSelection(),a&&a.rangeCount&&a.anchorOffset!==a.focusOffset?a.getRangeAt(0):void 0):b.selection?b.selection.createRange():void 0},getPaginationLeftOffset:function(){var a=$("html",this.get("contentDocumentDOM")),b=a.css("left"),c=parseInt(b.replace("px",""));return c},getBookmarkMarker:function(a,b){return"<span class='bookmark-marker cfi-marker' id='"+b+"' data-cfi='"+a+"'></span>"},getRangeStartMarker:function(a,b){return"<span class='range-start-marker cfi-marker' id='start-"+b+"' data-cfi='"+a+"'></span>"},getRangeEndMarker:function(a,b){return"<span class='range-end-marker cfi-marker' id='end-"+b+"' data-cfi='"+a+"'></span>"},injectAnnotationCSS:function(a){var b=$("head",this.get("contentDocumentDOM"));b.append($("<link/>",{rel:"stylesheet",href:a,type:"text/css"}))}}),d.Annotations=Backbone.Model.extend({defaults:function(){return{bookmarkViews:[],highlights:[],markers:{},underlines:[],imageAnnotations:[],annotationHash:{},offsetTopAddition:0,offsetLeftAddition:0,readerBoundElement:void 0}},initialize:function(a,b){},remove:function(){_.each(this.get("highlights"),function(a){a.remove()})},redrawAnnotations:function(a,b){var c=this;_.each(this.get("highlights"),function(d){d.resetHighlights(c.get("readerBoundElement"),a,b)}),_.each(this.get("bookmarkViews"),function(c){c.resetBookmark(a,b)}),_.each(this.get("underlines"),function(d){d.resetUnderlines(c.get("readerBoundElement"),a,b)})},getBookmark:function(a){var b=this.get("annotationHash")[a];return b?b.bookmark.toInfo():void 0},getHighlight:function(a){var b=this.get("annotationHash")[a];return b?b.toInfo():void 0},getUnderline:function(a){var b=this.get("annotationHash")[a];return b?b.toInfo():void 0},getBookmarks:function(){var a=[];return _.each(this.get("bookmarkViews"),function(b){a.push(b.bookmark.toInfo())}),a},getHighlights:function(){var a=[];return _.each(this.get("highlights"),function(b){a.push(b.toInfo())}),a},getUnderlines:function(){var a=[];return _.each(this.get("underlines"),function(b){a.push(b.toInfo())}),a},getImageAnnotations:function(){var a=[];return _.each(this.get("imageAnnotations"),function(b){a.push(b.toInfo())}),a},addBookmark:function(a,b,c,e,f,g){e||(e=this.get("offsetTopAddition")),f||(f=this.get("offsetLeftAddition")),c=c.toString(),this.validateAnnotationId(c);var h=new d.BookmarkView({CFI:a,targetElement:b,offsetTopAddition:e,offsetLeftAddition:f,id:c.toString(),bbPageSetView:this.get("bbPageSetView"),type:g});this.get("annotationHash")[c]=h,this.get("bookmarkViews").push(h),$(this.get("readerBoundElement")).append(h.render())},removeHighlight:function(a){var b=this.get("annotationHash"),c=this.get("highlights"),d=this.get("markers");if(d[a]){var e=d[a].startMarker,f=d[a].endMarker;e.parentNode.removeChild(e),f.parentNode.removeChild(f),delete d[a],delete b[a],c=_.reject(c,function(b){return b.id==a?(b.destroyCurrentHighlights(),!0):!1}),this.set("highlights",c)}},addHighlight:function(a,b,c,e,f,g,h,i){e||(e=this.get("offsetTopAddition")),f||(f=this.get("offsetLeftAddition")),c=c.toString(),this.validateAnnotationId(c);var j=new d.HighlightGroup({CFI:a,selectedNodes:b,offsetTopAddition:e,offsetLeftAddition:f,styles:i,id:c,bbPageSetView:this.get("bbPageSetView"),scale:this.get("scale")});this.get("annotationHash")[c]=j,this.get("highlights").push(j),this.get("markers")[c]={startMarker:g,endMarker:h},j.renderHighlights(this.get("readerBoundElement"))},addUnderline:function(a,b,c,e,f,g){e||(e=this.get("offsetTopAddition")),f||(f=this.get("offsetLeftAddition")),c=c.toString(),this.validateAnnotationId(c);var h=new d.UnderlineGroup({CFI:a,selectedNodes:b,offsetTopAddition:e,offsetLeftAddition:f,styles:g,id:c,bbPageSetView:this.get("bbPageSetView")});this.get("annotationHash")[c]=h,this.get("underlines").push(h),h.renderUnderlines(this.get("readerBoundElement"))},addImageAnnotation:function(a,b,c){c=c.toString(),this.validateAnnotationId(c);var e=new d.ImageAnnotation({CFI:a,imageNode:b,id:c,bbPageSetView:this.get("bbPageSetView")});this.get("annotationHash")[c]=e,this.get("imageAnnotations").push(e),e.render()},updateAnnotationView:function(a,b){var c=this.get("annotationHash")[a];return c.setStyles(b),c},validateAnnotationId:function(a){if(this.get("annotationHash")[a])throw new Error("That annotation id already exists; annotation not added")}}),d.BookmarkView=Backbone.View.extend({el:"<div></div>",events:{mouseenter:"setHoverBookmark",mouseleave:"setBaseBookmark",click:"clickHandler"},initialize:function(a){this.bookmark=new d.Bookmark({CFI:a.CFI,targetElement:a.targetElement,offsetTopAddition:a.offsetTopAddition,offsetLeftAddition:a.offsetLeftAddition,id:a.id,bbPageSetView:a.bbPageSetView,type:a.type})},resetBookmark:function(a,b){a&&this.bookmark.set({offsetTopAddition:a}),b&&this.bookmark.set({offsetLeftAddition:b}),this.setCSS()},render:function(){return this.setCSS(),this.el},setCSS:function(){var a,b;"comment"===this.bookmark.get("type")?(a=this.bookmark.getAbsoluteTop(),b=this.bookmark.getAbsoluteLeft(),this.$el.css({top:a+"px",left:b+"px",width:"50px",height:"50px",position:"absolute"}),this.$el.addClass("comment")):this.$el.addClass("bookmark")},setHoverBookmark:function(a){a.stopPropagation(),this.$el.hasClass("comment")&&(this.$el.removeClass("comment"),this.$el.addClass("hover-comment"))},setBaseBookmark:function(a){a.stopPropagation(),this.$el.hasClass("hover-comment")&&(this.$el.removeClass("hover-comment"),this.$el.addClass("comment"))},clickHandler:function(a){a.stopPropagation();var b;b="comment"===this.bookmark.get("type")?"comment":"bookmark",this.bookmark.get("bbPageSetView").trigger("annotationClicked",b,this.bookmark.get("CFI"),this.bookmark.get("id"),this.$el.css("top"),this.$el.css("left"),a)}}),d.HighlightView=Backbone.View.extend({el:"<div class='highlight'></div>",events:{mouseenter:"highlightEvent",mouseleave:"highlightEvent",click:"highlightEvent",contextmenu:"highlightEvent"},initialize:function(a){this.highlight=new d.Highlight({CFI:a.CFI,top:a.top,left:a.left,height:a.height,width:a.width,styles:a.styles,highlightGroupCallback:a.highlightGroupCallback,callbackContext:a.callbackContext})},render:function(){return this.setCSS(),this.el},resetPosition:function(a,b,c,d){this.highlight.set({top:a,left:b,height:c,width:d}),this.setCSS()},setStyles:function(a){this.highlight.set({styles:a}),this.render()},setCSS:function(){var a=this.highlight.get("styles")||{};this.$el.css({top:this.highlight.get("top")+"px",left:this.highlight.get("left")+"px",height:this.highlight.get("height")+"px",width:this.highlight.get("width")+"px","background-color":a.fill_color||"normal"})},setBaseHighlight:function(){this.$el.addClass("highlight"),this.$el.removeClass("hover-highlight")},setHoverHighlight:function(){this.$el.addClass("hover-highlight"),this.$el.removeClass("highlight")},highlightEvent:function(a){a.stopPropagation();var b=(this.highlight.get("highlightGroupCallback"),this.highlight.get("callbackContext"));b.highlightGroupCallback(a)}}),d.UnderlineView=Backbone.View.extend({el:"<div class='underline-range'>              <div class='transparent-part'></div>              <div class='underline-part'></div>           </div>",events:{mouseenter:"underlineEvent",mouseleave:"underlineEvent",click:"underlineEvent"},initialize:function(a){this.underline=new d.Underline({CFI:a.CFI,top:a.top,left:a.left,height:a.height,width:a.width,styles:a.styles,underlineGroupCallback:a.underlineGroupCallback,callbackContext:a.callbackContext}),this.$transparentElement=$(".transparent-part",this.$el),this.$underlineElement=$(".underline-part",this.$el)},render:function(){return this.setCSS(),this.el},resetPosition:function(a,b,c,d){this.underline.set({top:a,left:b,height:c,width:d}),this.setCSS()},setStyles:function(a){this.underline.set({styles:a}),this.render()},setCSS:function(){var a=this.underline.get("styles")||{};this.$el.css({top:this.underline.get("top")+"px",left:this.underline.get("left")+"px",height:this.underline.get("height")+"px",width:this.underline.get("width")+"px"}),this.$underlineElement.css({"background-color":a.fill_color||"normal"}),this.$underlineElement.addClass("underline")},underlineEvent:function(a){a.stopPropagation();var b=(this.underline.get("underlineGroupCallback"),this.underline.get("callbackContext"));b.underlineGroupCallback(a)},setBaseUnderline:function(){this.$underlineElement.addClass("underline"),this.$underlineElement.removeClass("hover-underline")},setHoverUnderline:function(){this.$underlineElement.addClass("hover-underline"),this.$underlineElement.removeClass("underline")}}),d.ImageAnnotation=Backbone.Model.extend({initialize:function(a,b){var c=this,d=$(this.get("imageNode"));d.on("mouseenter",function(){c.setMouseenterBorder()}),d.on("mouseleave",function(){c.setMouseleaveBorder()}),d.on("click",function(){c.get("bbPageSetView").trigger("annotationClicked","image",c.get("CFI"),c.get("id"),event)})},render:function(){this.setCSS()},setCSS:function(){$(this.get("imageNode")).css({border:"5px solid rgb(255, 0, 0)",border:"5px solid rgba(255, 0, 0, 0.2)","-webkit-background-clip":"padding-box","background-clip":"padding-box"})},setMouseenterBorder:function(){$(this.get("imageNode")).css({border:"5px solid rgba(255, 0, 0, 0.4)"})},setMouseleaveBorder:function(){$(this.get("imageNode")).css({border:"5px solid rgba(255, 0, 0, 0.2)"})}});var e=new d.ReflowableAnnotations({contentDocumentDOM:a,bbPageSetView:b,annotationCSSUrl:c});return{addSelectionHighlight:function(a,b,c){return e.addSelectionHighlight(a,b,c)},addSelectionBookmark:function(a,b){return e.addSelectionBookmark(a,b)},addSelectionImageAnnotation:function(a){return e.addSelectionImageAnnotation(a)},addHighlight:function(a,b,c,d){return e.addHighlight(a,b,c,d)},addBookmark:function(a,b,c){return e.addBookmark(a,b,c)},addImageAnnotation:function(a,b){return e.addImageAnnotation(a,b)},updateAnnotationView:function(a,b){return e.updateAnnotationView(a,b)},redraw:function(){return e.redraw()},getBookmark:function(a){return e.annotations.getBookmark(a)},getBookmarks:function(){return e.annotations.getBookmarks()},getHighlight:function(a){return e.annotations.getHighlight(a)},getHighlights:function(){return e.annotations.getHighlights()},getUnderline:function(a){return e.annotations.getUnderline(a)},getUnderlines:function(){return e.annotations.getUnderlines()},getImageAnnotation:function(){},getImageAnnotations:function(){},removeAnnotation:function(a){return e.remove(a)},getCurrentSelectionCFI:function(){return e.getCurrentSelectionCFI()},getCurrentSelectionOffsetCFI:function(){return e.getCurrentSelectionOffsetCFI()},removeHighlight:function(a){return e.removeHighlight(a)}}};define("annotations_module",["epubCfi"],function(a){return function(){var b;return b||a.annotations_module}}(this)),ReadiumSDK.Views.AnnotationsManager=function(a,b){function c(a){var b=new RegExp("^.*!"),c=a.replace(b,""),d=c.substring(0,c.length-1);return d}var d=this,e={},f={},g=a,h=b.annotationCSSUrl;h||console.warn("WARNING! Annotations CSS not supplied. Highlighting is not going to work."),_.extend(d,Backbone.Events),this.on("all",function(a){var b=Array.prototype.slice.call(arguments),h="annotationClicked";if(b.length&&b[0]===h)for(var i in e){var j=b[4],k=b[3],l=b[2],m=b[1];if(e[i].getHighlight(k)){var n=f[i].idref,o=c(l);b=[h,m,n,o,k,j]}}d.trigger.apply(g,b)}),this.attachAnnotations=function(a,b){var c=a[0].contentDocument;e[b.index]=new EpubAnnotationsModule(c,d,h),f[b.index]=b;for(var g in e)Math.abs(g-g.index)>3&&delete e[g]},this.getCurrentSelectionCfi=function(){for(var a in e){var b=e[a],c=b.getCurrentSelectionCFI();if(c)return{idref:f[a].idref,cfi:c}}return void 0},this.addSelectionHighlight=function(a,b){for(spine in e){var c=e[spine];if(c.getCurrentSelectionCFI()){var d=c.addSelectionHighlight(a,b);return d.idref=f[spine].idref,d}}return void 0},this.addHighlight=function(a,b,d,g,h){for(var i in e)if(f[i].idref===a){var j="epubcfi(/99!"+b+")",k=e[i],l=k.addHighlight(j,d,g,h);return l.idref=a,l.CFI=c(l.CFI),l}return void 0},this.removeHighlight=function(a){var b=void 0;for(var c in e){var d=e[c];b=d.removeHighlight(a)}return b}},define("annotationsManager",["epubCfi","annotations_module"],function(a){return function(){var b;return b||a.annotationsManager}}(this)),ReadiumSDK.Models.Trigger=function(a){var b=$(a);this.action=b.attr("action"),this.ref=b.attr("ref"),this.event=b.attr("ev:event"),this.observer=b.attr("ev:observer"),this.ref=b.attr("ref")},ReadiumSDK.Models.Trigger.register=function(a){$("trigger",a).each(function(){var b=new ReadiumSDK.Models.Trigger(this);b.subscribe(a)})},ReadiumSDK.Models.Trigger.prototype.subscribe=function(a){var b="#"+this.observer,c=this;$(b,a).on(this.event,function(){c.execute(a)})},ReadiumSDK.Models.Trigger.prototype.execute=function(a){var b=$("#"+ReadiumSDK.Helpers.escapeJQuerySelector(this.ref),a);switch(this.action){case"show":b.css("visibility","visible");break;case"hide":b.css("visibility","hidden");break;case"play":b[0].currentTime=0,b[0].play();break;case"pause":b[0].pause();break;case"resume":b[0].play();break;case"mute":b[0].muted=!0;break;case"unmute":b[0].muted=!1;break;default:console.log("do not no how to handle trigger "+this.action)}},define("triggers",["readiumSDK"],function(a){return function(){var b;return b||a.triggers}}(this)),ReadiumSDK.Views.ScrollView=function(a,b,c){function d(a,b){if(aa)return void a();var c=u();if(!c)return void a();var e=J(0),f=I(c);if(e.top-f.bottom>U){var g=B();p(c),i(g-(f.bottom-f.top),void 0),b("updateLoadedViewsTop 1"),d(a,b)}else e.top-f.top<U?l(c,function(c){c?(b("updateLoadedViewsTop 2"),d(a,b)):a()}):a()}function e(a,b){if(aa)return void a();var c=v();if(!c)return void a();var d=J(0),f=I(c);f.top-d.bottom>U?(p(c),b("updateLoadedViewsBottom 1"),e(a,b)):f.bottom-d.bottom<U?n(c,function(c){b("updateLoadedViewsBottom 2"),c?e(a,b):a()}):a()}function f(a){if(b){var c=void 0;if(P&&a){var f=a.offset();f&&(c=f.top)}var g=function(b){if(P){if(!c)return;var d=void 0,e=a.offset();if(e&&(d=e.top),!d)return;var f=d-c;Math.abs(f)>1&&console.debug("@@@@@@@@@@@@@@@ SCROLL ADJUST ("+b+") "+f+" -- "+a.currentSpineItem().href)}};ba=!0,e(function(){d(function(){setTimeout(function(){ba=!1},V+100)},g)},g)}}function g(a){var b=c.viewerSettings();b.mediaOverlaysPreservePlaybackWhenScroll||!ea&&c.isMediaOverlayAvailable()&&(ea=c.isPlayingMediaOverlay(),ea&&c.pauseMediaOverlay())}function h(a){if(!ba&&!ca&&!da){f(),A(W);var b=c.viewerSettings();b.mediaOverlaysPreservePlaybackWhenScroll||ea&&setTimeout(function(){c.playMediaOverlay(),ea=!1},100)}}function i(a,b){R[0].scrollTop=a,b&&A(b.initiator,b.spineItem,b.elementId)}function j(a){var b=B(),c=I(a);m(a);var d=I(a),e=d.bottom-d.top,f=c.bottom-c.top,g=e-f;Math.abs(g)>0&&(P&&console.debug("IMMEDIATE SCROLL ADJUST: "+a.currentSpineItem().href+" == "+g),i(b+g))}function k(a,b,c,d,e,f,g,h){if(!ReadiumSDK.Helpers.isIframeAlive(c))return P&&console.log("reachStableContentHeight ! win && doc (iFrame disposed?)"),void(h&&h(!1));var i=10,k=300,l=c.contentWindow,n=c.contentDocument,o=parseInt(Math.round(parseFloat(l.getComputedStyle(n.documentElement).height))),p=o;0===a?j(b):m(b);var q=function(e){return P&&e!==i&&console.log("tryAgainFunc - "+e+": "+d+"  <"+p+" -- "+o+">"),e--,0>e?(P&&console.error("tryAgainFunc abort: "+d),void(h&&h(!0))):void setTimeout(function(){try{if(!ReadiumSDK.Helpers.isIframeAlive(c))return P&&console.log("tryAgainFunc ! win && doc (iFrame disposed?)"),void(h&&h(!1));var f=c.contentWindow,i=c.contentDocument,k=parseInt(Math.round(parseFloat(window.getComputedStyle(c).height))),l=parseInt(Math.round(parseFloat(f.getComputedStyle(i.documentElement).height)));if(o!==l)return o=l,void q(e);var n=k-l;if(Math.abs(n)>4){if(P&&(console.log("$$$ IFRAME HEIGHT ADJUST: "+d+"  ["+n+"]<"+p+" -- "+o+">"),console.log(g)),0===a?j(b):m(b),!ReadiumSDK.Helpers.isIframeAlive(c))return P&&console.log("tryAgainFunc ! win && doc (iFrame disposed?)"),void(h&&h(!1));var f=c.contentWindow,i=c.contentDocument,r=parseInt(Math.round(parseFloat(f.getComputedStyle(i.documentElement).height))),s=parseInt(Math.round(parseFloat(window.getComputedStyle(c).height))),t=s-r;if(Math.abs(t)>4)return P&&(console.error("## IFRAME HEIGHT ADJUST: "+d+"  ["+t+"]<"+p+" -- "+o+">"),console.log(g)),void q(e);P&&console.log(">> IFRAME HEIGHT ADJUSTED OKAY: "+d+"  ["+n+"]<"+p+" -- "+o+">")}}catch(u){return console.error(u),void(h&&h(!1))}h&&h(!0)},k)};q(i)}function l(a,b){var c=Y.prevItem(a.currentSpineItem(),!0);if(!c)return void b(!1);var d=r(!0),e=v();d.element().insertAfter(e.element()),d.loadSpineItem(c,function(e,f,g,h,j){if(e){m(d);var l=I(d);p(d);var n=B(),o=r(),q=l.bottom-l.top;o.setHeight(q),o.element().insertBefore(a.element()),n+=q,i(n,void 0),o.loadSpineItem(c,function(a,d,e,f,g){if(a){var h=function(c){w(o,a,d,e,f,g),b(c)};k(0,o,d[0],e.href,e.isFixedLayout(),e.isFixedLayout()?o.meta_width():0,"addToTopOf",h)}else console.error("Unable to open 2 "+c.href),p(o),b(!1)})}else console.error("Unable to open 1 "+c.href),p(d),b(!1)})}function m(a){a.currentSpineItem().isFixedLayout()?a.scaleToWidth(R.width()):a.resizeIFrameToContent()}function n(a,b){var c=Y.nextItem(a.currentSpineItem(),!0);if(!c)return void b(!1);var d=(B(),r());d.element().insertAfter(a.element()),d.loadSpineItem(c,function(a,e,f,g,h){if(a){var i=function(c){w(d,a,e,f,g,h),b(c)};k(2,d,e[0],f.href,f.isFixedLayout(),f.isFixedLayout()?d.meta_width():0,"addToBottomOf",i)}else console.error("Unable to load "+c.href),b(!1)})}function o(){var a=[];t(function(b){a.push(b)},!1);for(var b=0,c=a.length;c>b;b++)p(a[b])}function p(a){a.element().remove()}function q(a){R.css("left",a.left),R.css("top",a.top),R.css("right",a.right),R.css("bottom",a.bottom)}function r(d){a.disablePageTransitions=!0;var e=new ReadiumSDK.Views.OnePageView(a,["content-doc-frame"],!0,c);return e.render(),fa&&e.setViewSettings(fa),d||e.element().data("pageView",e),b&&e.decorateIframe(),e}function s(a,b){var c=void 0;return t(function(b){return b.currentSpineItem()==a?(c=b,!1):!0},b),c}function t(a,b){for(var c=R.children(),d=c.length,e=b?function(a){return a-1}:function(a){return a+1},f=b?function(a){return a>=0}:function(a){return d>a},g=b?d-1:0,h=g;f(h);h=e(h)){var i=c.eq(h),j=i.data("pageView");if(j&&a(j)===!1)return}}function u(){var a=void 0;return t(function(b){return a=b,!1},!1),a}function v(){var a=void 0;return t(function(b){return a=b,!1},!0),a}function w(a,b,c,d,e,f){b&&e&&W.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,c,d)}function x(a,b){o();var c=(B(),r());R.append(c.element()),c.loadSpineItem(a,function(a,d,e,f,g){if(a){var h=function(h){w(c,a,d,e,f,g),b(c)};k(1,c,d[0],e.href,e.isFixedLayout(),e.isFixedLayout()?c.meta_width():0,"openPage",h)}else console.error("Unable to load "+e.href),p(c),c=void 0;b(c)})}function y(a,b){var c,d,e,f,g=0;if(void 0!==b.scrollTop)g=b.scrollTop;else if(void 0!==b.spineItemPageIndex){var h;c=z(),h=b.spineItemPageIndex<0?0:b.spineItemPageIndex>=c?c-1:b.spineItemPageIndex,g=h*D()}else if(a&&b.elementId){if(f=I(a),e=a.getNavigator(),d=e.getElementById(b.elementId),!d||!d.length)return void console.warn("Element id="+b.elementId+" not found!");if(M(a,d,60))return void A(b.initiator,b.spineItem,b.elementId);g=e.getVerticalOffsetForElement(d)+f.top}else if(a&&b.elementCfi){if(f=I(a),e=a.getNavigator(),d=e.getElementByCfi(b.elementCfi),!d||!d.length)return void console.warn("Element cfi="+b.elementCfi+" not found!");if(M(a,d,60))return void A(b.initiator,b.spineItem,b.elementId);g=e.getVerticalOffsetForElement(d)+f.top}else if(b.firstPage)g=0;else if(b.lastPage){if(c=z(),0===c)return;g=E()-D()-5}else a?(f=I(a),g=f.top):g=0;B()!=g?(ca=!0,i(g,b),setTimeout(function(){
ca=!1},V+100)):A(b.initiator,b.spineItem,b.elementId)}function z(){return Math.ceil(E()/D())}function A(a,b,c){W.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:W.getPaginationInfo(),initiator:a,spineItem:b,elementId:c})}function B(){return R[0].scrollTop}function C(){return E()-(B()+D())}function D(){return R.height()}function E(){return R[0].scrollHeight}function F(){var a=[],b=J(-T);return t(function(c){if(H(c,b))a.push(c);else if(a.length>0)return!1;return!0},!1),a}function G(){var a=F();return a[0]}function H(a,b){var c=I(a);return L(K(c,b))>0}function I(a){var b={top:0,bottom:0};return b.top=a.element().position().top+B(),b.bottom=b.top+a.getCalculatedPageHeight(),b}function J(a){0===a||a||(a=0);var b={top:B()-a,bottom:B()+D()+a};return b.top<0&&(b.top=0),b.bottom>E()&&(b.bottom=E()),b}function K(a,b){return{top:Math.max(a.top,b.top),bottom:Math.min(a.bottom,b.bottom)}}function L(a){return a.bottom<a.top?0:a.bottom-a.top}function M(a,b,c){var d=O(a,b);return N(d,c)}function N(a,b){var c=J(),d=Math.min(L(c),L(a));0===d&&(d=5);var e=K(c,a),f=L(e)/d*100;return f>=b}function O(a,b){var c=I(a),d={top:0,bottom:0};return d.top=b.offset().top+c.top,d.bottom=d.top+b.height(),d}var P=!1;_.extend(this,Backbone.Events);var Q,R,S,T=5,U=2e3,V=300,W=this,X=a.$viewport,Y=a.spine,Z=a.userStyles,aa=!1,ba=!1,ca=!1,da=!1;this.isContinuousScroll=function(){return b},this.render=function(){var a=ReadiumSDK.Helpers.loadTemplate("scrolled_book_frame",{});S=$(a),X.append(S),R=$("#scrolled-content-frame",S),R.css("overflow",""),R.css("overflow-y","auto"),R.css("overflow-x","hidden"),R.css("-webkit-overflow-scrolling","touch"),R.css("width","100%"),R.css("height","100%"),R.css("position","relative");var b=c.viewerSettings();b&&"undefined"!=typeof b.enableGPUHardwareAccelerationCSS3D||(b=new ReadiumSDK.Models.ViewerSettings({})),b.enableGPUHardwareAccelerationCSS3D&&R.css("transform","translateZ(0)"),W.applyStyles();var d=_.debounce(h,V);return R.on("scroll",function(a){d(a),g()}),W};var ea=!1;this.remove=function(){S.remove()},this.onViewportResize=function(){R&&(t(function(a){m(a)},!1),A(W),f())};var fa=void 0;this.setViewSettings=function(a){fa=a,t(function(b){b.setViewSettings(a)},!1)},this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(Z.getStyles(),S.parent());var a=ReadiumSDK.Helpers.Margins.fromElement(S);q(a.padding)},this.applyBookStyles=function(){t(function(a){a.applyBookStyles()},!1)},this.openPage=function(a){aa=!0;var b=function(a,b){Q=void 0,y(a,b),aa=!1,f(a)};if(a.spineItem){var c=s(a.spineItem);c?b(c,a):(Q=a,da=!0,x(a.spineItem,function(c){setTimeout(function(){da=!1},V+100),c&&Q?c.currentSpineItem()===Q.spineItem?b(c,Q):W.openPage(Q):A(a.initiator,a.spineItem,a.elementId)}))}else b(void 0,a)},this.openPageNext=function(a){var b;C()>0&&(b=new ReadiumSDK.Models.PageOpenRequest(void 0,a),b.scrollTop=B()+Math.min(C(),D()-T),y(void 0,b))},this.openPagePrev=function(a){var b;B()>0&&(b=new ReadiumSDK.Models.PageOpenRequest(void 0,a),b.scrollTop=B()-(D()-T),b.scrollTop<0&&(b.scrollTop=0),y(void 0,b))},this.getFirstVisibleElementCfi=function(){var a=G();return a?a.getNavigator().getFirstVisibleElementCfi(B()):void 0},this.getPaginationInfo=function(){for(var a,b,c,d,e,f,g,h,i=J(),j=i.bottom-i.top,k=new ReadiumSDK.Models.CurrentPagesInfo(Y,!1),l=F(),m=0,n=l.length;n>m;m++)c=l[m],a=c.currentSpineItem(),d=I(c),e=Math.max(i.top-d.top,0),f=Math.max(d.bottom-i.bottom,0),g=Math.ceil(e/j),h=Math.ceil(f/j),b=g+h+1,k.addOpenPage(g,b,a.idref,a.index);return k},this.bookmarkCurrentPage=function(){var a=G();return a?new ReadiumSDK.Models.BookmarkData(a.currentSpineItem().idref,W.getFirstVisibleElementCfi()):new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){var a=[];return t(function(b){a.push(b.currentSpineItem())},!1),a},this.getElement=function(a,b){var c=void 0;return t(function(d){return d.currentSpineItem()==a?(c=d.getNavigator().getElement(b),!1):!0},!1),c},this.getElementByCfi=function(a,b,c,d,e){var f=void 0;return t(function(g){return g.currentSpineItem()==a?(f=g.getElementByCfi(a,b,c,d,e),!1):!0},!1),f?f:void console.error("spine item is not loaded")},this.getElementById=function(a,b){var c=void 0;return t(function(d){return d.currentSpineItem()==a?(c=d.getNavigator().getElementById(b),!1):!0},!1),c?c:void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){var a,b=J(),c=void 0,d={top:0,bottom:0},e=!1;return t(function(f){if(a=I(f),d.top=Math.max(a.top,b.top)-a.top,d.bottom=Math.min(a.bottom,b.bottom)-a.top,L(d)>0){if(e=!0,c=f.getNavigator().getFirstVisibleMediaOverlayElement(d))return!1}else if(e)return!1;return!0},!1),c},this.insureElementVisibility=function(a,b,c){var d=void 0;if(t(function(b){return b.currentSpineItem().idref===a?(d=b,!1):!0},!1),!d)return void console.warn("Page for element "+b+" not found");var e=$(b),f=O(d,e);if(!N(f,60)){var g=Y.getItemById(a),h=new ReadiumSDK.Models.PageOpenRequest(g,c);h.scrollTop=f.top,W.openPage(h)}}},define("scrollView",["readiumSDK","cfiNavigationLogic","bookmarkData","triggers","onePageView"],function(a){return function(){var b;return b||a.scrollView}}(this)),ReadiumSDK.Models.Switches=function(){},ReadiumSDK.Models.Switches.apply=function(a){function b(a){var b=a.attributes["required-namespace"];if(!b)return console.log("Encountered a case statement with no required-namespace"),!1;var c=["http://www.w3.org/1998/Math/MathML"];return _.include(c,b)}$("switch",a).each(function(){var a=!1;$("case",this).each(function(){!a&&b(this)?a=!0:$(this).remove()}),a&&$("default",this).remove()})},define("switches",["readiumSDK"],function(a){return function(){var b;return b||a.switches}}(this)),ReadiumSDK.Views.ReaderView=function(a){function b(a){return"scroll-doc"==t.scroll?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:"scroll-continuous"==t.scroll?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:a.isFixedLayout()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:a.isFlowScrolledDoc()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:a.isFlowScrolledContinuous()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED}function c(a,c){var e=b(a);if(q){if(p.getCurrentViewType()==e)return void c(!1);d()}var f={$viewport:o,spine:s,userStyles:u,bookStyles:v,iframeLoader:n};q=p.createViewForType(e,f),p.trigger(ReadiumSDK.Events.READER_VIEW_CREATED,e),q.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,function(a,b){if(ReadiumSDK.Helpers.isIframeAlive(a[0])){m.attachMediaOverlayData(a,b,t),w.processLinkElements(a,b),x.attachAnnotations(a,b);var c=a[0].contentDocument;ReadiumSDK.Models.Trigger.register(c),ReadiumSDK.Models.Switches.apply(c),p.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,a,b)}}),q.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,function(a,b){p.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,a,b)}),q.on(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,function(a){l.onPageChanged(a),p.trigger(ReadiumSDK.Events.PAGINATION_CHANGED,a)}),q.on(ReadiumSDK.Events.FXL_VIEW_RESIZED,function(){p.trigger(ReadiumSDK.Events.FXL_VIEW_RESIZED)}),q.render(),q.setViewSettings(t),setTimeout(function(){c(!0)},50)}function d(){q&&(p.trigger(ReadiumSDK.Events.READER_VIEW_DESTROYED),q.off(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED),q.remove(),q=void 0)}function e(a){p.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_STATUS_CHANGED,a)}function f(a){if(!a)return void console.log("idref parameter value missing!");var b=s.getItemById(a);return b?b:void console.log("Spine item with id "+a+" not found!")}function g(a,b){c(a.spineItem,function(c){c||q.setViewSettings(t),q.openPage(a,b)})}function h(a){ReadiumSDK.Helpers.setStyles(u.getStyles(),o),l&&l.applyStyles(),a||q&&q.applyStyles()}function i(){z=null,A=!1,q&&(q.isReflowable&&q.isReflowable()&&(A=p.isPlayingMediaOverlay(),A&&p.pauseMediaOverlay()),z=q.bookmarkCurrentPage())}function j(){q&&p.handleViewportResize(z)}function k(){j(),A&&p.playMediaOverlay()}_.extend(this,Backbone.Events);var l,m,n,o,p=this,q=void 0,r=void 0,s=void 0,t=new ReadiumSDK.Models.ViewerSettings({}),u=new ReadiumSDK.Collections.StyleCollection,v=new ReadiumSDK.Collections.StyleCollection,w=new ReadiumSDK.Views.InternalLinksSupport(this),x=new ReadiumSDK.Views.AnnotationsManager(p,a),y=ReadiumSDK.Helpers.extendedThrottle(i,j,k,250,1e3,p);$(window).on("resize.ReadiumSDK.readerView",y),a.el instanceof $?(o=a.el,console.log("** EL is a jQuery selector:"+a.el.attr("id"))):(o=$(a.el),console.log("** EL is a string:"+o.attr("id"))),n=a.iframeLoader?a.iframeLoader:new ReadiumSDK.Views.IFrameLoader({mathJaxUrl:a.mathJaxUrl}),_needsFixedLayoutScalerWorkAround=a.needsFixedLayoutScalerWorkAround,this.needsFixedLayoutScalerWorkAround=function(){return _needsFixedLayoutScalerWorkAround},this.createViewForType=function(a,b){var c;switch(o.css("overflow","hidden"),a){case ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:o.css("overflow","auto"),c=new ReadiumSDK.Views.FixedView(b,p);break;case ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:c=new ReadiumSDK.Views.ScrollView(b,!1,p);break;case ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:c=new ReadiumSDK.Views.ScrollView(b,!0,p);break;default:c=new ReadiumSDK.Views.ReflowableView(b,p)}return c},this.getCurrentViewType=function(){return q?q instanceof ReadiumSDK.Views.ReflowableView?ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED:q instanceof ReadiumSDK.Views.FixedView?ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:q instanceof ReadiumSDK.Views.ScrollView?q.isContinuousScroll()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:void console.error("Unrecognized view type"):void 0},this.getLoadedSpineItems=function(){return q?q.getLoadedSpineItems():[]},this.viewerSettings=function(){return t},this["package"]=function(){return r},this.spine=function(){return s},this.userStyles=function(){return u},this.openBook=function(a){var b=a["package"]?a["package"]:a;r=new ReadiumSDK.Models.Package(b),s=r.spine,s.handleLinear(!0),l&&l.reset(),l=new ReadiumSDK.Views.MediaOverlayPlayer(p,$.proxy(e,p)),l.setAutomaticNextSmil(t.mediaOverlaysAutomaticPageTurn?!0:!1),m=new ReadiumSDK.Views.MediaOverlayDataInjector(r.media_overlay,l),d(),a.settings&&p.updateSettings(a.settings),a.styles&&p.setStyles(a.styles);var c=void 0;a.openPageRequest&&(a.openPageRequest.idref||a.openPageRequest.contentRefUrl&&a.openPageRequest.sourceFileHref?c=a.openPageRequest:console.log("Invalid page request data: idref required!"));var f=!1;if(c){c=a.openPageRequest;try{f=c.idref?c.spineItemPageIndex?!p.openSpineItemPage(c.idref,c.spineItemPageIndex,p):c.elementCfi?!p.openSpineItemElementCfi(c.idref,c.elementCfi,p):!p.openSpineItemPage(c.idref,0,p):!p.openContentUrl(c.contentRefUrl,c.sourceFileHref,p)}catch(h){console.error("openPageRequest fail: fallback to first page!"),console.log(h),f=!0}}else f=!0;if(f){var i=s.first();if(i){var j=new ReadiumSDK.Models.PageOpenRequest(i,p);j.setFirstPage(),g(j,0)}}},this.openPageLeft=function(){r.spine.isLeftToRight()?p.openPagePrev():p.openPageNext()},this.openPageRight=function(){r.spine.isLeftToRight()?p.openPageNext():p.openPagePrev()},this.isCurrentViewFixedLayout=function(){return q instanceof ReadiumSDK.Views.FixedView},this.setZoom=function(a){p.isCurrentViewFixedLayout()&&q.setZoom(a)},this.getViewScale=function(){return p.isCurrentViewFixedLayout()?100*q.getViewScale():100},this.updateSettings=function(a){if(t.update(a),l&&l.setAutomaticNextSmil(t.mediaOverlaysAutomaticPageTurn?!0:!1),q&&!a.doNotUpdateView){var b=q.bookmarkCurrentPage();if(b&&b.idref){var d=!1;q.isReflowable&&q.isReflowable()&&(d=p.isPlayingMediaOverlay(),d&&p.pauseMediaOverlay());var e=s.getItemById(b.idref);c(e,function(a){a||q.setViewSettings(t),p.openSpineItemElementCfi(b.idref,b.contentCFI,p),d&&p.playMediaOverlay(),p.trigger(ReadiumSDK.Events.SETTINGS_APPLIED)})}}p.trigger(ReadiumSDK.Events.SETTINGS_APPLIED)},this.openPageNext=function(){if(p.getCurrentViewType()===ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS)return void q.openPageNext(p);var a=q.getPaginationInfo();if(0!=a.openPages.length){var b=a.openPages[a.openPages.length-1];if(b.spineItemPageIndex<b.spineItemPageCount-1)return void q.openPageNext(p);var c=s.getItemById(b.idref),d=s.nextItem(c);if(d){var e=new ReadiumSDK.Models.PageOpenRequest(d,p);e.setFirstPage(),g(e,2)}}},this.openPagePrev=function(){if(p.getCurrentViewType()===ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS)return void q.openPagePrev(p);var a=q.getPaginationInfo();if(0!=a.openPages.length){var b=a.openPages[0];if(b.spineItemPageIndex>0)return void q.openPagePrev(p);var c=s.getItemById(b.idref),d=s.prevItem(c);if(d){var e=new ReadiumSDK.Models.PageOpenRequest(d,p);e.setLastPage(),g(e,1)}}},this.openSpineItemElementCfi=function(a,b,c){var d=f(a);if(!d)return!1;var e=new ReadiumSDK.Models.PageOpenRequest(d,c);return b&&e.setElementCfi(b),g(e,0),!0},this.openPageIndex=function(a,b){if(!q)return!1;var c;if(r.isFixedLayout()){var d=s.items[a];if(!d)return!1;c=new ReadiumSDK.Models.PageOpenRequest(d,b),c.setPageIndex(0)}else{var e=this.getLoadedSpineItems();e.length>0&&(c=new ReadiumSDK.Models.PageOpenRequest(e[0],b),c.setPageIndex(a))}return g(c,0),!0},this.openSpineItemPage=function(a,b,c){var d=f(a);if(!d)return!1;var e=new ReadiumSDK.Models.PageOpenRequest(d,c);return b&&e.setPageIndex(b),g(e,0),!0},this.setStyles=function(a,b){for(var c=a.length,d=0;c>d;d++)a[d].declarations?u.addStyle(a[d].selector,a[d].declarations):u.removeStyle(a[d].selector);h(b)},this.setBookStyles=function(a){for(var b=a.length,c=0;b>c;c++)v.addStyle(a[c].selector,a[c].declarations);q&&q.applyBookStyles()},this.getElement=function(a,b){return q?q.getElement(a,b):void 0},this.getElementById=function(a,b){return q?q.getElementById(a,b):void 0},this.getElementByCfi=function(a,b,c,d,e){return q?q.getElementByCfi(a,b,c,d,e):void 0},this.mediaOverlaysOpenContentUrl=function(a,b,c){l.mediaOverlaysOpenContentUrl(a,b,c)},this.openContentUrl=function(a,b,c){var d,e,f=ReadiumSDK.Helpers.ResolveContentRef(a,b),g=f.indexOf("#");g>=0?(d=f.substr(0,g),e=f.substr(g+1)):(d=f,e=void 0);var h=s.getItemByHref(d);if(!h){console.warn("spineItem "+d+" not found");var i=decodeURIComponent(d);if(h=s.getItemByHref(i),!h)return console.warn("decoded spineItem "+i+" missing as well"),!1}return p.openSpineItemElementId(h.idref,e,c)},this.openSpineItemElementId=function(a,b,c){var d=s.getItemById(a);if(!d)return!1;var e=new ReadiumSDK.Models.PageOpenRequest(d,c);return b&&e.setElementId(b),g(e,0),!0},this.bookmarkCurrentPage=function(){return JSON.stringify(q.bookmarkCurrentPage())},this.clearStyles=function(){u.resetStyleValues(),h(),u.clear()},this.clearBookStyles=function(){q&&(v.resetStyleValues(),q.applyBookStyles()),v.clear()},this.isMediaOverlayAvailable=function(){return l?l.isMediaOverlayAvailable():!1},this.toggleMediaOverlay=function(){l.toggleMediaOverlay()},this.nextMediaOverlay=function(){l.nextMediaOverlay()},this.previousMediaOverlay=function(){l.previousMediaOverlay()},this.escapeMediaOverlay=function(){l.escape()},this.ttsEndedMediaOverlay=function(){l.onTTSEnd()},this.pauseMediaOverlay=function(){l.pause()},this.playMediaOverlay=function(){l.play()},this.isPlayingMediaOverlay=function(){return l.isPlaying()},this.getFirstVisibleMediaOverlayElement=function(){return q?q.getFirstVisibleMediaOverlayElement():void 0},this.insureElementVisibility=function(a,b,c){q&&q.insureElementVisibility(a,b,c)};var z=null,A=!1;this.handleViewportResize=function(a){if(q){var b=a||q.bookmarkCurrentPage();if(q.isReflowable&&q.isReflowable()&&b&&b.idref){var d=s.getItemById(b.idref);c(d,function(a){p.openSpineItemElementCfi(b.idref,b.contentCFI,p)})}else q.onViewportResize()}},this.getCurrentSelectionCfi=function(){return x.getCurrentSelectionCfi()},this.addHighlight=function(a,b,c,d,e){return x.addHighlight(a,b,c,d,e)},this.addSelectionHighlight=function(a,b){return x.addSelectionHighlight(a,b)},this.removeHighlight=function(a){return x.removeHighlight(a)},this.addIFrameEventListener=function(a,b,c){n.addIFrameEventListener(a,b,c)};var B=function(){var a={},b=!1,c=void 0;this.setCallback_PlayPause=function(a){c=a};var d=void 0;this.setCallback_IsAvailable=function(a){d=a},this.playPause=function(a){e(a)};var e=function(b){c&&c(b);try{var d=void 0;for(var e in a)if(a.hasOwnProperty(e)){var f=a[e];if(f&&f.active&&(d&&console.error("More than one active iframe?? (pagination)"),d=f.$iframe)){var g=$("audio",d[0].contentDocument);$.each(g,function(){var a=this.getAttribute("epub:type")||this.getAttribute("type");return a?a.indexOf("ibooks:soundtrack")<0&&a.indexOf("media:soundtrack")<0&&a.indexOf("media:background")<0?!0:(b&&this.play?this.play():this.pause&&this.pause(),!0):!0})}}}catch(h){console.error(h)}};this.setPlayState=function(a){b=a},p.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,function(b,c){try{c&&c.idref&&b&&b[0]&&(a[c.idref]={$iframe:b,href:c.href})}catch(d){console.error(d)}}),p.on(ReadiumSDK.Events.PAGINATION_CHANGED,function(c){var f=!1;try{for(var g in a)if(a.hasOwnProperty(g)){var h=c.spineItem&&c.spineItem.idref===g,i=!1;if(c.paginationInfo&&c.paginationInfo.openPages.length){for(var j=!0,k=0;k<c.paginationInfo.openPages.length;k++)c.paginationInfo.openPages[k].idref===g?i=!0:j=!1;!h&&j&&(h=!0)}if(h||i){var l=a[g];if(!l)continue;a[g].active=h;var m=l.$iframe,n=(l.href,$("audio",m[0].contentDocument));$.each(n,function(){var a=this.getAttribute("epub:type")||this.getAttribute("type");return a?a.indexOf("ibooks:soundtrack")<0&&a.indexOf("media:soundtrack")<0&&a.indexOf("media:background")<0?!0:(this.setAttribute("loop","loop"),this.removeAttribute("autoplay"),h||this.pause&&this.pause(),f=!0,!0):!0})}else a[g]&&(a[g].$iframe=void 0),a[g]=void 0}}catch(o){console.error(o)}d&&d(f),e(f?b?!0:!1:!1)}),p.on(ReadiumSDK.Events.MEDIA_OVERLAY_STATUS_CHANGED,function(c){if(c.smilIndex){var d=p["package"](),f=d.media_overlay.smilAt(c.smilIndex);if(f&&f.spineItemId){var g=!1;for(var h in a)if(a.hasOwnProperty(h)){var i=a[h];i&&i.active&&h!==f.spineItemId&&(e(!1),i.active=!1,g=!0)}if(g){for(var h in a)if(a.hasOwnProperty(h)){var i=a[h];i&&(i.active||h===f.spineItemId&&(i.active=!0))}b&&e(!0)}}}})};this.backgroundAudioTrackManager=new B},ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED=1,ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED=2,ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC=3,ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS=4,define("readerView",["backbone","readiumSDK","helpers","viewerSettings","styleCollection","package","mediaOverlayPlayer","pageOpenRequest","fixedView","reflowableView","mediaOvelayDataInjector","internalLinksSupport","iframeLoader","annotationsManager","scrollView","URIjs","triggers","switches"],function(a){return function(){var b;return b||a.readerView}}(this)),define("epub-fetch/markup_parser",[],function(){var a=function(){var a=this;this.parseXml=function(b){return a.parseMarkup(b,"text/xml")},this.parseMarkup=function(a,b){var c=new window.DOMParser;return c.parseFromString(a,b)}};return a}),define("epub-fetch/discover_content_type",["require","module","jquery","backbone","URIjs"],function(a,b,c,d,e){var f=void 0,g=function(){var a=this;g.suffixContentTypeMap={css:"text/css",epub:"application/epub+zip",gif:"image/gif",html:"text/html",jpg:"image/jpeg",jpeg:"image/jpeg",ncx:"application/x-dtbncx+xml",opf:"application/oebps-package+xml",png:"image/png",svg:"image/svg+xml",xhtml:"application/xhtml+xml"},this.identifyContentTypeFromFileName=function(a){var b=e(a).suffix(),c="application/octet-stream";return"undefined"!=typeof g.suffixContentTypeMap[b]&&(c=g.suffixContentTypeMap[b]),c},this.identifyContentType=function(b){var d=c.ajax({type:"HEAD",url:b,async:!1}).getResponseHeader("Content-Type");return null===d&&(d=a.identifyContentTypeFromFileName(b),console.log("guessed contentType ["+d+"] from URI ["+b+"]. Configuring the web server to provide the content type is recommended.")),d}};return f||(f=new g),f}),define("epub-fetch/plain_resource_fetcher",["require","module","jquery","URIjs","./discover_content_type"],function(a,b,c,d,e){var f=function(a,b){function d(a,b,c){var d=h.resolveURI(a);if("undefined"==typeof a)throw"Fetched file relative path is undefined!";var e=new XMLHttpRequest;e.open("GET",d,!0),e.responseType="arraybuffer",e.onerror=c,e.onload=function(a){b(e.response)},e.send()}var f,g,h=this;this.initialize=function(c){a.getXmlFileDom("META-INF/container.xml",function(b){g=a.getRootFile(b),f=h.resolveURI(g),c()},function(a){console.error("unable to find package document: "+a),f=b,c()})},this.resolveURI=function(a){return b+"/"+a},this.getPackageUrl=function(){return f},this.fetchFileContentsText=function(a,b,d){var e=h.resolveURI(a);if("undefined"==typeof e)throw"Fetched file URL is undefined!";c.ajax({isLocal:0===e.indexOf("http")?!1:!0,url:e,dataType:"text",async:!0,success:function(a){b(a)},error:function(a,b,c){console.error("Error when AJAX fetching "+e),console.error(b),console.error(c),d(c)}})},this.fetchFileContentsBlob=function(b,c,f){var g=a.getDecryptionFunctionForRelativePath(b);if(g){var h=c;c=function(a){g(a,function(a){h(a)})}}d(b,function(a){var d=new Blob([a],{type:e.identifyContentTypeFromFileName(b)});c(d)},f)},this.getPackageDom=function(b,c){h.fetchFileContentsText(g,function(c){var d=a.markupParser.parseXml(c);b(d)},c)}};return f}),define("epub-fetch/zip_resource_fetcher",["require","module","jquery","URIjs","./discover_content_type"],function(a,b,c,d,e){var f=function(a,b,c){function d(a,d){g?a(g,d):(zip.useWebWorkers=!0,zip.workerScriptsPath=c,g=new zip.fs.FS,g.importHttpContent(b,!0,function(){a(g,d)},d))}function f(a,c,e){if("undefined"==typeof a)throw"Fetched file relative path is undefined!";d(function(d,e){var f=d.find(a);"undefined"==typeof f||null===f?e(new Error("Entry "+a+" not found in zip "+b)):f.directory?e(new Error("Entry "+a+" is a directory while a file has been expected")):c(f)},e)}var g,h=!1;this.getPackageUrl=function(){return b},this.fetchFileContentsText=function(a,b,c){f(a,function(a){a.getText(b,void 0,h)},c)},this.fetchFileContentsData64Uri=function(a,b,c){f(a,function(c){c.getData64URI(e.identifyContentTypeFromFileName(a),b,void 0,h)},c)},this.fetchFileContentsBlob=function(b,c,d){var g=a.getDecryptionFunctionForRelativePath(b);if(g){var i=c;c=function(a){g(a,function(a){i(a)})}}f(b,function(a){a.getBlob(e.identifyContentTypeFromFileName(b),c,void 0,h)},d)}};return f}),define("epub-fetch/content_document_fetcher",["require","module","jquery","underscore","URIjs","./discover_content_type"],function(a,b,c,d,e,f){var g=function(a,b,g,h,i){function j(a,b){var c=a.getElementsByTagName("base")[0];if(!c){c=a.createElement("base");var d=a.getElementsByTagName("head")[0];d&&d.insertBefore(c,d.childNodes[0])}c.setAttribute("href",b)}function k(a){a&&(a.message&&console.error(a.message),a.stack&&console.error(a.stack)),console.error(a)}function l(a,b,d,g,h,i,j){function k(e){c(a).data("epubZipOrigHref",b),c(a).attr(d,e)}var l=new e(b).absoluteTo(z).toString(),m=C.getResourceURL(l);if(m)k(m);else{var n=c.Deferred();h.push(n),A.relativeToPackageFetchFileContents(l,g,function(b){var d=function(b){if("text"===g){var d=f.identifyContentTypeFromFileName(l),e=c(a).attr("type");e&&(d=e),b=new Blob([b],{type:d})}var h=window.URL.createObjectURL(b);C.putResource(l,h,b),k(h),n.resolve()};j?j(b,l,d):d(b)},i)}}function m(a,b,f,g,h){var i=a[0],j=a.slice(2),l=d.find(j,function(a){return"undefined"!=typeof a}),m=new e(l),o=""===m.scheme();if(o){var p=new e(l).absoluteTo(f).toString(),q=C.getResourceURL(p);if(q)g[i]={isStyleSheetResource:h,resourceObjectURL:q};else{var r=c.Deferred();b.push(r);var s,t,u=function(a){var b=window.URL.createObjectURL(a);g[i]={isStyleSheetResource:h,resourceObjectURL:b},C.putResource(p,b,a),r.resolve()},v=function(a){k(a),r.resolve()};h?(s="text",t=function(a){n(a,p,function(a){var b=new Blob([a],{type:"text/css"});u(b)})}):(s="blob",t=u),A.relativeToPackageFetchFileContents(p,s,t,v)}}}function n(a,b,d){var e=/[Uu][Rr][Ll]\(\s*([']([^']+)[']|["]([^"]+)["]|([^)]+))\s*\)/g,f=/@[Ii][Mm][Pp][Oo][Rr][Tt]\s*('([^']+)'|"([^"]+)")/g,g={},h=[];[f,e].forEach(function(c){for(var d=c.exec(a);null!=d;){var e=!1;c==f&&(e=!0),m(d,h,b,g,e),d=c.exec(a)}}),h.length>0?c.when.apply(c,h).done(function(){for(var b in g){var c,e=g[b];c=e.isStyleSheetResource?'@import "'+e.resourceObjectURL+'"':"url('"+e.resourceObjectURL+"')";var f=b.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),h=new RegExp(f,"g");a=a.replace(h,c,"g")}d(a)}):d(a)}function o(a,b,d,f,g,h){var i=c(a+"["+b.replace(":","\\:")+"]",x);i.each(function(a,i){var j=c(i).attr(b),k=new e(j);""===k.scheme()&&l(i,j,b,d,f,g,h)})}function p(a,b){o("img","src","blob",a,b),o("image","xlink:href","blob",a,b)}function q(a,b){o("audio","src","blob",a,b)}function r(a,b){o("video","src","blob",a,b),o("video","poster","blob",a,b)}function s(a,b){o("script","src","blob",a,b)}function t(a,b){o("iframe","src","blob",a,b)}function u(a,b){o("link","href","text",a,b,n)}function v(a,b){var d=c("style",x);d.each(function(b,d){var e=c.Deferred();a.push(e);var f=c(d).text();n(f,z,function(a){c(d).text(a),e.resolve()})})}var w,x,y=this,z=b.href,A=a,B=b.media_type,C=h,D=i;this.fetchContentDocumentAndResolveDom=function(a,b){A.relativeToPackageFetchFileContents(z,"text",function(c){w=c,D&&(w=D(g,w)),y.resolveInternalPackageResources(a,b)},b)},this.resolveInternalPackageResources=function(a,b){x=A.markupParser.parseMarkup(w,B),j(x,g);var d=[];A.shouldFetchMediaAssetsProgrammatically()&&(p(d,b),q(d,b),r(d,b)),t(d,b),s(d,b),u(d,b),v(d,b),c.when.apply(c,d).done(function(){a(x)})}};return g}),define("epub-fetch/resource_cache",["underscore"],function(a){var b=function(b,c){function d(){return(new Date).getTime()}function e(){return window.performance&&window.performance.memory&&window.performance.memory.jsHeapSizeLimit?window.performance.memory.jsHeapSizeLimit:null}function f(){if(c)return c;var a=e();return a&&a/10>l?a/10:l}function g(a){if("undefined"!=typeof a.orderingByLastUseTimestampIdx){var b=a.orderingByLastUseTimestampIdx;j.splice(b,1);for(var c=b;c<j.length;c++){var d=j[c];d.orderingByLastUseTimestampIdx-1!=c&&console.error("algorithm incorrect: downshiftedEntry.orderingByLastUseTimestampIdx: "+d.orderingByLastUseTimestampIdx+", i: "+c),d.orderingByLastUseTimestampIdx=c}}}function h(b){g(b);var c=a.sortedIndex(j,b,"lastUseTimestamp");j.splice(c,0,b),b.orderingByLastUseTimestampIdx=c}var i={},j=[],k=0,l=1e8,m=f();this.getResourceURL=function(a){var b=null,c=i[a];return c&&(b=c.url,c.lastUseTimestamp=d(),h(c)),b},this.putResource=function(a,b,c){this.trimCache();var e=d(),f={url:b,absoluteHref:a,blob:c,blobSize:c.size,creationTimestamp:e,lastUseTimestamp:e,pinned:!0};i[a]=f,h(f),k+=c.size},this.evictResource=function(a){var c=i[a];c&&(b.URL.revokeObjectURL(c.url),k-=c.blobSize,g(c),delete i[a])},this.flushCache=function(){for(var a in i)this.evictResource(a);0!=k&&(console.error("cacheSize accounting error! cacheSize: "+k+", _resourcesHash:"),console.error(i)),j=[]},this.unPinResources=function(){for(var a in i){var b=i[a];b.pinned=!1}},this.trimCache=function(){if(!(m>k)){console.log("Trimming cache. Current cache size: "+k);for(var a=0;a<j.length&&!(m>k);a++){var b=j[a];if(!b.pinned){var c=b.absoluteHref;this.evictResource(c),a--}}console.log("Cache size after trimming: "+k)}}};return b}),define("epub-fetch/encryption_handler",["require","module"],function(a,b){var c=function(a){function b(a,b){var c=new FileReader;c.onload=function(){var a=this.result;b(new Uint8Array(a))},c.readAsArrayBuffer(a)}function c(a,c,d,e){var f=a.slice(0,c);b(f,function(b){for(var f=d.length,g=0;c>g;g++)b[g]=b[g]^d[g%f];var h=new Blob([b],{type:a.type}),i=a.slice(c),j=new Blob([h,i],{type:a.type});e(j)})}function d(b,d){var e=1040;c(b,e,a.uidHash,d)}function e(a){var b=/(urn:uuid:)?([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/i,c=b.exec(a),d=c[2]+c[3]+c[4]+c[5]+c[6];d&&32==d.length||console.error("Bad UUID format for ID :"+a);for(var e=[],f=0;16>f;f++){var g=d.substr(2*f,2),h=parseInt(g,16);e.push(h)}return e}function f(b,d){var f=e(a.uid),g=1024;c(b,g,f,d)}var g=this,h={"http://www.idpf.org/2008/embedding":d,"http://ns.adobe.com/pdf/enc#RC":f};this.isEncryptionSpecified=function(){return a&&a.encryptions},this.getEncryptionMethodForRelativePath=function(b){return g.isEncryptionSpecified()?a.encryptions[b]:void 0},this.getDecryptionFunctionForRelativePath=function(a){var b=g.getEncryptionMethodForRelativePath(a);return b&&h[b]?h[b]:void 0}};return c.CreateEncryptionData=function(a,b){var c={uid:a,uidHash:window.Crypto.SHA1(unescape(encodeURIComponent(a.trim())),{asBytes:!0}),encryptions:void 0},d=$("EncryptedData",b);return d.each(function(a,b){var d=$("EncryptionMethod",b).first().attr("Algorithm"),e=$("CipherReference",b);e.each(function(a,b){var e=$(b).attr("URI");console.log("Encryption/obfuscation algorithm "+d+" specified for "+e),c.encryptions||(c.encryptions={}),c.encryptions[e]=d})}),c},c}),define("epub-fetch/publication_fetcher",["require","module","jquery","URIjs","./markup_parser","./plain_resource_fetcher","./zip_resource_fetcher","./content_document_fetcher","./resource_cache","./encryption_handler"],function(a,b,c,d,e,f,g,h,i,j){var k=function(a,b,k,l,m){function n(a){a&&(a.message&&console.error(a.message),a.stack&&console.error(a.stack)),console.error(a)}function o(){var b=".epub";return-1===a.indexOf(b,a.length-b.length)}function p(c,d){return c?(console.log("using new PlainResourceFetcher"),s=new f(q,a),void s.initialize(function(){d(s)})):(console.log("using new ZipResourceFetcher"),s=new g(q,a,b),d(s),void 0)}var q=this;q.contentTypePackageReadStrategyMap={"application/oebps-package+xml":"exploded","application/epub+zip":"zipped","application/zip":"zipped"};var r,s,t,u,v,w,x=new i(k,l),y=m;this.markupParser=new e,this.initialize=function(a){var b=o();r=!b,p(b,a)},this.shouldConstructDomProgrammatically=function(){return r},this.shouldFetchMediaAssetsProgrammatically=function(){return r&&!o()},this.getBookRoot=function(){return a},this.getJsLibRoot=function(){return b},this.flushCache=function(){x.flushCache()},this.getPackageUrl=function(){return s.getPackageUrl()},this.fetchContentDocument=function(a,b,c,d){x.unPinResources();var e=new h(q,a.spineItem,b,x,y);e.fetchContentDocumentAndResolveDom(c,function(a){n(a),d(a)})},this.getFileContentsFromPackage=function(a,b,c){s.fetchFileContentsText(a,function(a){b(a)},c)},this.getXmlFileDom=function(a,b,c){q.getFileContentsFromPackage(a,function(a){var c=q.markupParser.parseXml(a);b(c)},c)},this.getPackageFullPath=function(a,b){q.getXmlFileDom("META-INF/container.xml",function(b){var c=q.getRootFile(b);a(c)},b)},this.getRootFile=function(a){var b=c("rootfile",a),d=b.attr("full-path");return d},this.getPackageDom=function(a,b){v?a(v):w?w.done(a):(w=c.Deferred(),w.done(a),q.getPackageFullPath(function(a){u=a,q.getXmlFileDom(a,function(a){v=a,w.resolve(a),w=void 0})},b))},this.convertPathRelativeToPackageToRelativeToBase=function(a){return new d(a).absoluteTo(u).toString()},this.relativeToPackageFetchFileContents=function(a,b,c,d){d||(d=n);var e=decodeURIComponent(q.convertPathRelativeToPackageToRelativeToBase(a));"/"===e.charAt(0)&&(e=e.substr(1));var f=s.fetchFileContentsText;"blob"===b?f=s.fetchFileContentsBlob:"data64uri"===b&&(f=s.fetchFileContentsData64Uri),f.call(s,e,c,d)},this.getRelativeXmlFileDom=function(a,b,c){q.getXmlFileDom(q.convertPathRelativeToPackageToRelativeToBase(a),b,c)},this.setPackageMetadata=function(a,b){q.getXmlFileDom("META-INF/encryption.xml",function(c){var d=j.CreateEncryptionData(a.id,c);t=new j(d),t.isEncryptionSpecified()&&(r=!0),b()},function(a){console.log("Document doesn't make use of encryption."),t=new j(void 0),b()})},this.getDecryptionFunctionForRelativePath=function(a){
return t.getDecryptionFunctionForRelativePath(a)}};return k}),define("epub-fetch",["epub-fetch/publication_fetcher"],function(a){return a}),define("epub-model/package_document",["require","module","jquery","underscore","backbone","URIjs"],function(a,b,c,d,e,f){var g=function(a,b,d,e,g){function h(){var a=k(),b=a.href,c=b.substr(b.lastIndexOf(".")+1);return"ncx"===c.trim().toLowerCase()}function i(a){var b=c("<ol></ol>");return c.each(a.children("navPoint"),function(a,d){j(c(d),b)}),b}function j(a,b){var d=a.children("navLabel").text().trim(),e=a.children("content").attr("src"),f=c('<li class="nav-elem"></li>').append(c("<a></a>",{href:e,text:d}));if(b.append(f),a.children("navPoint").length>0){var g=c("<li></li>"),h=c("<ol></ol>");c.each(a.children("navPoint"),function(a,b){h.append(j(c(b),h))}),g.append(h),b.append(g)}}function k(){var a=g.getNavItem();if(a)return a;var b=d.ncx;return b&&b.length>0?g.getManifestItemByIdref(b):null}var l;this.manifest=g,this.getSharedJsPackageData=function(){var b=a.substr(0,a.lastIndexOf("/"));return{rootUrl:b,rendition_viewport:d.rendition_viewport,rendition_layout:d.rendition_layout,rendition_orientation:d.rendition_orientation,rendition_flow:d.rendition_flow,rendition_spread:d.rendition_spread,media_overlay:d.media_overlay,spine:{direction:this.getPageProgressionDirection(),items:e}}},this.getSpineItem=function(a){var b=e[a];return b},this.setPageProgressionDirection=function(a){l=a},this.getPageProgressionDirection=function(){return"rtl"===l?"rtl":"default"===l?"default":"ltr"},this.spineLength=function(){return e.length},this.getMetadata=function(){return d},this.getToc=function(){var a=k();return a?a.href:null},this.getTocText=function(a){var c=this.getToc();b.relativeToPackageFetchFileContents(c,"text",function(b){a(b)},function(b){console.error("ERROR fetching TOC from ["+c+"]:"),console.error(b),a(void 0)})},this.getTocDom=function(a){this.getTocText(function(b){if("string"==typeof b){var c=(new DOMParser).parseFromString(b,"text/xml");a(c)}else a(void 0)})},this.generateTocListDOM=function(b){var d=this;this.getTocDom(function(e){if(e)if(h()){var g;g=i(c("navMap",e)),b(g[0])}else{var j=new f(a).absoluteTo(document.URL),k=new f(d.getToc()).absoluteTo(j),l=(c(e).remove("base"),c("<base></base>"));c(l).attr("href",k),c(e).find("head").append(l),b(e)}else b(void 0)})}};return g}),define("epub-model/smil_document_parser",["require","module","jquery","underscore"],function(a,b,c,d){var e=function(a,b){function d(a){return{id:"",href:"",spineItemId:a.idref,children:[{nodeType:"seq",textref:a.href,children:[{nodeType:"par",children:[{nodeType:"text",src:a.href,srcFile:a.href,srcFragmentId:""}]}]}]}}this.parse=function(d,e,f,g,h,i){var j=this;b.getRelativeXmlFileDom(e.href,function(b){var i=c("smil",b)[0];f.smilVersion=i.getAttribute("version"),f.children=j.getChildren(i),f.href=e.href,f.id=e.id,f.spineItemId=d.idref;var k=a.getMetadata().getMediaItemByRefinesId(e.id);k&&(f.duration=k.duration),h(g,f)},function(a){i(g,a)})};var f=function(a,b,c,d,e){var f=a.split(":"),g=f[f.length-1];"type"===g&&(g="epubtype"),void 0!=b.getAttribute(a)?c[g]=b.getAttribute(a):d&&(void 0!==e?c[g]=e:console.log("Required property "+a+" not found in smil node "+b.nodeName))};this.getChildren=function(a){var b=this,d=[];return c.each(a.childNodes,function(a,c){if(1===c.nodeType){var e=b.createItemFromElement(c);e&&d.push(e)}}),d},this.createItemFromElement=function(a){var b=this,c={};c.nodeType=a.nodeName;var d=!1;if("body"===c.nodeType&&(d=!0,c.nodeType="seq"),"seq"===c.nodeType)f("epub:textref",a,c,!d),f("id",a,c),f("epub:type",a,c),c.children=b.getChildren(a);else if("par"===c.nodeType)f("id",a,c),f("epub:type",a,c),c.children=b.getChildren(a);else if("text"===c.nodeType){f("src",a,c,!0);var g=c.src.split("#");c.srcFile=g[0],c.srcFragmentId=2===g.length?g[1]:"",f("id",a,c)}else{if("audio"!==c.nodeType)return void 0;f("src",a,c,!0),f("id",a,c),c.clipBegin=e.resolveClockValue(a.getAttribute("clipBegin")),c.clipEnd=e.resolveClockValue(a.getAttribute("clipEnd"))}return c},this.fillSmilData=function(b){var e=this;if(a.spineLength()<=0)return void b();for(var f=!0,g=[],h=[],i=0;i<a.spineLength();i++){var j=a.getSpineItem(i);if(j.media_overlay_id){var k=a.manifest.getManifestItemByIdref(j.media_overlay_id);if(!k){console.error("Cannot find SMIL manifest item for spine/manifest item?! "+j.media_overlay_id);continue}var l=c.Deferred();l.media_overlay_id=j.media_overlay_id,h.push(l);var m={};g.push(m),e.parse(j,k,m,l,function(a,b){f=!1,a.resolve()},function(a,b){console.log("Error when parsing SMIL manifest item "+k.href+":"),console.log(b),a.resolve()})}else g.push(d(j))}c.when.apply(c,h).done(function(){a.getMetadata().setMoMap(g),f&&(console.log("No Media Overlays"),a.getMetadata().setMoMap([])),b()})}};return e.resolveClockValue=function(a){if(!a)return 0;var b=0,c=0,d=0;if(-1!=a.indexOf("min"))c=parseFloat(a.substr(0,a.indexOf("min")));else if(-1!=a.indexOf("ms")){var e=parseFloat(a.substr(0,a.indexOf("ms")));d=e/1e3}else if(-1!=a.indexOf("s"))d=parseFloat(a.substr(0,a.indexOf("s")));else if(-1!=a.indexOf("h"))b=parseFloat(a.substr(0,a.indexOf("h")));else{var f=a.split(":");d=parseFloat(f.pop()),f.length>0&&(c=parseFloat(f.pop()),f.length>0&&(b=parseFloat(f.pop())))}var g=3600*b+60*c+d;return g},e}),define("epub-model/metadata",["require","module","underscore"],function(a,b,c){var d=function(){var a=this,b={};this.eachMediaItem=function(b){return a.mediaItems&&c.each(a.mediaItems,b),this},this.getMediaItemByRefinesId=function(a){return b[a]},this.setMoMap=function(b){a.media_overlay.smil_models=b},this.eachMediaItem(function(a){var c=a.refines,d=c.indexOf("#");if(d>=0){var e=d+1,f=c.length-1;c=c.substr(e,f)}c=c.trim(),b[c]=a})};return d}),define("epub-model/manifest",["require","module","underscore"],function(a,b,c){var d=function(a){var b,d={};this.manifestLength=function(){return a.length},this.getManifestItemByIdref=function(a){return d[a]},this.each=function(b){return c.each(a,b),this},this.getNavItem=function(){return b},this.each(function(a){d[a.id]=a,a.properties&&-1!==a.properties.indexOf("nav")&&(b=a)})};return d}),define("epub-model/package_document_parser",["require","module","jquery","underscore","backbone","epub-fetch/markup_parser","URIjs","./package_document","./smil_document_parser","./metadata","./manifest"],function(a,b,c,d,e,f,g,h,i,j,k){var l=function(a,b){function e(a){a&&(a.message&&console.error(a.message),a.stack&&console.error(a.stack))}function g(a,c){var d=new i(a,b);d.fillSmilData(function(){c(a)})}function l(a){var d=c.Deferred();if(a.rendition_layout)d.resolve();else{var e="/META-INF/com.apple.ibooks.display-options.xml";b.relativeToPackageFetchFileContents(e,"text",function(b){if(b){var e=new f,g=e.parseXml(b),h=c("option[name=fixed-layout]",g)[0];if(h){var i=c(h).text();"true"===i&&(a.rendition_layout="pre-paginated",console.log("using com.apple.ibooks.display-options.xml fixed-layout property"))}}d.resolve()},function(a){console.log("com.apple.ibooks.display-options.xml not found"),d.resolve()})}return d.promise()}function m(a,b,e){var f,g=[];return f=c(n(a,"spine")).children(),c.each(f,function(a,f){var h=c(f),i=h.attr("idref")?h.attr("idref"):"",j=b.getManifestItemByIdref(i),k=h.attr("id"),l=void 0;d.each(e.rendition_viewports,function(a){return a.refines==k?(l=a.viewport,!0):void 0});var m={rendition_viewport:l,idref:i,href:j.href,manifest_id:j.id,media_type:j.media_type,media_overlay_id:j.media_overlay_id,linear:h.attr("linear")?h.attr("linear"):"",properties:h.attr("properties")?h.attr("properties"):""},n=w(m.properties);d.extend(m,n),g.push(m)}),g}function n(a,b,c){var e=a.getElementsByTagNameNS("*",b);return c?d.find(e,c):e[0]}function o(a,b,c){var e=a.getElementsByTagNameNS("*",b);return d.filter(e,c)}function p(a,b,c){var d=n(a,b,c);return d?d.textContent:""}function q(a,b,c,d){var e=n(a,b,d);return e?e.getAttribute(c):""}function r(a,b){var c=n(a,"meta",function(a){return a.getAttribute("property")===b});return c?c.textContent:""}function s(a){var b=new j,c=n(a,"metadata"),e=n(a,"package"),f=n(a,"spine");b.author=p(c,"creator"),b.description=p(c,"description"),b.epub_version=e.getAttribute("version")?e.getAttribute("version"):"",b.id=p(c,"identifier"),b.language=p(c,"language"),b.modified_date=r(c,"dcterms:modified"),b.ncx=f.getAttribute("toc")?f.getAttribute("toc"):"",b.pubdate=p(c,"date"),b.publisher=p(c,"publisher"),b.rights=p(c,"rights"),b.title=p(c,"title"),b.rendition_orientation=r(c,"rendition:orientation"),b.rendition_layout=r(c,"rendition:layout"),b.rendition_spread=r(c,"rendition:spread"),b.rendition_flow=r(c,"rendition:flow"),b.rendition_viewport=p(c,"meta",function(a){return"rendition:viewport"===a.getAttribute("property")&&!a.hasAttribute("refines")});var g=[],h=o(c,"meta",function(a){return"rendition:viewport"===a.getAttribute("property")&&a.hasAttribute("refines")});d.each(h,function(a){var b=a.getAttribute("refines");if(b){var c=b.indexOf("#");if(c>=0){var d=c+1,e=b.length-1;b=b.substr(d,e)}b=b.trim()}var f={refines:b,viewport:a.textContent};g.push(f)}),b.rendition_viewports=g,b.mediaItems=[];var k=o(c,"meta",function(a){return"media:duration"===a.getAttribute("property")&&a.hasAttribute("refines")});return d.each(k,function(a){b.mediaItems.push({refines:a.getAttribute("refines"),duration:i.resolveClockValue(a.textContent)})}),b.media_overlay={duration:i.resolveClockValue(p(c,"meta",function(a){return"media:duration"===a.getAttribute("property")&&!a.hasAttribute("refines")})),narrator:r(c,"media:narrator"),activeClass:r(c,"media:active-class"),playbackActiveClass:r(c,"media:playback-active-class"),smil_models:[],skippables:["sidebar","practice","marginalia","annotation","help","note","footnote","rearnote","table","table-row","table-cell","list","list-item","pagebreak"],escapables:["sidebar","bibliography","toc","loi","appendix","landmarks","lot","index","colophon","epigraph","conclusion","afterword","warning","epilogue","foreword","introduction","prologue","preface","preamble","notice","errata","copyright-page","acknowledgments","other-credits","titlepage","imprimatur","contributors","halftitlepage","dedication","help","annotation","marginalia","practice","note","footnote","rearnote","footnotes","rearnotes","bridgehead","page-list","table","table-row","table-cell","list","list-item","glossary"]},b}function t(a){var b=c(n(a,"manifest")).children(),d=[];return c.each(b,function(a,b){var e=c(b),f=e.attr("href")?e.attr("href"):"",g={href:f,id:e.attr("id")?e.attr("id"):"",media_overlay_id:e.attr("media-overlay")?e.attr("media-overlay"):"",media_type:e.attr("media-type")?e.attr("media-type"):"",properties:e.attr("properties")?e.attr("properties"):""};d.push(g)}),d}function u(a){var b=c(n(a,"bindings")).children(),d=[];return c.each(b,function(a,b){var e=c(b),f={handler:e.attr("handler")?e.attr("handler"):"",media_type:e.attr("media-type")?e.attr("media-type"):""};d.push(f)}),d}function v(a){var b,e;if(b=n(a,"manifest"),e=c(n(b,"item",function(a){var b=a.getAttribute("properties");return b&&d.contains(b.split(" "),"cover-image")})),1===e.length&&e.attr("href"))return e.attr("href");var f=c(n(a,"meta",function(a){return"cover"===a.getAttribute("name")})),g=f.attr("content");return 1===f.length&&g&&(e=c(n(b,"item",function(a){return a.getAttribute("id")===g})),1===e.length&&e.attr("href"))?e.attr("href"):(e=c(n(b,"item",function(a){return"cover"===a.getAttribute("id")})),1===e.length&&e.attr("href")?e.attr("href"):null)}function w(a){for(var b={},c=a.split(" "),d=0;d<c.length;d++)"rendition:orientation-landscape"===c[d]&&(b.rendition_orientation="landscape"),"rendition:orientation-portrait"===c[d]&&(b.rendition_orientation="portrait"),"rendition:orientation-auto"===c[d]&&(b.rendition_orientation="auto"),"rendition:spread-none"===c[d]&&(b.rendition_spread="none"),"rendition:spread-landscape"===c[d]&&(b.rendition_spread="landscape"),"rendition:spread-portrait"===c[d]&&(b.rendition_spread="portrait"),"rendition:spread-both"===c[d]&&(b.rendition_spread="both"),"rendition:spread-auto"===c[d]&&(b.rendition_spread="auto"),"rendition:flow-paginated"===c[d]&&(b.rendition_flow="paginated"),"rendition:flow-scrolled-continuous"===c[d]&&(b.rendition_flow="scrolled-continuous"),"rendition:flow-scrolled-doc"===c[d]&&(b.rendition_flow="scrolled-doc"),"rendition:flow-auto"===c[d]&&(b.rendition_flow="auto"),"rendition:page-spread-center"===c[d]&&(b.page_spread="page-spread-center"),"page-spread-left"===c[d]&&(b.page_spread="page-spread-left"),"page-spread-right"===c[d]&&(b.page_spread="page-spread-right"),"rendition:layout-reflowable"===c[d]&&(b.fixed_flow=!1,b.rendition_layout="reflowable"),"rendition:layout-pre-paginated"===c[d]&&(b.fixed_flow=!0,b.rendition_layout="pre-paginated");return b}var x,y=b,z=c.Deferred();b.getPackageDom(function(a){x=a,z.resolve(a)},e),this.parse=function(a){z.done(function(d){var e=s(d),f=(d.getElementsByTagNameNS("*","spine")[0],q(d,"spine","page-progression-direction")),i=(u(d),new k(t(d))),j=m(d,i,e),n=v(d);n&&(e.cover_href=n),c.when(l(e)).then(function(){y.setPackageMetadata(e,function(){var c=new h(b.getPackageUrl(),b,e,j,i);c.setPageProgressionDirection(f),g(c,a)})})})}};return l}),define("epub-fetch/iframe_zip_loader",["URIjs"],function(a){var b=function(b,c,d){function e(a,b){$.ajax({url:a,dataType:"html",async:!0,success:function(a){b(a)},error:function(c,d,e){console.error("Error when AJAX fetching "+a),console.error(d),console.error(e),b()}})}function f(a,b){e(a,function(c){return c?(i&&(c=i(a,c)),void b(c)):void b()})}var g=new b.Views.IFrameLoader,h=this,i=d;this.addIFrameEventListener=function(a,b,c){g.addIFrameEventListener(a,b,c)},this.updateIframeEvents=function(a){g.updateIframeEvents(a)},this.loadIframe=function(b,d,e,g,i){var j=new a(d).absoluteTo(b.baseURI).search("").hash("").toString(),k=c().shouldConstructDomProgrammatically();k?c().fetchContentDocument(i,j,function(a){h._loadIframeWithDocument(b,i,a.documentElement.outerHTML,function(){e.call(g,!0,i)})},function(a){e.call(g,!1,i)}):f(j,function(a){a?h._loadIframeWithDocument(b,i,a,function(){e.call(g,!0,i)}):e.call(g,!1,i)})},this._loadIframeWithDocument=function(a,b,c,d){var e=window.navigator.userAgent.indexOf("Trident")>0;if(e)a.contentWindow.document.open(),window.MSApp&&window.MSApp.execUnsafeLocalFunction?window.MSApp.execUnsafeLocalFunction(function(){a.contentWindow.document.write(c)}):a.contentWindow.document.write(c);else{var f="text/html";b.spineItem.media_type&&b.spineItem.media_type.length&&(f=b.spineItem.media_type);var g=window.URL.createObjectURL(new Blob([c],{type:f}))}a.onload=function(){h.updateIframeEvents(a);var b=a.contentWindow.MathJax;if(b){var c=_.once(d);b.Hub.Queue(c)}else d();e||window.URL.revokeObjectURL(g)},e?a.contentWindow.document.close():a.setAttribute("src",g)}};return b}),("undefined"==typeof Crypto||!Crypto.util)&&function(){var a=window.Crypto={},b=a.util={rotl:function(a,b){return a<<b|a>>>32-b},rotr:function(a,b){return a<<32-b|a>>>b},endian:function(a){if(a.constructor==Number)return 16711935&b.rotl(a,8)|4278255360&b.rotl(a,24);for(var c=0;c<a.length;c++)a[c]=b.endian(a[c]);return a},randomBytes:function(a){for(var b=[];a>0;a--)b.push(Math.floor(256*Math.random()));return b},bytesToWords:function(a){for(var b=[],c=0,d=0;c<a.length;c++,d+=8)b[d>>>5]|=(255&a[c])<<24-d%32;return b},wordsToBytes:function(a){for(var b=[],c=0;c<32*a.length;c+=8)b.push(a[c>>>5]>>>24-c%32&255);return b},bytesToHex:function(a){for(var b=[],c=0;c<a.length;c++)b.push((a[c]>>>4).toString(16)),b.push((15&a[c]).toString(16));return b.join("")},hexToBytes:function(a){for(var b=[],c=0;c<a.length;c+=2)b.push(parseInt(a.substr(c,2),16));return b},bytesToBase64:function(a){if("function"==typeof btoa)return btoa(c.bytesToString(a));for(var b=[],d=0;d<a.length;d+=3)for(var e=a[d]<<16|a[d+1]<<8|a[d+2],f=0;4>f;f++)8*d+6*f<=8*a.length?b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>6*(3-f)&63)):b.push("=");return b.join("")},base64ToBytes:function(a){if("function"==typeof atob)return c.stringToBytes(atob(a));for(var a=a.replace(/[^A-Z0-9+\/]/gi,""),b=[],d=0,e=0;d<a.length;e=++d%4)0!=e&&b.push(("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a.charAt(d-1))&Math.pow(2,-2*e+8)-1)<<2*e|"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a.charAt(d))>>>6-2*e);return b}},a=a.charenc={};a.UTF8={stringToBytes:function(a){return c.stringToBytes(unescape(encodeURIComponent(a)))},bytesToString:function(a){return decodeURIComponent(escape(c.bytesToString(a)))}};var c=a.Binary={stringToBytes:function(a){for(var b=[],c=0;c<a.length;c++)b.push(255&a.charCodeAt(c));return b},bytesToString:function(a){for(var b=[],c=0;c<a.length;c++)b.push(String.fromCharCode(a[c]));return b.join("")}}}(),function(){var a=Crypto,b=a.util,c=a.charenc,d=c.UTF8,e=c.Binary,f=a.SHA1=function(a,c){var d=b.wordsToBytes(f._sha1(a));return c&&c.asBytes?d:c&&c.asString?e.bytesToString(d):b.bytesToHex(d)};f._sha1=function(a){a.constructor==String&&(a=d.stringToBytes(a));var c=b.bytesToWords(a),e=8*a.length,a=[],f=1732584193,g=-271733879,h=-1732584194,i=271733878,j=-1009589776;for(c[e>>5]|=128<<24-e%32,c[(e+64>>>9<<4)+15]=e,e=0;e<c.length;e+=16){for(var k=f,l=g,m=h,n=i,o=j,p=0;80>p;p++){if(16>p)a[p]=c[e+p];else{var q=a[p-3]^a[p-8]^a[p-14]^a[p-16];a[p]=q<<1|q>>>31}q=(f<<5|f>>>27)+j+(a[p]>>>0)+(20>p?(g&h|~g&i)+1518500249:40>p?(g^h^i)+1859775393:60>p?(g&h|g&i|h&i)-1894007588:(g^h^i)-899497514),j=i,i=h,h=g<<30|g>>>2,g=f,f=q}f+=k,g+=l,h+=m,i+=n,j+=o}return[f,g,h,i,j]},f._blocksize=16,f._digestsize=20}(),define("cryptoJs",function(){}),define("Readium",["require","text!version.json","console_shim","jquery","underscore","readerView","epub-fetch","epub-model/package_document_parser","epub-fetch/iframe_zip_loader","URIjs","cryptoJs"],function(a,b,c,d,e,f,g,h,i,j,k){if(window.URI=j,"URL"in window==!1){if("webkitURL"in window==!1)throw Error("Browser does not support window.URL");window.URL=window.webkitURL}var l=function(a,b){var c,e={mathJaxUrl:b.mathJaxUrl},f=function(a,b){function c(){navigator.epubReadingSystem=window.parent.navigator.epubReadingSystem,window.parent=window.self,window.top=window.self}var d=a.split("/");d.pop();var f='<base href="'+d.join("/")+'/"/>',g='<script type="text/javascript">('+c.toString()+")()</script>";return e&&e.mathJaxUrl&&b.indexOf("<math")>=0&&(g+='<script type="text/javascript" src="'+e.mathJaxUrl+'"></script>'),b.replace(/(<head.*?>)/,"$1"+f+g)},j=this,k=a.jsLibRoot;a.useSimpleLoader?b.iframeLoader=new ReadiumSDK.Views.IFrameLoader:b.iframeLoader=new i(ReadiumSDK,function(){return c},f),b.needsFixedLayoutScalerWorkAround=!1,this.reader=new ReadiumSDK.Views.ReaderView(b),this.openPackageDocument=function(b,e,i){c&&c.flushCache();var l=null;a.cacheSizeEvictThreshold&&(l=a.cacheSizeEvictThreshold),c=new g(b,k,window,l,f),c.initialize(function(){var f=new h(b,c);f.parse(function(b){var f=a.openBookOptions||{},g=d.extend(b.getSharedJsPackageData(),f);i&&(g.openPageRequest=i),j.reader.openBook(g);var h={packageDocumentUrl:c.getPackageUrl(),metadata:b.getMetadata()};e&&e(b,h)})})},this.closePackageDocument=function(){c&&c.flushCache()},ReadiumSDK.reader=this.reader,ReadiumSDK.trigger(ReadiumSDK.Events.READER_INITIALIZED,this.reader)};return l.version=JSON.parse(b),l}),Handlebars.registerHelper("ifEq",function(a,b,c){return a==b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("ifNotEq",function(a,b,c){return a!=b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("ifContains",function(a,b,c){return a&&-1!==a.indexOf(b)?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("ifEmpty",function(a,b){return a&&a.length?b.inverse(this):b.fn(this)}),Handlebars.registerHelper("render_handlebars",function(a,b){var c=Handlebars.compile(jQuery("#"+a).html()),d=jQuery.extend({},this,b.hash);return new Handlebars.SafeString(c(d))}),Handlebars.registerHelper("breaklines",function(a){return a=Handlebars.Utils.escapeExpression(a),a=a.replace(/(\r\n|\n|\r)/gm,"<br>"),new Handlebars.SafeString(a)}),window.LookUp={views:{},models:{},ReadiumUtils:{}},LookUp.BrowserUtils={doesSupportFullScreen:function(){var a=document.documentElement.requestFullscreen||document.documentElement.msRequestFullscreen||document.documentElement.mozRequestFullScreen||document.documentElement.webkitRequestFullscreen;return function(){return a}}(),enterFullScreen:function(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)},exitFullScreen:function(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}},require(["Readium","GesturesHandler","EpubReaderMediaOverlays","Keyboard"],function(a,b,c,d){LookUp.ReadiumUtils.createInstance=function(e){var f={el:e.el,mathJaxUrl:"scripts/mathjax/MathJax.js"},g={jsLibRoot:module.config().jsLibRoot||"./scripts/zip/",openBookOptions:{}},h=new a(g,f),i=new b(h.reader,f.el);return i.initialize(),h.reader.addIFrameEventListener("keydown",function(a){d.dispatch(document.documentElement,a.originalEvent)}),h.reader.addIFrameEventListener("keyup",function(a){d.dispatch(document.documentElement,a.originalEvent)}),h.reader.updateSettings({syntheticSpread:"auto",scroll:"auto"}),h.reader.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,function(){console.log("### CONTENT_DOCUMENT_LOAD_START")}),c.init(h),h.openPackageDocument(e.url,function(a,b){console.log("### packageDocument: %o",a),a.generateTocListDOM(function(a){console.log("### generateTocListDOM - dom: %o",a)});var c=b.metadata;console.log("### options: %o, metadata: %o",b,c)}),h}}),LookUp.models.AppState=Backbone.Model.extend({defaults:{readium:null,toolbarsVisible:!0,fullscreen:!1,wordsMode:!1,zoom:16,customBookData:null},initialize:function(){this.ZOOM_MIN=4,this.ZOOM_MAX=72,this.ZOOM_DEFAULT=16},zoomIn:function(){var a=this.get("zoom");return a<this.ZOOM_MAX?(this.set("zoom",a+1),!0):!1},zoomOut:function(){var a=this.get("zoom");return a>this.ZOOM_MIN?(this.set("zoom",a-1),!0):!1},resetZoom:function(){this.set("zoom",this.ZOOM_DEFAULT)}}),LookUp.views.DocView=Backbone.View.extend({initialize:function(a){this.appState=a.appState,this.listenTo(this.appState,"change:book",this.onBookChange),this.listenTo(this.appState,"change:toolbarsVisible",this.onToolbarsVisibleChange),this.listenTo(this.appState,"change:zoom",this.onZoomChange)},onBookChange:function(a,b){b.loaded.metadata.then(function(){$("#loader").hide()});var c=b.renderTo("book");c.display(1)},onToolbarsVisibleChange:function(a,b){this.$el.toggleClass("tb",!!b)},onZoomChange:function(){}}),LookUp.views.DocHeaderView=Backbone.View.extend({events:{"change .loadEpub":"onFileSelect","click .books .circle":"onBooksIconClick"},templateBooksList:Handlebars.compile($("#templateBooksList").html()),initialize:function(a){this.appState=a.appState,this.$el.find(".books .fe > div").html(this.templateBooksList()),this.listenTo(this.appState,"change:book",this.onBookChange)},onBookChange:function(a,b){b.loaded.metadata.then(function(a){console.log("meta: %o",a),this.$el.find(".headerContainer h1").html(a.title+"<span>"+a.creator+"</span>")}.bind(this))},onBooksIconClick:function(a){a.preventDefault(),$(a.currentTarget).closest(".books").toggleClass("active")},onFileSelect:function(a){var b=a.target.files[0];if(window.FileReader){var c=new FileReader;c.onload=function(a){this.appState.set("customBookData",{name:b.name,data:a.target.result})}.bind(this),c.readAsArrayBuffer(b)}}}),LookUp.views.DocTOCView=Backbone.View.extend({appState:null,events:{"click .circle":"onTocIconClick","click li > div":"onItemIconClick","click li > p":"onItemClick"},templateTOCItemList:Handlebars.compile($("#templateTOCItemList").html()),templateTOCItemContent:Handlebars.compile($("#templateTOCItemContent").html()),initialize:function(a){this.appState=a.appState,this.$tocContent=this.$el.find(".content"),this.listenTo(this.appState,"change:book",function(a,b){b.loaded.navigation.then(function(a){console.log("toc: %o",a),this.renderTOC(a)}.bind(this))}),$(document).on("CustomResize",this.adjustPopoverSize.bind(this)),this.adjustPopoverSize()},adjustPopoverSize:function(){var a=$(window).height()-140,b=.37*$(window).width();this.$el.find(".fe > div").css({width:b+"px",height:a+"px"})},onTocIconClick:function(a){a.preventDefault(),$(a.currentTarget).closest(".toc").toggleClass("active")},renderTOC:function(a){this.$tocContent.html(this.templateTOCItemList({items:this.renderTOCItems(a,0),level:0}))},renderTOCItems:function(a,b){return a.map(function(a){var c=this.templateTOCItemContent($.extend(a)),d=!a.subitems||0===a.subitems.length;return d||(c+=this.templateTOCItemList({items:this.renderTOCItems(a.subitems,b+1),level:b+1})),{html:c,leaf:d}}.bind(this))},onItemIconClick:function(a){var b=$(a.target).closest("li");b.toggleClass("act"),b.children("ul").toggle()},onItemClick:function(a){this.appState.get("book").gotoHref($(a.target).attr("data-dst"))}}),LookUp.views.DocFooterView=Backbone.View.extend({events:{"change input.currentPage":"onCurrentPageUserChange","keydown input.currentPage":"onCurrentPageUserKeyChange","mousedown .circle":"dragStart"},templateFooterView:Handlebars.compile($("#templateFooterView").html()),initialize:function(a){this.appState=a.appState,this.$el.html(this.templateFooterView()),this.$spread=this.$el.find(".spread"),this.$spread2=this.$el.find(".spread2"),this.$currentPageInput=this.$el.find("input.currentPage"),this.$totalPages=this.$el.find(".totalPages"),this.drag=null,this.$draggableItem=this.$el.find(".progress_scroll .circle"),this.dragEndBinded=this.dragEnd.bind(this),this.doDragBinded=this.doDrag.bind(this),this.listenTo(this.appState,"change:book",function(a,b){b.rendition.on("renderer:locationChanged",function(){console.log("renderer:locationChanged args: %o",arguments),setTimeout(this.onPageChange.bind(this),200)}.bind(this))})},getPagesTotal:function(){return this.appState.get("book").spine.length},setPageNum:function(a){this.appState.get("book").displayChapter(a-1)},getPageNum:function(){return this.appState.get("book").spinePos+1},onPageChange:function(){var a=this.getPageNum();this.$spread.html(a),this.$spread2.hide(),this.$spread.show();var b=this.getPagesTotal();this.$draggableItem.css("left","calc("+(a-1)/(b-1)*100+"%)"),this.$currentPageInput.val(a),this.$totalPages.html(this.getPagesTotal())},onCurrentPageUserChange:function(a){var b=$(a.target).val();!isNaN(b)&&b>0&&b<=this.getPagesTotal()?this.setPageNum(b):$(this).val(this.getPageNum())},onCurrentPageUserKeyChange:function(a){if(13===(a.keyCode||a.which)){var b=$(a.target).val();!isNaN(b)&&b>0&&b<=this.getPagesTotal()?this.setPageNum(b):$(this).val(this.getPageNum())}},dragStart:function(a){this.appState.get("book")&&(this.drag={mouseStartX:a.clientX,total:this.$el.find(".line").width()-26,elementStartPos:this.$draggableItem.position().left},this.updateDrag(this.drag.elementStartPos/this.drag.total*100),$(document).bind("mouseup",this.dragEndBinded),$(document).bind("mousemove",this.doDragBinded))},dragEnd:function(){this.drag&&(this.drag.pageNum&&this.setPageNum(this.drag.pageNum),this.drag=null,$(document).unbind("mouseup",this.dragEndBinded),$(document).unbind("mousemove",this.doDragBinded))},doDrag:function(a){this.drag&&(this.updateDrag((this.drag.elementStartPos+a.clientX-this.drag.mouseStartX)/this.drag.total*100),a.stopImmediatePropagation(),a.preventDefault())},updateDrag:function(a){if(a>=0&&100>=a){var b=Math.round((this.getPagesTotal()-1)*a/100)+1;this.$draggableItem.css("left",a+"%"),b!==this.drag.pageNum&&(this.drag.pageNum=b)}}}),LookUp.views.DocPageNavigationView=Backbone.View.extend({appState:null,events:{"click .page_navigation.prev":"onPrevPageClick","click .page_navigation.next":"onNextPageClick"},initialize:function(a){this.appState=a.appState,$(document).keydown(function(a){if(!$(a.target).closest(".fe").length&&!/^(INPUT|TEXTAREA|BUTTON|SELECT)$/.test(a.target.tagName))switch(a.which||a.keyCode){case 37:case 38:a.preventDefault(),this.gotoPrevPage();break;case 40:case 39:a.preventDefault(),this.gotoNextPage()}}.bind(this))},onPrevPageClick:function(a){a.stopImmediatePropagation(),a.preventDefault(),this.gotoPrevPage()},onNextPageClick:function(a){a.stopImmediatePropagation(),a.preventDefault(),this.gotoNextPage()},gotoPrevPage:function(){var a=this.appState.get("readium");a&&a.reader.openPageLeft()},gotoNextPage:function(){var a=this.appState.get("readium");a&&a.reader.openPageRight()}}),LookUp.views.DocToolsView=Backbone.View.extend({appState:null,events:{"click .toolsSlider":"togglePanel","click a.tool_tb":"onToolbarsSwitchClick","click a.tool_zoom_in":"onZoomInClick","click a.tool_zoom_out":"onZoomOutClick","click a.tool_marker":"onSelectTextIconClick","click a.tool_drag_page":"onDragIconClick","click a.tool_fullscreen":"onFullscreenIconClick","click a.tool_expand":"onFitIconClick"},initialize:function(a){this.appState=a.appState,LookUp.BrowserUtils.doesSupportFullScreen()||this.$el.find("li.tool_fullscreen").addClass("disabled"),this.listenTo(this.appState,"change:toolbarsVisible",this.onToolbarsVisibleChange),this.listenTo(this.appState,"change:fullscreen",this.onFullscreenChange),this.listenTo(this.appState,"change:wordsMode",this.onWordsModeChange),this.listenTo(this.appState,"change:zoom",this.onZoomChange),document.addEventListener("fullscreenchange",this.onFullscreenBrowserChange.bind(this),!1),document.addEventListener("mozfullscreenchange",this.onFullscreenBrowserChange.bind(this),!1),document.addEventListener("webkitfullscreenchange",this.onFullscreenBrowserChange.bind(this),!1),document.addEventListener("msfullscreenchange",this.onFullscreenBrowserChange.bind(this),!1)},togglePanel:function(){this.$el.toggleClass("in").toggleClass("out")},onToolbarsSwitchClick:function(a){a.preventDefault(),this.appState.set("toolbarsVisible",!this.appState.get("toolbarsVisible"))},onSelectTextIconClick:function(a){a.preventDefault(),this.appState.set("wordsMode",!0)},onDragIconClick:function(a){a.preventDefault(),this.appState.set("wordsMode",!1)},onFullscreenIconClick:function(a){a.preventDefault(),$(a.currentTarget).closest("li").hasClass("disabled")||(this.appState.get("fullscreen")?LookUp.BrowserUtils.exitFullScreen():LookUp.BrowserUtils.enterFullScreen())},onToolbarsVisibleChange:function(a,b){var c=this.$el.find("li:has(a.tool_tb)");c.toggleClass("invert",!b);var d=c.find("a.tool_tb");d.attr("title",d.data("title-"+b))},onFullscreenChange:function(a,b){var c=this.$el.find("li:has(a.tool_fullscreen)");c.toggleClass("invert",b);var d=c.find("a.tool_fullscreen");d.attr("title",d.data("title-"+b))},onFullscreenBrowserChange:function(){this.appState.set("fullscreen",!this.appState.get("fullscreen"))},onWordsModeChange:function(a,b){var c=b?this.$el.find("li:has(a.tool_marker)"):this.$el.find("li:has(a.tool_drag_page)");c.siblings("li").removeClass("active"),c.addClass("active")},onZoomInClick:function(a){a.preventDefault(),this.appState.zoomIn()},onZoomOutClick:function(a){a.preventDefault(),this.appState.zoomOut()},onZoomChange:function(a,b){this.$el.find("li.tool_zoom_out").toggleClass("disabled",Math.abs(b-a.ZOOM_MAX)<.5),this.$el.find("li.tool_zoom_in").toggleClass("disabled",Math.abs(b-a.ZOOM_MIN)<.5)},onFitIconClick:function(a){a.preventDefault(),this.appState.resetZoom()}}),LookUp.Router=Backbone.Router.extend({routes:{"custom/:bookName":"routeCustomBook","book/:bookName":"routeBook","*path":"defaultRoute"},initialize:function(){this.appState=new LookUp.models.AppState;
var a=$("#docView");new LookUp.views.DocView({appState:this.appState,el:a}),new LookUp.views.DocPageNavigationView({el:a.find(".pageNavigationContainer"),appState:this.appState}),new LookUp.views.DocTOCView({el:a.find(".toc"),appState:this.appState}),new LookUp.views.DocToolsView({el:a.find(".tools"),appState:this.appState}),new LookUp.views.DocFooterView({el:$(".pagesSliderContainer"),appState:this.appState}),new LookUp.views.DocHeaderView({el:a.find(".header"),appState:this.appState}),this.appState.on("change:customBookData",function(a,b){b&&this.navigate("custom/"+b.name,{trigger:!0,replace:!0})}.bind(this))},routeCustomBook:function(){var a=this.appState.get("readium");a&&a.closePackageDocument();var b=this.appState.get("customBookData");b?this.appState.set("readium",LookUp.ReadiumUtils.createInstance({el:"#epubContainer",url:b})):this.defaultRoute()},routeBook:function(a){var b=this.appState.get("readium");b&&b.closePackageDocument(),a=/\.epub$/.test(a)?a:a+"/",this.appState.set("readium",LookUp.ReadiumUtils.createInstance({el:"#epubContainer",url:"../books/"+a}))},defaultRoute:function(){this.navigate("book/William_Shakespeare_Venus_and_Adonis",{trigger:!0,replace:!0})}});